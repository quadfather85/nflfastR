<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>A beginner's guide to nflfastR • nflfastR</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/yeti/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><!-- docsearch --><script src="../docsearch.js"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/docsearch.js/2.6.3/docsearch.min.css" integrity="sha256-QOSRU/ra9ActyXkIBbiIB144aDBdtvXBcNc3OTNuX/Q=" crossorigin="anonymous">
<link href="../docsearch.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/jquery.mark.min.js" integrity="sha256-4HLtjeVgH0eIB3aZ9mLYF6E8oU5chNdjU6p6rrXpl9U=" crossorigin="anonymous"></script><meta property="og:title" content="A beginner's guide to nflfastR">
<meta property="og:description" content="nflfastR">
<meta property="og:image" content="https://raw.githubusercontent.com/mrcaseb/nflfastR/master/man/figures/card.png">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:creator" content="@nflfastR">
<meta name="twitter:site" content="@nflfastR">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=G-8FNRBBEHML"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-8FNRBBEHML');
</script>
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">nflfastR</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">3.2.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/nflfastR.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Functions</a>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/beginners_guide.html">A beginner’s guide to nflfastR</a>
    </li>
    <li>
      <a href="https://www.opensourcefootball.com/posts/2020-09-28-nflfastr-ep-wp-and-cp-models/">nflfastR models</a>
    </li>
    <li>
      <a href="https://www.opensourcefootball.com/">Open Source Football</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/guga31bb/nflfastR-data">
    <span class="fas fa fas fa-database fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="https://rbsdm.com/stats/">
    <span class="fas fa fas fa-chart-line fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="http://nflgamedata.com/">
    <span class="fas fa fas fa-football-ball fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="http://twitter.com/nflfastR">
    <span class="fab fa fab fa-twitter fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="https://github.com/mrcaseb/nflfastR/">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
<form class="navbar-form navbar-right hidden-xs hidden-sm" role="search">
        <div class="form-group">
          <input type="search" class="form-control" name="search-input" id="search-input" placeholder="Search..." aria-label="Search for..." autocomplete="off">
</div>
      </form>
      
    </div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="beginners_guide_files/accessible-code-block-0.0.1/empty-anchor.js"></script><link href="beginners_guide_files/anchor-sections-1.0/anchor-sections.css" rel="stylesheet">
<script src="beginners_guide_files/anchor-sections-1.0/anchor-sections.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>A beginner’s guide to nflfastR</h1>
                        <h4 class="author">Ben Baldwin</h4>
            
      
      <small class="dont-index">Source: <a href="https://github.com/mrcaseb/nflfastR/blob/master/vignettes/beginners_guide.Rmd"><code>vignettes/beginners_guide.Rmd</code></a></small>
      <div class="hidden name"><code>beginners_guide.Rmd</code></div>

    </div>

    
    
<div id="introduction" class="section level2">
<h2 class="hasAnchor">
<a href="#introduction" class="anchor"></a>Introduction</h2>
<p>The following guide will assume you have R installed. I also highly recommend working in RStudio. If you need help getting those installed or are unfamiliar with how RStudio is laid out, <a href="https://github.com/leesharpe/nfldata/blob/master/RSTUDIO-INTRO.md#r-and-rstudio-introduction">please see this section of Lee Sharpe’s guide</a>.</p>
<p>A quick word if you’re new to programming: all of this is happening in R. Obviously, you need to install R on your computer to do any of this. Make sure you save what you’re doing in a script (in RStudio, File –&gt; New File –&gt; R script) so you can save your work and run multiple lines of code at once. To run code from a script, highlight what you want, and press control + enter or press the Run button in the top of the editor (see Lee’s guide). If you don’t highlight anything and press control + enter, the currently selected line will run. As you go through your R journey, you might get stuck and have to google a bunch of things, but that’s totally okay and normal. That’s how I got started!</p>
</div>
<div id="setup" class="section level2">
<h2 class="hasAnchor">
<a href="#setup" class="anchor"></a>Setup</h2>
<p>First, you need to install the magic packages. You only need to run this step once on a given computer. For these you can just type them into the RStudio console (look for the Console pane in RStudio) directly since you’re never going to be doing this again.</p>
<div id="install-packages" class="section level3">
<h3 class="hasAnchor">
<a href="#install-packages" class="anchor"></a>Install packages</h3>
<div class="sourceCode" id="cb1"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html">install.packages</a></span><span class="op">(</span><span class="st">"tidyverse"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html">install.packages</a></span><span class="op">(</span><span class="st">"ggrepel"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html">install.packages</a></span><span class="op">(</span><span class="st">"ggimage"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html">install.packages</a></span><span class="op">(</span><span class="st">"nflfastR"</span><span class="op">)</span></pre></div>
</div>
<div id="load-packages" class="section level3">
<h3 class="hasAnchor">
<a href="#load-packages" class="anchor"></a>Load packages</h3>
<p>Okay, now here’s the stuff you’re going to want to start putting into your R script. The following loads <code>tidyverse</code>, which contains a lot of helper functions for working with data, and <code>ggrepel</code> and <code>ggimage</code> for making figures, along with <code>nflfastR</code>.</p>
<div class="sourceCode" id="cb2"><pre class="downlit">
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="http://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="http://github.com/slowkow/ggrepel">ggrepel</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/GuangchuangYu/ggimage">ggimage</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://www.nflfastr.com/">nflfastR</a></span><span class="op">)</span></pre></div>
<p>This one is optional but makes R prefer not to display numbers in scientific notation, which I find very annoying:</p>
<div class="sourceCode" id="cb3"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/base/options.html">options</a></span><span class="op">(</span>scipen <span class="op">=</span> <span class="fl">9999</span><span class="op">)</span></pre></div>
</div>
<div id="load-data" class="section level3">
<h3 class="hasAnchor">
<a href="#load-data" class="anchor"></a>Load data</h3>
<p>This will load the full play by play for the 2019 season (including playoffs). We’ll get to how to get more seasons later. Note that this is not actually using the <code>nflfastR</code> package, but downloading pre-cleaned data from its data repository, which is much faster.</p>
<div class="sourceCode" id="cb4"><pre class="downlit">
<span class="va">data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/connections.html">url</a></span><span class="op">(</span><span class="st">'https://raw.githubusercontent.com/guga31bb/nflfastR-data/master/data/play_by_play_2019.rds'</span><span class="op">)</span><span class="op">)</span></pre></div>
</div>
</div>
<div id="basics-how-to-look-at-your-data" class="section level2">
<h2 class="hasAnchor">
<a href="#basics-how-to-look-at-your-data" class="anchor"></a>Basics: how to look at your data</h2>
<div id="dimensions" class="section level3">
<h3 class="hasAnchor">
<a href="#dimensions" class="anchor"></a>Dimensions</h3>
<p>Before moving forward, here are a few ways to get a sense of what’s in a dataframe. We can check the <strong>dim</strong>ensions of the data, and this tells us that there are <code>48034</code> rows (i.e., plays) in the data and <code>340</code> columns (variables):</p>
<div class="sourceCode" id="cb5"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span>
<span class="co">#&gt; [1] 48034   340</span></pre></div>
<p><code>str</code> displays the <strong>str</strong>ucture of the dataframe:</p>
<div class="sourceCode" id="cb6"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/utils/str.html">str</a></span><span class="op">(</span><span class="va">data</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">]</span><span class="op">)</span>
<span class="co">#&gt; tibble [48,034 × 10] (S3: tbl_df/tbl/data.frame)</span>
<span class="co">#&gt;  $ play_id     : num [1:48034] 1 36 51 79 100 121 148 185 214 239 ...</span>
<span class="co">#&gt;  $ game_id     : chr [1:48034] "2019_01_ATL_MIN" "2019_01_ATL_MIN" "2019_01_ATL_MIN" "2019_01_ATL_MIN" ...</span>
<span class="co">#&gt;  $ old_game_id : chr [1:48034] "2019090804" "2019090804" "2019090804" "2019090804" ...</span>
<span class="co">#&gt;  $ home_team   : chr [1:48034] "MIN" "MIN" "MIN" "MIN" ...</span>
<span class="co">#&gt;  $ away_team   : chr [1:48034] "ATL" "ATL" "ATL" "ATL" ...</span>
<span class="co">#&gt;  $ season_type : chr [1:48034] "REG" "REG" "REG" "REG" ...</span>
<span class="co">#&gt;  $ week        : int [1:48034] 1 1 1 1 1 1 1 1 1 1 ...</span>
<span class="co">#&gt;  $ posteam     : chr [1:48034] NA "ATL" "ATL" "ATL" ...</span>
<span class="co">#&gt;  $ posteam_type: chr [1:48034] NA "away" "away" "away" ...</span>
<span class="co">#&gt;  $ defteam     : chr [1:48034] NA "MIN" "MIN" "MIN" ...</span></pre></div>
<p>In the above, I’ve added in the <code>[1:10]</code>, which selects only the first 10 columns, otherwise the list is extremely long (remember from above that there are <code>340</code> columns!).</p>
</div>
<div id="variable-names" class="section level3">
<h3 class="hasAnchor">
<a href="#variable-names" class="anchor"></a>Variable names</h3>
<p>Another very useful command is to get the <code>names</code> of the variables in the data:</p>
<div class="sourceCode" id="cb7"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span>
<span class="co">#&gt;   [1] "play_id"                             </span>
<span class="co">#&gt;   [2] "game_id"                             </span>
<span class="co">#&gt;   [3] "old_game_id"                         </span>
<span class="co">#&gt;   [4] "home_team"                           </span>
<span class="co">#&gt;   [5] "away_team"                           </span>
<span class="co">#&gt;   [6] "season_type"                         </span>
<span class="co">#&gt;   [7] "week"                                </span>
<span class="co">#&gt;   [8] "posteam"                             </span>
<span class="co">#&gt;   [9] "posteam_type"                        </span>
<span class="co">#&gt;  [10] "defteam"                             </span>
<span class="co">#&gt;  [11] "side_of_field"                       </span>
<span class="co">#&gt;  [12] "yardline_100"                        </span>
<span class="co">#&gt;  [13] "game_date"                           </span>
<span class="co">#&gt;  [14] "quarter_seconds_remaining"           </span>
<span class="co">#&gt;  [15] "half_seconds_remaining"              </span>
<span class="co">#&gt;  [16] "game_seconds_remaining"              </span>
<span class="co">#&gt;  [17] "game_half"                           </span>
<span class="co">#&gt;  [18] "quarter_end"                         </span>
<span class="co">#&gt;  [19] "drive"                               </span>
<span class="co">#&gt;  [20] "sp"                                  </span>
<span class="co">#&gt;  [21] "qtr"                                 </span>
<span class="co">#&gt;  [22] "down"                                </span>
<span class="co">#&gt;  [23] "goal_to_go"                          </span>
<span class="co">#&gt;  [24] "time"                                </span>
<span class="co">#&gt;  [25] "yrdln"                               </span>
<span class="co">#&gt;  [26] "ydstogo"                             </span>
<span class="co">#&gt;  [27] "ydsnet"                              </span>
<span class="co">#&gt;  [28] "desc"                                </span>
<span class="co">#&gt;  [29] "play_type"                           </span>
<span class="co">#&gt;  [30] "yards_gained"                        </span>
<span class="co">#&gt;  [31] "shotgun"                             </span>
<span class="co">#&gt;  [32] "no_huddle"                           </span>
<span class="co">#&gt;  [33] "qb_dropback"                         </span>
<span class="co">#&gt;  [34] "qb_kneel"                            </span>
<span class="co">#&gt;  [35] "qb_spike"                            </span>
<span class="co">#&gt;  [36] "qb_scramble"                         </span>
<span class="co">#&gt;  [37] "pass_length"                         </span>
<span class="co">#&gt;  [38] "pass_location"                       </span>
<span class="co">#&gt;  [39] "air_yards"                           </span>
<span class="co">#&gt;  [40] "yards_after_catch"                   </span>
<span class="co">#&gt;  [41] "run_location"                        </span>
<span class="co">#&gt;  [42] "run_gap"                             </span>
<span class="co">#&gt;  [43] "field_goal_result"                   </span>
<span class="co">#&gt;  [44] "kick_distance"                       </span>
<span class="co">#&gt;  [45] "extra_point_result"                  </span>
<span class="co">#&gt;  [46] "two_point_conv_result"               </span>
<span class="co">#&gt;  [47] "home_timeouts_remaining"             </span>
<span class="co">#&gt;  [48] "away_timeouts_remaining"             </span>
<span class="co">#&gt;  [49] "timeout"                             </span>
<span class="co">#&gt;  [50] "timeout_team"                        </span>
<span class="co">#&gt;  [51] "td_team"                             </span>
<span class="co">#&gt;  [52] "posteam_timeouts_remaining"          </span>
<span class="co">#&gt;  [53] "defteam_timeouts_remaining"          </span>
<span class="co">#&gt;  [54] "total_home_score"                    </span>
<span class="co">#&gt;  [55] "total_away_score"                    </span>
<span class="co">#&gt;  [56] "posteam_score"                       </span>
<span class="co">#&gt;  [57] "defteam_score"                       </span>
<span class="co">#&gt;  [58] "score_differential"                  </span>
<span class="co">#&gt;  [59] "posteam_score_post"                  </span>
<span class="co">#&gt;  [60] "defteam_score_post"                  </span>
<span class="co">#&gt;  [61] "score_differential_post"             </span>
<span class="co">#&gt;  [62] "no_score_prob"                       </span>
<span class="co">#&gt;  [63] "opp_fg_prob"                         </span>
<span class="co">#&gt;  [64] "opp_safety_prob"                     </span>
<span class="co">#&gt;  [65] "opp_td_prob"                         </span>
<span class="co">#&gt;  [66] "fg_prob"                             </span>
<span class="co">#&gt;  [67] "safety_prob"                         </span>
<span class="co">#&gt;  [68] "td_prob"                             </span>
<span class="co">#&gt;  [69] "extra_point_prob"                    </span>
<span class="co">#&gt;  [70] "two_point_conversion_prob"           </span>
<span class="co">#&gt;  [71] "ep"                                  </span>
<span class="co">#&gt;  [72] "epa"                                 </span>
<span class="co">#&gt;  [73] "total_home_epa"                      </span>
<span class="co">#&gt;  [74] "total_away_epa"                      </span>
<span class="co">#&gt;  [75] "total_home_rush_epa"                 </span>
<span class="co">#&gt;  [76] "total_away_rush_epa"                 </span>
<span class="co">#&gt;  [77] "total_home_pass_epa"                 </span>
<span class="co">#&gt;  [78] "total_away_pass_epa"                 </span>
<span class="co">#&gt;  [79] "air_epa"                             </span>
<span class="co">#&gt;  [80] "yac_epa"                             </span>
<span class="co">#&gt;  [81] "comp_air_epa"                        </span>
<span class="co">#&gt;  [82] "comp_yac_epa"                        </span>
<span class="co">#&gt;  [83] "total_home_comp_air_epa"             </span>
<span class="co">#&gt;  [84] "total_away_comp_air_epa"             </span>
<span class="co">#&gt;  [85] "total_home_comp_yac_epa"             </span>
<span class="co">#&gt;  [86] "total_away_comp_yac_epa"             </span>
<span class="co">#&gt;  [87] "total_home_raw_air_epa"              </span>
<span class="co">#&gt;  [88] "total_away_raw_air_epa"              </span>
<span class="co">#&gt;  [89] "total_home_raw_yac_epa"              </span>
<span class="co">#&gt;  [90] "total_away_raw_yac_epa"              </span>
<span class="co">#&gt;  [91] "wp"                                  </span>
<span class="co">#&gt;  [92] "def_wp"                              </span>
<span class="co">#&gt;  [93] "home_wp"                             </span>
<span class="co">#&gt;  [94] "away_wp"                             </span>
<span class="co">#&gt;  [95] "wpa"                                 </span>
<span class="co">#&gt;  [96] "home_wp_post"                        </span>
<span class="co">#&gt;  [97] "away_wp_post"                        </span>
<span class="co">#&gt;  [98] "vegas_wp"                            </span>
<span class="co">#&gt;  [99] "vegas_home_wp"                       </span>
<span class="co">#&gt; [100] "total_home_rush_wpa"                 </span>
<span class="co">#&gt; [101] "total_away_rush_wpa"                 </span>
<span class="co">#&gt; [102] "total_home_pass_wpa"                 </span>
<span class="co">#&gt; [103] "total_away_pass_wpa"                 </span>
<span class="co">#&gt; [104] "air_wpa"                             </span>
<span class="co">#&gt; [105] "yac_wpa"                             </span>
<span class="co">#&gt; [106] "comp_air_wpa"                        </span>
<span class="co">#&gt; [107] "comp_yac_wpa"                        </span>
<span class="co">#&gt; [108] "total_home_comp_air_wpa"             </span>
<span class="co">#&gt; [109] "total_away_comp_air_wpa"             </span>
<span class="co">#&gt; [110] "total_home_comp_yac_wpa"             </span>
<span class="co">#&gt; [111] "total_away_comp_yac_wpa"             </span>
<span class="co">#&gt; [112] "total_home_raw_air_wpa"              </span>
<span class="co">#&gt; [113] "total_away_raw_air_wpa"              </span>
<span class="co">#&gt; [114] "total_home_raw_yac_wpa"              </span>
<span class="co">#&gt; [115] "total_away_raw_yac_wpa"              </span>
<span class="co">#&gt; [116] "punt_blocked"                        </span>
<span class="co">#&gt; [117] "first_down_rush"                     </span>
<span class="co">#&gt; [118] "first_down_pass"                     </span>
<span class="co">#&gt; [119] "first_down_penalty"                  </span>
<span class="co">#&gt; [120] "third_down_converted"                </span>
<span class="co">#&gt; [121] "third_down_failed"                   </span>
<span class="co">#&gt; [122] "fourth_down_converted"               </span>
<span class="co">#&gt; [123] "fourth_down_failed"                  </span>
<span class="co">#&gt; [124] "incomplete_pass"                     </span>
<span class="co">#&gt; [125] "touchback"                           </span>
<span class="co">#&gt; [126] "interception"                        </span>
<span class="co">#&gt; [127] "punt_inside_twenty"                  </span>
<span class="co">#&gt; [128] "punt_in_endzone"                     </span>
<span class="co">#&gt; [129] "punt_out_of_bounds"                  </span>
<span class="co">#&gt; [130] "punt_downed"                         </span>
<span class="co">#&gt; [131] "punt_fair_catch"                     </span>
<span class="co">#&gt; [132] "kickoff_inside_twenty"               </span>
<span class="co">#&gt; [133] "kickoff_in_endzone"                  </span>
<span class="co">#&gt; [134] "kickoff_out_of_bounds"               </span>
<span class="co">#&gt; [135] "kickoff_downed"                      </span>
<span class="co">#&gt; [136] "kickoff_fair_catch"                  </span>
<span class="co">#&gt; [137] "fumble_forced"                       </span>
<span class="co">#&gt; [138] "fumble_not_forced"                   </span>
<span class="co">#&gt; [139] "fumble_out_of_bounds"                </span>
<span class="co">#&gt; [140] "solo_tackle"                         </span>
<span class="co">#&gt; [141] "safety"                              </span>
<span class="co">#&gt; [142] "penalty"                             </span>
<span class="co">#&gt; [143] "tackled_for_loss"                    </span>
<span class="co">#&gt; [144] "fumble_lost"                         </span>
<span class="co">#&gt; [145] "own_kickoff_recovery"                </span>
<span class="co">#&gt; [146] "own_kickoff_recovery_td"             </span>
<span class="co">#&gt; [147] "qb_hit"                              </span>
<span class="co">#&gt; [148] "rush_attempt"                        </span>
<span class="co">#&gt; [149] "pass_attempt"                        </span>
<span class="co">#&gt; [150] "sack"                                </span>
<span class="co">#&gt; [151] "touchdown"                           </span>
<span class="co">#&gt; [152] "pass_touchdown"                      </span>
<span class="co">#&gt; [153] "rush_touchdown"                      </span>
<span class="co">#&gt; [154] "return_touchdown"                    </span>
<span class="co">#&gt; [155] "extra_point_attempt"                 </span>
<span class="co">#&gt; [156] "two_point_attempt"                   </span>
<span class="co">#&gt; [157] "field_goal_attempt"                  </span>
<span class="co">#&gt; [158] "kickoff_attempt"                     </span>
<span class="co">#&gt; [159] "punt_attempt"                        </span>
<span class="co">#&gt; [160] "fumble"                              </span>
<span class="co">#&gt; [161] "complete_pass"                       </span>
<span class="co">#&gt; [162] "assist_tackle"                       </span>
<span class="co">#&gt; [163] "lateral_reception"                   </span>
<span class="co">#&gt; [164] "lateral_rush"                        </span>
<span class="co">#&gt; [165] "lateral_return"                      </span>
<span class="co">#&gt; [166] "lateral_recovery"                    </span>
<span class="co">#&gt; [167] "passer_player_id"                    </span>
<span class="co">#&gt; [168] "passer_player_name"                  </span>
<span class="co">#&gt; [169] "receiver_player_id"                  </span>
<span class="co">#&gt; [170] "receiver_player_name"                </span>
<span class="co">#&gt; [171] "rusher_player_id"                    </span>
<span class="co">#&gt; [172] "rusher_player_name"                  </span>
<span class="co">#&gt; [173] "lateral_receiver_player_id"          </span>
<span class="co">#&gt; [174] "lateral_receiver_player_name"        </span>
<span class="co">#&gt; [175] "lateral_rusher_player_id"            </span>
<span class="co">#&gt; [176] "lateral_rusher_player_name"          </span>
<span class="co">#&gt; [177] "lateral_sack_player_id"              </span>
<span class="co">#&gt; [178] "lateral_sack_player_name"            </span>
<span class="co">#&gt; [179] "interception_player_id"              </span>
<span class="co">#&gt; [180] "interception_player_name"            </span>
<span class="co">#&gt; [181] "lateral_interception_player_id"      </span>
<span class="co">#&gt; [182] "lateral_interception_player_name"    </span>
<span class="co">#&gt; [183] "punt_returner_player_id"             </span>
<span class="co">#&gt; [184] "punt_returner_player_name"           </span>
<span class="co">#&gt; [185] "lateral_punt_returner_player_id"     </span>
<span class="co">#&gt; [186] "lateral_punt_returner_player_name"   </span>
<span class="co">#&gt; [187] "kickoff_returner_player_name"        </span>
<span class="co">#&gt; [188] "kickoff_returner_player_id"          </span>
<span class="co">#&gt; [189] "lateral_kickoff_returner_player_id"  </span>
<span class="co">#&gt; [190] "lateral_kickoff_returner_player_name"</span>
<span class="co">#&gt; [191] "punter_player_id"                    </span>
<span class="co">#&gt; [192] "punter_player_name"                  </span>
<span class="co">#&gt; [193] "kicker_player_name"                  </span>
<span class="co">#&gt; [194] "kicker_player_id"                    </span>
<span class="co">#&gt; [195] "own_kickoff_recovery_player_id"      </span>
<span class="co">#&gt; [196] "own_kickoff_recovery_player_name"    </span>
<span class="co">#&gt; [197] "blocked_player_id"                   </span>
<span class="co">#&gt; [198] "blocked_player_name"                 </span>
<span class="co">#&gt; [199] "tackle_for_loss_1_player_id"         </span>
<span class="co">#&gt; [200] "tackle_for_loss_1_player_name"       </span>
<span class="co">#&gt; [201] "tackle_for_loss_2_player_id"         </span>
<span class="co">#&gt; [202] "tackle_for_loss_2_player_name"       </span>
<span class="co">#&gt; [203] "qb_hit_1_player_id"                  </span>
<span class="co">#&gt; [204] "qb_hit_1_player_name"                </span>
<span class="co">#&gt; [205] "qb_hit_2_player_id"                  </span>
<span class="co">#&gt; [206] "qb_hit_2_player_name"                </span>
<span class="co">#&gt; [207] "forced_fumble_player_1_team"         </span>
<span class="co">#&gt; [208] "forced_fumble_player_1_player_id"    </span>
<span class="co">#&gt; [209] "forced_fumble_player_1_player_name"  </span>
<span class="co">#&gt; [210] "forced_fumble_player_2_team"         </span>
<span class="co">#&gt; [211] "forced_fumble_player_2_player_id"    </span>
<span class="co">#&gt; [212] "forced_fumble_player_2_player_name"  </span>
<span class="co">#&gt; [213] "solo_tackle_1_team"                  </span>
<span class="co">#&gt; [214] "solo_tackle_2_team"                  </span>
<span class="co">#&gt; [215] "solo_tackle_1_player_id"             </span>
<span class="co">#&gt; [216] "solo_tackle_2_player_id"             </span>
<span class="co">#&gt; [217] "solo_tackle_1_player_name"           </span>
<span class="co">#&gt; [218] "solo_tackle_2_player_name"           </span>
<span class="co">#&gt; [219] "assist_tackle_1_player_id"           </span>
<span class="co">#&gt; [220] "assist_tackle_1_player_name"         </span>
<span class="co">#&gt; [221] "assist_tackle_1_team"                </span>
<span class="co">#&gt; [222] "assist_tackle_2_player_id"           </span>
<span class="co">#&gt; [223] "assist_tackle_2_player_name"         </span>
<span class="co">#&gt; [224] "assist_tackle_2_team"                </span>
<span class="co">#&gt; [225] "assist_tackle_3_player_id"           </span>
<span class="co">#&gt; [226] "assist_tackle_3_player_name"         </span>
<span class="co">#&gt; [227] "assist_tackle_3_team"                </span>
<span class="co">#&gt; [228] "assist_tackle_4_player_id"           </span>
<span class="co">#&gt; [229] "assist_tackle_4_player_name"         </span>
<span class="co">#&gt; [230] "assist_tackle_4_team"                </span>
<span class="co">#&gt; [231] "pass_defense_1_player_id"            </span>
<span class="co">#&gt; [232] "pass_defense_1_player_name"          </span>
<span class="co">#&gt; [233] "pass_defense_2_player_id"            </span>
<span class="co">#&gt; [234] "pass_defense_2_player_name"          </span>
<span class="co">#&gt; [235] "fumbled_1_team"                      </span>
<span class="co">#&gt; [236] "fumbled_1_player_id"                 </span>
<span class="co">#&gt; [237] "fumbled_1_player_name"               </span>
<span class="co">#&gt; [238] "fumbled_2_player_id"                 </span>
<span class="co">#&gt; [239] "fumbled_2_player_name"               </span>
<span class="co">#&gt; [240] "fumbled_2_team"                      </span>
<span class="co">#&gt; [241] "fumble_recovery_1_team"              </span>
<span class="co">#&gt; [242] "fumble_recovery_1_yards"             </span>
<span class="co">#&gt; [243] "fumble_recovery_1_player_id"         </span>
<span class="co">#&gt; [244] "fumble_recovery_1_player_name"       </span>
<span class="co">#&gt; [245] "fumble_recovery_2_team"              </span>
<span class="co">#&gt; [246] "fumble_recovery_2_yards"             </span>
<span class="co">#&gt; [247] "fumble_recovery_2_player_id"         </span>
<span class="co">#&gt; [248] "fumble_recovery_2_player_name"       </span>
<span class="co">#&gt; [249] "return_team"                         </span>
<span class="co">#&gt; [250] "return_yards"                        </span>
<span class="co">#&gt; [251] "penalty_team"                        </span>
<span class="co">#&gt; [252] "penalty_player_id"                   </span>
<span class="co">#&gt; [253] "penalty_player_name"                 </span>
<span class="co">#&gt; [254] "penalty_yards"                       </span>
<span class="co">#&gt; [255] "replay_or_challenge"                 </span>
<span class="co">#&gt; [256] "replay_or_challenge_result"          </span>
<span class="co">#&gt; [257] "penalty_type"                        </span>
<span class="co">#&gt; [258] "defensive_two_point_attempt"         </span>
<span class="co">#&gt; [259] "defensive_two_point_conv"            </span>
<span class="co">#&gt; [260] "defensive_extra_point_attempt"       </span>
<span class="co">#&gt; [261] "defensive_extra_point_conv"          </span>
<span class="co">#&gt; [262] "season"                              </span>
<span class="co">#&gt; [263] "cp"                                  </span>
<span class="co">#&gt; [264] "cpoe"                                </span>
<span class="co">#&gt; [265] "series"                              </span>
<span class="co">#&gt; [266] "series_success"                      </span>
<span class="co">#&gt; [267] "series_result"                       </span>
<span class="co">#&gt; [268] "order_sequence"                      </span>
<span class="co">#&gt; [269] "start_time"                          </span>
<span class="co">#&gt; [270] "time_of_day"                         </span>
<span class="co">#&gt; [271] "stadium"                             </span>
<span class="co">#&gt; [272] "weather"                             </span>
<span class="co">#&gt; [273] "nfl_api_id"                          </span>
<span class="co">#&gt; [274] "play_clock"                          </span>
<span class="co">#&gt; [275] "play_deleted"                        </span>
<span class="co">#&gt; [276] "play_type_nfl"                       </span>
<span class="co">#&gt; [277] "special_teams_play"                  </span>
<span class="co">#&gt; [278] "st_play_type"                        </span>
<span class="co">#&gt; [279] "end_clock_time"                      </span>
<span class="co">#&gt; [280] "end_yard_line"                       </span>
<span class="co">#&gt; [281] "fixed_drive"                         </span>
<span class="co">#&gt; [282] "fixed_drive_result"                  </span>
<span class="co">#&gt; [283] "drive_real_start_time"               </span>
<span class="co">#&gt; [284] "drive_play_count"                    </span>
<span class="co">#&gt; [285] "drive_time_of_possession"            </span>
<span class="co">#&gt; [286] "drive_first_downs"                   </span>
<span class="co">#&gt; [287] "drive_inside20"                      </span>
<span class="co">#&gt; [288] "drive_ended_with_score"              </span>
<span class="co">#&gt; [289] "drive_quarter_start"                 </span>
<span class="co">#&gt; [290] "drive_quarter_end"                   </span>
<span class="co">#&gt; [291] "drive_yards_penalized"               </span>
<span class="co">#&gt; [292] "drive_start_transition"              </span>
<span class="co">#&gt; [293] "drive_end_transition"                </span>
<span class="co">#&gt; [294] "drive_game_clock_start"              </span>
<span class="co">#&gt; [295] "drive_game_clock_end"                </span>
<span class="co">#&gt; [296] "drive_start_yard_line"               </span>
<span class="co">#&gt; [297] "drive_end_yard_line"                 </span>
<span class="co">#&gt; [298] "drive_play_id_started"               </span>
<span class="co">#&gt; [299] "drive_play_id_ended"                 </span>
<span class="co">#&gt; [300] "away_score"                          </span>
<span class="co">#&gt; [301] "home_score"                          </span>
<span class="co">#&gt; [302] "location"                            </span>
<span class="co">#&gt; [303] "result"                              </span>
<span class="co">#&gt; [304] "total"                               </span>
<span class="co">#&gt; [305] "spread_line"                         </span>
<span class="co">#&gt; [306] "total_line"                          </span>
<span class="co">#&gt; [307] "div_game"                            </span>
<span class="co">#&gt; [308] "roof"                                </span>
<span class="co">#&gt; [309] "surface"                             </span>
<span class="co">#&gt; [310] "temp"                                </span>
<span class="co">#&gt; [311] "wind"                                </span>
<span class="co">#&gt; [312] "home_coach"                          </span>
<span class="co">#&gt; [313] "away_coach"                          </span>
<span class="co">#&gt; [314] "stadium_id"                          </span>
<span class="co">#&gt; [315] "game_stadium"                        </span>
<span class="co">#&gt; [316] "success"                             </span>
<span class="co">#&gt; [317] "passer"                              </span>
<span class="co">#&gt; [318] "passer_jersey_number"                </span>
<span class="co">#&gt; [319] "rusher"                              </span>
<span class="co">#&gt; [320] "rusher_jersey_number"                </span>
<span class="co">#&gt; [321] "receiver"                            </span>
<span class="co">#&gt; [322] "receiver_jersey_number"              </span>
<span class="co">#&gt; [323] "pass"                                </span>
<span class="co">#&gt; [324] "rush"                                </span>
<span class="co">#&gt; [325] "first_down"                          </span>
<span class="co">#&gt; [326] "aborted_play"                        </span>
<span class="co">#&gt; [327] "special"                             </span>
<span class="co">#&gt; [328] "play"                                </span>
<span class="co">#&gt; [329] "passer_id"                           </span>
<span class="co">#&gt; [330] "rusher_id"                           </span>
<span class="co">#&gt; [331] "receiver_id"                         </span>
<span class="co">#&gt; [332] "name"                                </span>
<span class="co">#&gt; [333] "jersey_number"                       </span>
<span class="co">#&gt; [334] "id"                                  </span>
<span class="co">#&gt; [335] "qb_epa"                              </span>
<span class="co">#&gt; [336] "xyac_epa"                            </span>
<span class="co">#&gt; [337] "xyac_mean_yardage"                   </span>
<span class="co">#&gt; [338] "xyac_median_yardage"                 </span>
<span class="co">#&gt; [339] "xyac_success"                        </span>
<span class="co">#&gt; [340] "xyac_fd"</span></pre></div>
<p>That is a lot to work with!</p>
</div>
<div id="viewer" class="section level3">
<h3 class="hasAnchor">
<a href="#viewer" class="anchor"></a>Viewer</h3>
<p>One more way to look at your data is with the <code><a href="https://rdrr.io/r/utils/View.html">View()</a></code> function. If you’re coming from an Excel background, this will help you feel more at home as a way to see what’s in the data.</p>
<div class="sourceCode" id="cb8"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/utils/View.html">View</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span></pre></div>
<p>This will open the viewer in RStudio in a new panel. Try it out yourself! Since there are so many columns, the Viewer won’t show them all. To pick which columns to view, you can <strong>select</strong> some:</p>
<div class="sourceCode" id="cb9"><pre class="downlit">
<span class="va">data</span> <span class="op">%&gt;%</span>
  <span class="fu">select</span><span class="op">(</span><span class="va">home_team</span>, <span class="va">away_team</span>, <span class="va">posteam</span>, <span class="va">desc</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/utils/View.html">View</a></span><span class="op">(</span><span class="op">)</span></pre></div>
<p>The <code>%&gt;%</code> thing lets you pipe together a bunch of different commands. So we’re taking our data, “<code>select</code>”ing a few variables we want to look at, and then Viewing. Again, I can’t display the results of that here, but try it out yourself!</p>
</div>
<div id="head-manipulation" class="section level3">
<h3 class="hasAnchor">
<a href="#head-manipulation" class="anchor"></a>Head + manipulation</h3>
<p>To start, let’s just look at the first few rows (the “head”) of the data.</p>
<div class="sourceCode" id="cb10"><pre class="downlit">
<span class="va">data</span> <span class="op">%&gt;%</span> 
  <span class="fu">select</span><span class="op">(</span><span class="va">posteam</span>, <span class="va">defteam</span>, <span class="va">desc</span>, <span class="va">rush</span>, <span class="va">pass</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 6 x 5</span>
<span class="co">#&gt;   posteam defteam desc                                                rush  pass</span>
<span class="co">#&gt;   &lt;chr&gt;   &lt;chr&gt;   &lt;chr&gt;                                              &lt;dbl&gt; &lt;dbl&gt;</span>
<span class="co">#&gt; 1 &lt;NA&gt;    &lt;NA&gt;    GAME                                                   0     0</span>
<span class="co">#&gt; 2 ATL     MIN     5-D.Bailey kicks 65 yards from MIN 35 to end zone…     0     0</span>
<span class="co">#&gt; 3 ATL     MIN     (15:00) 2-M.Ryan sacked at ATL 17 for -8 yards (5…     0     1</span>
<span class="co">#&gt; 4 ATL     MIN     (14:20) 24-D.Freeman right tackle to ATL 21 for 4…     1     0</span>
<span class="co">#&gt; 5 ATL     MIN     (13:41) (Shotgun) 2-M.Ryan scrambles left end to …     0     1</span>
<span class="co">#&gt; 6 ATL     MIN     (12:59) 5-M.Bosher punt is BLOCKED by 50-E.Wilson…     0     0</span></pre></div>
<p>A couple things. “<code>desc</code>” is the important variable that lists the description of what happened on the play, and <code>head</code> says to show the first few rows (the “head” of the data). Since this is already sorted by game, these are the first 6 rows from a week 1 game, ATL @ MIN. To make code easier to read, people often put each part of a pipe on a new line, which is useful when working with more complicated functions. We could run:</p>
<div class="sourceCode" id="cb11"><pre class="downlit">
<span class="va">data</span> <span class="op">%&gt;%</span> <span class="fu">select</span><span class="op">(</span><span class="va">posteam</span>, <span class="va">defteam</span>, <span class="va">desc</span>, <span class="va">rush</span>, <span class="va">pass</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="op">)</span></pre></div>
<p>And it would return the exact same output as the one written out in multiple lines, but the code isn’t as easy to read.</p>
<p>We’ve covered <code>select</code>, and the next important function to learn is <code>filter</code>, which lets you filter the data to what you want. The following returns only plays that are run plays and pass plays; i.e., no punts, kickoffs, field goals, or dead ball penalties (e.g. false starts) where we don’t know what the attempted play was.</p>
<div class="sourceCode" id="cb12"><pre class="downlit">
<span class="va">data</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">rush</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">|</span> <span class="va">pass</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">select</span><span class="op">(</span><span class="va">posteam</span>, <span class="va">desc</span>, <span class="va">rush</span>, <span class="va">pass</span>, <span class="va">name</span>, <span class="va">passer</span>, <span class="va">rusher</span>, <span class="va">receiver</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 6 x 8</span>
<span class="co">#&gt;   posteam desc                        rush  pass name    passer  rusher receiver</span>
<span class="co">#&gt;   &lt;chr&gt;   &lt;chr&gt;                      &lt;dbl&gt; &lt;dbl&gt; &lt;chr&gt;   &lt;chr&gt;   &lt;chr&gt;  &lt;chr&gt;   </span>
<span class="co">#&gt; 1 ATL     (15:00) 2-M.Ryan sacked a…     0     1 M.Ryan  M.Ryan  &lt;NA&gt;   &lt;NA&gt;    </span>
<span class="co">#&gt; 2 ATL     (14:20) 24-D.Freeman righ…     1     0 D.Free… &lt;NA&gt;    D.Fre… &lt;NA&gt;    </span>
<span class="co">#&gt; 3 ATL     (13:41) (Shotgun) 2-M.Rya…     0     1 M.Ryan  M.Ryan  &lt;NA&gt;   &lt;NA&gt;    </span>
<span class="co">#&gt; 4 MIN     (12:53) 33-D.Cook right e…     1     0 D.Cook  &lt;NA&gt;    D.Cook &lt;NA&gt;    </span>
<span class="co">#&gt; 5 MIN     (12:32) 8-K.Cousins pass …     0     1 K.Cous… K.Cous… &lt;NA&gt;   D.Cook  </span>
<span class="co">#&gt; 6 MIN     (11:57) 8-K.Cousins pass …     0     1 K.Cous… K.Cous… &lt;NA&gt;   A.Thiel…</span></pre></div>
<p>Compared to the first time we did this, the opening line for the start of the game, the kickoff, and the punt are now gone. Note that if you’re checking whether a variable is equal to something, we need to use the double equals sign <code><a href="https://rdrr.io/r/base/Comparison.html">==</a></code> like above. There’s probably some technical reason for this [shrug emoji]. Also, the character <code><a href="https://rdrr.io/r/base/Logic.html">|</a></code> is used for “or”, and <code><a href="https://rdrr.io/r/base/Logic.html">&amp;</a></code> for “and”. So <code>rush == 1 | pass == 1</code> means “rush or pass”.</p>
<p>Note that the <code>rush</code>, <code>pass</code>, <code>name</code>, <code>passer</code>, <code>rusher</code>, and <code>receiver</code> columns are all <code>nflfastR</code> creations, where we have provided these to make working with the data easier. As we can see above, <code>passer</code> is filled in for all dropbacks (including sacks and scrambles, which also have <code>pass</code> = 1), and <code>name</code> is equal to the passer on pass plays and the rusher on rush plays. Think of this as the primary player involved on a play.</p>
<p>What if we wanted to view special teams plays? Again, we can use <code>filter</code>:</p>
<div class="sourceCode" id="cb13"><pre class="downlit">
<span class="va">data</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">special</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">select</span><span class="op">(</span><span class="va">down</span>, <span class="va">ydstogo</span>, <span class="va">desc</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 6 x 3</span>
<span class="co">#&gt;    down ydstogo desc                                                            </span>
<span class="co">#&gt;   &lt;dbl&gt;   &lt;dbl&gt; &lt;chr&gt;                                                           </span>
<span class="co">#&gt; 1    NA       0 5-D.Bailey kicks 65 yards from MIN 35 to end zone, Touchback.   </span>
<span class="co">#&gt; 2     4       2 (12:59) 5-M.Bosher punt is BLOCKED by 50-E.Wilson, Center-47-J.…</span>
<span class="co">#&gt; 3    NA       0 (Kick formation) 5-D.Bailey extra point is GOOD, Center-58-A.Cu…</span>
<span class="co">#&gt; 4    NA       0 5-D.Bailey kicks 67 yards from MIN 35 to ATL -2. 38-K.Barner to…</span>
<span class="co">#&gt; 5    NA       0 (Kick formation) 5-D.Bailey extra point is GOOD, Center-58-A.Cu…</span>
<span class="co">#&gt; 6    NA       0 5-D.Bailey kicks 65 yards from MIN 35 to end zone, Touchback.</span></pre></div>
<p>Fourth down plays?</p>
<div class="sourceCode" id="cb14"><pre class="downlit">
<span class="va">data</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">down</span> <span class="op">==</span> <span class="fl">4</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">select</span><span class="op">(</span><span class="va">down</span>, <span class="va">ydstogo</span>, <span class="va">desc</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 6 x 3</span>
<span class="co">#&gt;    down ydstogo desc                                                            </span>
<span class="co">#&gt;   &lt;dbl&gt;   &lt;dbl&gt; &lt;chr&gt;                                                           </span>
<span class="co">#&gt; 1     4       2 (12:59) 5-M.Bosher punt is BLOCKED by 50-E.Wilson, Center-47-J.…</span>
<span class="co">#&gt; 2     4      19 (2:38) 5-M.Bosher punts 33 yards to MIN 8, Center-47-J.Harris, …</span>
<span class="co">#&gt; 3     4      20 (12:33) 2-B.Colquitt punts 51 yards to ATL 17, Center-58-A.Cutt…</span>
<span class="co">#&gt; 4     4      27 (1:49) 5-M.Bosher punts 45 yards to MIN 10, Center-47-J.Harris,…</span>
<span class="co">#&gt; 5     4      10 (:49) 2-B.Colquitt punts 57 yards to ATL 33, Center-58-A.Cuttin…</span>
<span class="co">#&gt; 6     4       1 (10:56) 2-B.Colquitt punts 42 yards to ATL 10, Center-58-A.Cutt…</span></pre></div>
<p>Fourth down plays that aren’t special teams plays?</p>
<div class="sourceCode" id="cb15"><pre class="downlit">
<span class="va">data</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">down</span> <span class="op">==</span> <span class="fl">4</span> <span class="op">&amp;</span> <span class="va">special</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">select</span><span class="op">(</span><span class="va">down</span>, <span class="va">ydstogo</span>, <span class="va">desc</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 6 x 3</span>
<span class="co">#&gt;    down ydstogo desc                                                            </span>
<span class="co">#&gt;   &lt;dbl&gt;   &lt;dbl&gt; &lt;chr&gt;                                                           </span>
<span class="co">#&gt; 1     4       5 (9:25) (Shotgun) 2-M.Ryan pass deep left to 18-C.Ridley for 20 …</span>
<span class="co">#&gt; 2     4       2 (4:39) (Punt formation) PENALTY on MIN, Delay of Game, 5 yards,…</span>
<span class="co">#&gt; 3     4       2 (1:27) (No Huddle, Shotgun) 2-M.Ryan pass short left to 11-J.Jo…</span>
<span class="co">#&gt; 4     4       1 (2:59) (Punt formation) Direct snap to 41-A.Levine.  41-A.Levin…</span>
<span class="co">#&gt; 5     4       3 (9:30) (Shotgun) 3-R.Griffin pass short left to 89-M.Andrews fo…</span>
<span class="co">#&gt; 6     4       1 (3:55) 17-J.Allen FUMBLES (Aborted) at NYJ 37, RECOVERED by NYJ…</span></pre></div>
<p>So far, we’ve just been taking a look at the initial dataset we downloaded, but none of our results are preserved. To save a new dataframe of just the plays we want, we need to use <code><a href="https://rdrr.io/r/base/assignOps.html">&lt;-</a></code> to assign a new dataframe. Let’s save a new dataframe that’s just run plays and pass plays with non-missing EPA, called <code>pbp_rp</code>.</p>
<div class="sourceCode" id="cb16"><pre class="downlit">
<span class="va">pbp_rp</span> <span class="op">&lt;-</span> <span class="va">data</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">rush</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">|</span> <span class="va">pass</span> <span class="op">==</span> <span class="fl">1</span>, <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">epa</span><span class="op">)</span><span class="op">)</span></pre></div>
<p>In the above, <code>!is.na(epa)</code> means to exclude plays with missing (<code>na</code>) EPA. The <code><a href="https://rdrr.io/r/base/Logic.html">!</a></code> symbol is often used by computer folk to negate something, so <code><a href="https://rdrr.io/r/base/NA.html">is.na(epa)</a></code> means “EPA is missing” and <code>!is.na(epa)</code> means “EPA is not missing”, which we have used above.</p>
</div>
</div>
<div id="some-basic-stuff-part-1" class="section level2">
<h2 class="hasAnchor">
<a href="#some-basic-stuff-part-1" class="anchor"></a>Some basic stuff: Part 1</h2>
<p>Okay, we have a big dataset where we call dropbacks pass plays and non-dropbacks rush plays. Now we actually want to, like, do stuff.</p>
<div id="group-by-and-summarize" class="section level3">
<h3 class="hasAnchor">
<a href="#group-by-and-summarize" class="anchor"></a>Group by and Summarize</h3>
<p>Let’s take a look at how various Cowboys’ running backs fared on run plays in 2019:</p>
<div class="sourceCode" id="cb17"><pre class="downlit">
<span class="va">pbp_rp</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">posteam</span> <span class="op">==</span> <span class="st">"DAL"</span>, <span class="va">rush</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">group_by</span><span class="op">(</span><span class="va">rusher</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">summarize</span><span class="op">(</span>
      mean_epa <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">epa</span><span class="op">)</span>, success_rate <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">success</span><span class="op">)</span>, ypc<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">yards_gained</span><span class="op">)</span>, plays<span class="op">=</span><span class="fu">n</span><span class="op">(</span><span class="op">)</span>
      <span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">arrange</span><span class="op">(</span><span class="op">-</span><span class="va">mean_epa</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">plays</span> <span class="op">&gt;</span> <span class="fl">20</span><span class="op">)</span>
<span class="co">#&gt; `summarise()` ungrouping output (override with `.groups` argument)</span>
<span class="co">#&gt; # A tibble: 3 x 5</span>
<span class="co">#&gt;   rusher     mean_epa success_rate   ypc plays</span>
<span class="co">#&gt;   &lt;chr&gt;         &lt;dbl&gt;        &lt;dbl&gt; &lt;dbl&gt; &lt;int&gt;</span>
<span class="co">#&gt; 1 D.Prescott   0.288         0.591  6.41    22</span>
<span class="co">#&gt; 2 T.Pollard   -0.0266        0.456  5.08    90</span>
<span class="co">#&gt; 3 E.Elliott   -0.0412        0.411  4.39   309</span></pre></div>
<p>There’s a lot going on here. We’ve covered <code>filter</code> already. The <code>group_by</code> function is an <em>extremely</em> useful function that, well, groups by what you tell it – in this case the rusher. Summarize is useful for collapsing the data down to a summary of what you’re looking at, and here, while grouping by player, we’re summarizing the mean of EPA, success, yardage (a bad rushing stat, but since we’re here), and getting the number of plays using <code>n()</code>, which returns the number in a group. Unsurprisingly, Prescott was much more effective as a rusher in 2019 than the running backs, and there was no meaningful difference between Pollard and Elliott in efficiency.</p>
<p>If you check the <a href="https://www.pro-football-reference.com/teams/dal/2019.htm">PFR team stats page</a>, you’ll notice that the above doesn’t match up with the official stats. This is because <code>nflfastR</code> computes EPA and provides player names on plays with penalties and on two-point conversions. So if wanting to match the official stats, we need to restrict to <code>down &lt;= 4</code> (to excluded two-point conversions, which have down listed as <code>NA</code>) and <code>play_type = run</code> (to exclude penalties, which are <code>play_type = no_play</code>):</p>
<div class="sourceCode" id="cb18"><pre class="downlit">
<span class="va">pbp_rp</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">posteam</span> <span class="op">==</span> <span class="st">"DAL"</span>, <span class="va">down</span> <span class="op">&lt;=</span><span class="fl">4</span>, <span class="va">play_type</span> <span class="op">==</span> <span class="st">'run'</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">group_by</span><span class="op">(</span><span class="va">rusher</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">summarize</span><span class="op">(</span>
      mean_epa <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">epa</span><span class="op">)</span>, success_rate <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">success</span><span class="op">)</span>, ypc<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">yards_gained</span><span class="op">)</span>, plays<span class="op">=</span><span class="fu">n</span><span class="op">(</span><span class="op">)</span>
      <span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">plays</span> <span class="op">&gt;</span> <span class="fl">20</span><span class="op">)</span>
<span class="co">#&gt; `summarise()` ungrouping output (override with `.groups` argument)</span>
<span class="co">#&gt; # A tibble: 3 x 5</span>
<span class="co">#&gt;   rusher     mean_epa success_rate   ypc plays</span>
<span class="co">#&gt;   &lt;chr&gt;         &lt;dbl&gt;        &lt;dbl&gt; &lt;dbl&gt; &lt;int&gt;</span>
<span class="co">#&gt; 1 D.Prescott   0.288         0.591  6.41    22</span>
<span class="co">#&gt; 2 E.Elliott   -0.0185        0.422  4.51   301</span>
<span class="co">#&gt; 3 T.Pollard   -0.0210        0.453  5.29    86</span></pre></div>
<p>Now we exactly match PFR: Zeke has 301 carries at 4.5 yards/carry, and Pollard has 86 carries for 5.3 yards/carry. Note that we still aren’t matching Dak’s stats to PFR because the NFL classifies scrambles as rush attempts and <code>nflfastR</code> does not.</p>
</div>
<div id="manipulating-columns-mutate-if_else-and-case_when" class="section level3">
<h3 class="hasAnchor">
<a href="#manipulating-columns-mutate-if_else-and-case_when" class="anchor"></a>Manipulating columns: mutate, if_else, and case_when</h3>
<p>Let’s say we want to make a new column, named <code>home</code>, which is equal to 1 if the team with the ball is the home team. Let’s introduce another extremely useful function, <code>if_else</code>:</p>
<div class="sourceCode" id="cb19"><pre class="downlit">
<span class="va">pbp_rp</span> <span class="op">%&gt;%</span>
  <span class="fu">mutate</span><span class="op">(</span>
    home <span class="op">=</span> <span class="fu">if_else</span><span class="op">(</span><span class="va">posteam</span> <span class="op">==</span> <span class="va">home_team</span>, <span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span>
  <span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">select</span><span class="op">(</span><span class="va">posteam</span>, <span class="va">home_team</span>, <span class="va">home</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 10 x 3</span>
<span class="co">#&gt;    posteam home_team  home</span>
<span class="co">#&gt;    &lt;chr&gt;   &lt;chr&gt;     &lt;dbl&gt;</span>
<span class="co">#&gt;  1 ATL     MIN           0</span>
<span class="co">#&gt;  2 ATL     MIN           0</span>
<span class="co">#&gt;  3 ATL     MIN           0</span>
<span class="co">#&gt;  4 MIN     MIN           1</span>
<span class="co">#&gt;  5 MIN     MIN           1</span>
<span class="co">#&gt;  6 MIN     MIN           1</span>
<span class="co">#&gt;  7 ATL     MIN           0</span>
<span class="co">#&gt;  8 ATL     MIN           0</span>
<span class="co">#&gt;  9 ATL     MIN           0</span>
<span class="co">#&gt; 10 MIN     MIN           1</span></pre></div>
<p><code>mutate</code> is R’s word for creating a new column (or overwriting an existing one); in this case, we’ve created a new column called <code>home</code>. The above uses <code>if_else</code>, which uses the following pattern: condition (in this case, <code>posteam == home_team</code>), value if condition is true (in this case, if <code>posteam == home_team</code>, it is 1), and value if the condition is false (0). So we could use this to, for example, look at average EPA/play by home and road teams:</p>
<div class="sourceCode" id="cb20"><pre class="downlit">
<span class="va">pbp_rp</span> <span class="op">%&gt;%</span>
  <span class="fu">mutate</span><span class="op">(</span>
    home <span class="op">=</span> <span class="fu">if_else</span><span class="op">(</span><span class="va">posteam</span> <span class="op">==</span> <span class="va">home_team</span>, <span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span>
  <span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">group_by</span><span class="op">(</span><span class="va">home</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">summarize</span><span class="op">(</span>epa <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">epa</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt; `summarise()` ungrouping output (override with `.groups` argument)</span>
<span class="co">#&gt; # A tibble: 2 x 2</span>
<span class="co">#&gt;    home     epa</span>
<span class="co">#&gt;   &lt;dbl&gt;   &lt;dbl&gt;</span>
<span class="co">#&gt; 1     0  0.0214</span>
<span class="co">#&gt; 2     1 -0.0164</span></pre></div>
<p>Note that EPA/play is similar for home teams and away teams because <code>home</code> is already built into the <code>nflfastR</code> EPA model, so this result is expected. Actually, away EPA/play is actually somewhat higher, presumably because away teams out-performed their usual in 2019 as homefield advantage continues to decline generally.</p>
<p><code>if_else</code> is nice if you’re creating a new column based on a simple condition. But what if you need to do something more complicated? <code>case_when</code> is a good option. Here’s how it works:</p>
<div class="sourceCode" id="cb21"><pre class="downlit">
<span class="va">pbp_rp</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">cp</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">mutate</span><span class="op">(</span>
    depth <span class="op">=</span> <span class="fu">case_when</span><span class="op">(</span>
      <span class="va">air_yards</span> <span class="op">&lt;</span> <span class="fl">0</span> <span class="op">~</span> <span class="st">"Negative"</span>,
      <span class="va">air_yards</span> <span class="op">&gt;=</span> <span class="fl">0</span> <span class="op">&amp;</span> <span class="va">air_yards</span> <span class="op">&lt;</span> <span class="fl">10</span> <span class="op">~</span> <span class="st">"Short"</span>,
      <span class="va">air_yards</span> <span class="op">&gt;=</span> <span class="fl">10</span> <span class="op">&amp;</span> <span class="va">air_yards</span> <span class="op">&lt;</span> <span class="fl">20</span> <span class="op">~</span> <span class="st">"Medium"</span>,
      <span class="va">air_yards</span> <span class="op">&gt;=</span> <span class="fl">20</span> <span class="op">~</span> <span class="st">"Deep"</span>
    <span class="op">)</span>
  <span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">group_by</span><span class="op">(</span><span class="va">depth</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">summarize</span><span class="op">(</span>cp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">cp</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt; `summarise()` ungrouping output (override with `.groups` argument)</span>
<span class="co">#&gt; # A tibble: 4 x 2</span>
<span class="co">#&gt;   depth       cp</span>
<span class="co">#&gt;   &lt;chr&gt;    &lt;dbl&gt;</span>
<span class="co">#&gt; 1 Deep     0.367</span>
<span class="co">#&gt; 2 Medium   0.573</span>
<span class="co">#&gt; 3 Negative 0.847</span>
<span class="co">#&gt; 4 Short    0.718</span></pre></div>
<p>Note the new syntax for <code>case_when</code>: we have condition (for the first one, air yards less than 0), followed by <code><a href="https://rdrr.io/r/base/tilde.html">~</a></code>, followed by assignment (for the first one, “Negative”). In the above, we created 4 bins based on air yards and got average completion probability (<code>cp</code>) based on the <code>nflfastR</code> model. Unsurprisingly, <code>cp</code> is lower the longer downfield a throw goes.</p>
</div>
<div id="a-basic-figure" class="section level3">
<h3 class="hasAnchor">
<a href="#a-basic-figure" class="anchor"></a>A basic figure</h3>
<p>Now that we’ve gained some skills at manipulating data, let’s put it to use by making things. Which teams were the most pass-heavy in the first half on early downs with win probability between 20 and 80, excluding the final 2 minutes of the half when everyone is pass-happy?</p>
<div class="sourceCode" id="cb22"><pre class="downlit">
<span class="va">schotty</span> <span class="op">&lt;-</span> <span class="va">pbp_rp</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">wp</span> <span class="op">&gt;</span> <span class="fl">.20</span> <span class="op">&amp;</span> <span class="va">wp</span> <span class="op">&lt;</span> <span class="fl">.80</span> <span class="op">&amp;</span> <span class="va">down</span> <span class="op">&lt;=</span> <span class="fl">2</span> <span class="op">&amp;</span> <span class="va">qtr</span> <span class="op">&lt;=</span> <span class="fl">2</span> <span class="op">&amp;</span> <span class="va">half_seconds_remaining</span> <span class="op">&gt;</span> <span class="fl">120</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">group_by</span><span class="op">(</span><span class="va">posteam</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">summarize</span><span class="op">(</span>mean_pass <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">pass</span><span class="op">)</span>, plays <span class="op">=</span> <span class="fu">n</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">arrange</span><span class="op">(</span><span class="op">-</span><span class="va">mean_pass</span><span class="op">)</span>
<span class="co">#&gt; `summarise()` ungrouping output (override with `.groups` argument)</span>
<span class="va">schotty</span>
<span class="co">#&gt; # A tibble: 32 x 3</span>
<span class="co">#&gt;    posteam mean_pass plays</span>
<span class="co">#&gt;    &lt;chr&gt;       &lt;dbl&gt; &lt;int&gt;</span>
<span class="co">#&gt;  1 KC          0.697   383</span>
<span class="co">#&gt;  2 MIA         0.595   289</span>
<span class="co">#&gt;  3 LA          0.585   328</span>
<span class="co">#&gt;  4 NO          0.585   323</span>
<span class="co">#&gt;  5 CHI         0.566   309</span>
<span class="co">#&gt;  6 CLE         0.564   275</span>
<span class="co">#&gt;  7 TB          0.560   318</span>
<span class="co">#&gt;  8 CAR         0.558   267</span>
<span class="co">#&gt;  9 GB          0.552   286</span>
<span class="co">#&gt; 10 ARI         0.55    320</span>
<span class="co">#&gt; # … with 22 more rows</span></pre></div>
<p>Again, we’ve already used <code>filter</code>, <code>group_by</code>, and <code>summarize</code>. The new function we are using here is <code>arrange</code>, which sorts the data by the variable(s) given. The minus sign in front of <code>mean_pass</code> means to sort in descending order.</p>
<p>Let’s make our first figure:</p>
<div class="sourceCode" id="cb23"><pre class="downlit">
<span class="fu">ggplot</span><span class="op">(</span><span class="va">schotty</span>, <span class="fu">aes</span><span class="op">(</span>x<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/stats/reorder.factor.html">reorder</a></span><span class="op">(</span><span class="va">posteam</span>,<span class="op">-</span><span class="va">mean_pass</span><span class="op">)</span>, y<span class="op">=</span><span class="va">mean_pass</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
        <span class="fu">geom_text</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>label<span class="op">=</span><span class="va">posteam</span><span class="op">)</span><span class="op">)</span></pre></div>
<p><img src="beginners_guide_files/figure-html/fig1-1.png" width="100%"></p>
<p>This image is kind of a mess – we still need a title, axis labels, etc – but gets the point across. We’ll get to that other stuff later. But more importantly, we made something interesting using <code>nflfastR</code> data! The “reorder” sorts the teams according to pass rate, with the “-” again saying to do it in descending order. “aes” is short for “aesthetic”, which is R’s weird way of asking which variables should go on the x and y axes.</p>
<p>Looking at the figure, the Chiefs will never have playoff success until they establish the run.</p>
</div>
</div>
<div id="loading-multiple-seasons" class="section level2">
<h2 class="hasAnchor">
<a href="#loading-multiple-seasons" class="anchor"></a>Loading multiple seasons</h2>
<p>Because all the data is stored in the data repository, it is very easy to use data from multiple seasons. <a href="https://github.com/guga31bb/nflfastR-data">The repository page</a> has instructions for loading multiple seasons:</p>
<div class="sourceCode" id="cb24"><pre class="downlit">
<span class="va">seasons</span> <span class="op">&lt;-</span> <span class="fl">2015</span><span class="op">:</span><span class="fl">2019</span>
<span class="va">pbp</span> <span class="op">&lt;-</span> <span class="fu">map_df</span><span class="op">(</span><span class="va">seasons</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span><span class="op">(</span>
    <span class="fu"><a href="https://rdrr.io/r/base/connections.html">url</a></span><span class="op">(</span>
      <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"https://raw.githubusercontent.com/guga31bb/nflfastR-data/master/data/play_by_play_"</span>,<span class="va">x</span>,<span class="st">".rds"</span><span class="op">)</span>
    <span class="op">)</span>
  <span class="op">)</span>
<span class="op">}</span><span class="op">)</span></pre></div>
<p>You don’t need to understand this one yet, but if you’re curious, <code>map_df</code> stitches together the output from running a function repeatedly with different inputs. In this case, the function is simply reading one season’s data, and the inputs are the list of seasons we want: in the above, 2015 through 2019. But all you need to know how to do is change the range of seasons to get whichever seasons you want.</p>
<p>Let’s make sure we got it all. By now, you should understand what this is doing:</p>
<div class="sourceCode" id="cb25"><pre class="downlit">
<span class="va">pbp</span> <span class="op">%&gt;%</span>
  <span class="fu">group_by</span><span class="op">(</span><span class="va">season</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">summarize</span><span class="op">(</span>n <span class="op">=</span> <span class="fu">n</span><span class="op">(</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt; `summarise()` ungrouping output (override with `.groups` argument)</span>
<span class="co">#&gt; # A tibble: 5 x 2</span>
<span class="co">#&gt;   season     n</span>
<span class="co">#&gt;    &lt;int&gt; &lt;int&gt;</span>
<span class="co">#&gt; 1   2015 48869</span>
<span class="co">#&gt; 2   2016 48419</span>
<span class="co">#&gt; 3   2017 47997</span>
<span class="co">#&gt; 4   2018 47874</span>
<span class="co">#&gt; 5   2019 48034</span></pre></div>
<p>So each season has about 48,000 plays. Just for fun, let’s look at the various play types:</p>
<div class="sourceCode" id="cb26"><pre class="downlit">
<span class="va">pbp</span> <span class="op">%&gt;%</span>
  <span class="fu">group_by</span><span class="op">(</span><span class="va">play_type</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">summarize</span><span class="op">(</span>n <span class="op">=</span> <span class="fu">n</span><span class="op">(</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt; `summarise()` ungrouping output (override with `.groups` argument)</span>
<span class="co">#&gt; # A tibble: 10 x 2</span>
<span class="co">#&gt;    play_type       n</span>
<span class="co">#&gt;    &lt;chr&gt;       &lt;int&gt;</span>
<span class="co">#&gt;  1 extra_point  6115</span>
<span class="co">#&gt;  2 field_goal   5138</span>
<span class="co">#&gt;  3 kickoff     13525</span>
<span class="co">#&gt;  4 no_play     22778</span>
<span class="co">#&gt;  5 pass        99986</span>
<span class="co">#&gt;  6 punt        12021</span>
<span class="co">#&gt;  7 qb_kneel     2090</span>
<span class="co">#&gt;  8 qb_spike      340</span>
<span class="co">#&gt;  9 run         68129</span>
<span class="co">#&gt; 10 &lt;NA&gt;        11071</span></pre></div>
</div>
<div id="figures-with-qb-stats" class="section level2">
<h2 class="hasAnchor">
<a href="#figures-with-qb-stats" class="anchor"></a>Figures with QB stats</h2>
<p>Let’s do some stuff with quarterbacks:</p>
<div class="sourceCode" id="cb27"><pre class="downlit">
<span class="va">qbs</span> <span class="op">&lt;-</span> <span class="va">pbp</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">week</span> <span class="op">&lt;=</span> <span class="fl">17</span>, <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">epa</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">group_by</span><span class="op">(</span><span class="va">id</span>, <span class="va">name</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">summarize</span><span class="op">(</span>
    epa <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">qb_epa</span><span class="op">)</span>,
    cpoe <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">cpoe</span>, na.rm <span class="op">=</span> <span class="cn">T</span><span class="op">)</span>,
    n_dropbacks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">pass</span><span class="op">)</span>,
    n_plays <span class="op">=</span> <span class="fu">n</span><span class="op">(</span><span class="op">)</span>,
    team <span class="op">=</span> <span class="fu">last</span><span class="op">(</span><span class="va">posteam</span><span class="op">)</span>
  <span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">ungroup</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">n_dropbacks</span> <span class="op">&gt;</span> <span class="fl">100</span> <span class="op">&amp;</span> <span class="va">n_plays</span> <span class="op">&gt;</span> <span class="fl">1000</span><span class="op">)</span>
<span class="co">#&gt; `summarise()` regrouping output by 'id' (override with `.groups` argument)</span></pre></div>
<p>Lots of new stuff here. First, we’re grouping by <code>id</code> and <code>name</code> to make sure we’re getting unique players; i.e., if two players have the same name (like Javorius Allen and Josh Allen both being J.Allen), we are also using their id to differntiate them. <code>qb_epa</code> is an <code>nflfastR</code> creation that is equal to EPA in all instances except for when a pass is completed and a fumble is lost, in which case a QB gets “credit” for the play up to the spot the fumble was lost (making EPA function like passing yards). The <code>last</code> part in the <code>summarize</code> comment gets the last team that a player was observed playing with.</p>
<p>My way of getting a dataset with only quarterbacks without joining to external roster data is to make sure they hit some number of dropbacks. In this case, filtering with <code>n_dropbacks &gt; 100</code> makes sure we’re only including quarterbacks. The <code>ungroup()</code> near the end is good practice after grouping to make sure you don’t get weird behavior with the data you created down the line.</p>
<p>Let’s make some more figures. The <code>team_colors_logos</code> dataframe is provided in the <code>nflfastR</code> package, so since we have already loaded the package, it’s ready to use.</p>
<div class="sourceCode" id="cb28"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">teams_colors_logos</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 6 x 11</span>
<span class="co">#&gt;   team_abbr team_name team_id team_nick team_color team_color2 team_color3</span>
<span class="co">#&gt;   &lt;chr&gt;     &lt;chr&gt;     &lt;chr&gt;   &lt;chr&gt;     &lt;chr&gt;      &lt;chr&gt;       &lt;chr&gt;      </span>
<span class="co">#&gt; 1 ARI       Arizona … 3800    Cardinals #97233f    #000000     #ffb612    </span>
<span class="co">#&gt; 2 ATL       Atlanta … 0200    Falcons   #a71930    #000000     #a5acaf    </span>
<span class="co">#&gt; 3 BAL       Baltimor… 0325    Ravens    #241773    #000000     #9e7c0c    </span>
<span class="co">#&gt; 4 BUF       Buffalo … 0610    Bills     #00338d    #c60c30     #0c2e82    </span>
<span class="co">#&gt; 5 CAR       Carolina… 0750    Panthers  #0085ca    #000000     #bfc0bf    </span>
<span class="co">#&gt; 6 CHI       Chicago … 0810    Bears     #0b162a    #c83803     #0b162a    </span>
<span class="co">#&gt; # … with 4 more variables: team_color4 &lt;chr&gt;, team_logo_wikipedia &lt;chr&gt;,</span>
<span class="co">#&gt; #   team_logo_espn &lt;chr&gt;, team_wordmark &lt;glue&gt;</span></pre></div>
<p>Let’s join this to the <code>qbs</code> dataframe we created:</p>
<div class="sourceCode" id="cb29"><pre class="downlit">
<span class="va">qbs</span> <span class="op">&lt;-</span> <span class="va">qbs</span> <span class="op">%&gt;%</span>
  <span class="fu">left_join</span><span class="op">(</span><span class="va">teams_colors_logos</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'team'</span> <span class="op">=</span> <span class="st">'team_abbr'</span><span class="op">)</span><span class="op">)</span></pre></div>
<p><code>left_join</code> means keep all the rows from the left dataframe (the first one provided, <code>qbs</code>), and join those rows to available rows in the other dataframe. We also need to provide the joining variables, <code>team</code> from <code>qbs</code> and <code>team_abbr</code> from <code>team_colors_logos</code>. Why do we have to type <code>by = c('team' = 'team_abbr')</code>? Who knows, but it’s what <code>left_join</code> requires as instructions for how to match.</p>
<div id="with-team-color-dots" class="section level3">
<h3 class="hasAnchor">
<a href="#with-team-color-dots" class="anchor"></a>With team color dots</h3>
<p>Now we can make a figure!</p>
<div class="sourceCode" id="cb30"><pre class="downlit">
<span class="va">qbs</span> <span class="op">%&gt;%</span>
  <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">cpoe</span>, y <span class="op">=</span> <span class="va">epa</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="co">#horizontal line with mean EPA</span>
  <span class="fu">geom_hline</span><span class="op">(</span>yintercept <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">qbs</span><span class="op">$</span><span class="va">epa</span><span class="op">)</span>, color <span class="op">=</span> <span class="st">"red"</span>, linetype <span class="op">=</span> <span class="st">"dashed"</span>, alpha<span class="op">=</span><span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span>
  <span class="co">#vertical line with mean CPOE</span>
  <span class="fu">geom_vline</span><span class="op">(</span>xintercept <span class="op">=</span>  <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">qbs</span><span class="op">$</span><span class="va">cpoe</span><span class="op">)</span>, color <span class="op">=</span> <span class="st">"red"</span>, linetype <span class="op">=</span> <span class="st">"dashed"</span>, alpha<span class="op">=</span><span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span>
  <span class="co">#add points for the QBs with the right colors</span>
  <span class="co">#cex controls point size and alpha the transparency (alpha = 1 is normal)</span>
  <span class="fu">geom_point</span><span class="op">(</span>color <span class="op">=</span> <span class="va">qbs</span><span class="op">$</span><span class="va">team_color</span>, cex<span class="op">=</span><span class="va">qbs</span><span class="op">$</span><span class="va">n_plays</span> <span class="op">/</span> <span class="fl">350</span>, alpha <span class="op">=</span> <span class="fl">.6</span><span class="op">)</span> <span class="op">+</span>
  <span class="co">#add names using ggrepel, which tries to make them not overlap</span>
  <span class="fu"><a href="https://rdrr.io/pkg/ggrepel/man/geom_text_repel.html">geom_text_repel</a></span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>label<span class="op">=</span><span class="va">name</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="co">#add a smooth line fitting cpoe + epa</span>
  <span class="fu">stat_smooth</span><span class="op">(</span>geom<span class="op">=</span><span class="st">'line'</span>, alpha<span class="op">=</span><span class="fl">0.5</span>, se<span class="op">=</span><span class="cn">FALSE</span>, method<span class="op">=</span><span class="st">'lm'</span><span class="op">)</span><span class="op">+</span>
  <span class="co">#titles and caption</span>
  <span class="fu">labs</span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Completion % above expected (CPOE)"</span>,
       y <span class="op">=</span> <span class="st">"EPA per play (passes, rushes, and penalties)"</span>,
       title <span class="op">=</span> <span class="st">"Quarterback Efficiency, 2015 - 2019"</span>,
       caption <span class="op">=</span> <span class="st">"Data: @nflfastR"</span><span class="op">)</span> <span class="op">+</span>
  <span class="co">#uses the black and white ggplot theme</span>
  <span class="fu">theme_bw</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="co">#center title with hjust = 0.5</span>
  <span class="fu">theme</span><span class="op">(</span>
    plot.title <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>size <span class="op">=</span> <span class="fl">14</span>, hjust <span class="op">=</span> <span class="fl">0.5</span>, face <span class="op">=</span> <span class="st">"bold"</span><span class="op">)</span>
  <span class="op">)</span> <span class="op">+</span>
  <span class="co">#make ticks look nice</span>
  <span class="co">#if this doesn't work, `install.packages('scales')`</span>
  <span class="fu">scale_y_continuous</span><span class="op">(</span>breaks <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="fu"><a href="https://scales.r-lib.org//reference/breaks_pretty.html">pretty_breaks</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">10</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">scale_x_continuous</span><span class="op">(</span>breaks <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="fu"><a href="https://scales.r-lib.org//reference/breaks_pretty.html">pretty_breaks</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">10</span><span class="op">)</span><span class="op">)</span></pre></div>
<p><img src="beginners_guide_files/figure-html/fig2-1.png" width="100%"></p>
<p>This looks complicated, but is just a way of getting a bunch of different stuff on the same plot: we have lines for averages, dots, names, etc. I added comments above to explain what is going on, but in practice for making figures I usually just copy and paste stuff and/or google what I need.</p>
</div>
<div id="with-team-logos" class="section level3">
<h3 class="hasAnchor">
<a href="#with-team-logos" class="anchor"></a>With team logos</h3>
<p>We could also make the same plot with team logos:</p>
<div class="sourceCode" id="cb31"><pre class="downlit">
<span class="va">qbs</span> <span class="op">%&gt;%</span>
  <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">cpoe</span>, y <span class="op">=</span> <span class="va">epa</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="co">#horizontal line with mean EPA</span>
  <span class="fu">geom_hline</span><span class="op">(</span>yintercept <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">qbs</span><span class="op">$</span><span class="va">epa</span><span class="op">)</span>, color <span class="op">=</span> <span class="st">"red"</span>, linetype <span class="op">=</span> <span class="st">"dashed"</span>, alpha<span class="op">=</span><span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span>
  <span class="co">#vertical line with mean CPOE</span>
  <span class="fu">geom_vline</span><span class="op">(</span>xintercept <span class="op">=</span>  <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">qbs</span><span class="op">$</span><span class="va">cpoe</span><span class="op">)</span>, color <span class="op">=</span> <span class="st">"red"</span>, linetype <span class="op">=</span> <span class="st">"dashed"</span>, alpha<span class="op">=</span><span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span>
  <span class="co">#add points for the QBs with the logos</span>
  <span class="fu"><a href="https://rdrr.io/pkg/ggimage/man/geom_image.html">geom_image</a></span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>image <span class="op">=</span> <span class="va">team_logo_espn</span><span class="op">)</span>, size <span class="op">=</span> <span class="va">qbs</span><span class="op">$</span><span class="va">n_plays</span> <span class="op">/</span> <span class="fl">45000</span>, asp <span class="op">=</span> <span class="fl">16</span> <span class="op">/</span> <span class="fl">9</span><span class="op">)</span> <span class="op">+</span>
  <span class="co">#add names using ggrepel, which tries to make them not overlap</span>
  <span class="fu"><a href="https://rdrr.io/pkg/ggrepel/man/geom_text_repel.html">geom_text_repel</a></span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>label<span class="op">=</span><span class="va">name</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="co">#add a smooth line fitting cpoe + epa</span>
  <span class="fu">stat_smooth</span><span class="op">(</span>geom<span class="op">=</span><span class="st">'line'</span>, alpha<span class="op">=</span><span class="fl">0.5</span>, se<span class="op">=</span><span class="cn">FALSE</span>, method<span class="op">=</span><span class="st">'lm'</span><span class="op">)</span><span class="op">+</span>
  <span class="co">#titles and caption</span>
  <span class="fu">labs</span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Completion % above expected (CPOE)"</span>,
       y <span class="op">=</span> <span class="st">"EPA per play (passes, rushes, and penalties)"</span>,
       title <span class="op">=</span> <span class="st">"Quarterback Efficiency, 2015 - 2019"</span>,
       caption <span class="op">=</span> <span class="st">"Data: @nflfastR"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">theme_bw</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="co">#center title</span>
  <span class="fu">theme</span><span class="op">(</span>
    aspect.ratio <span class="op">=</span> <span class="fl">9</span> <span class="op">/</span> <span class="fl">16</span>,
    plot.title <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>size <span class="op">=</span> <span class="fl">14</span>, hjust <span class="op">=</span> <span class="fl">0.5</span>, face <span class="op">=</span> <span class="st">"bold"</span><span class="op">)</span>
  <span class="op">)</span> <span class="op">+</span>
  <span class="co">#make ticks look nice</span>
  <span class="fu">scale_y_continuous</span><span class="op">(</span>breaks <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="fu"><a href="https://scales.r-lib.org//reference/breaks_pretty.html">pretty_breaks</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">10</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">scale_x_continuous</span><span class="op">(</span>breaks <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="fu"><a href="https://scales.r-lib.org//reference/breaks_pretty.html">pretty_breaks</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">10</span><span class="op">)</span><span class="op">)</span></pre></div>
<p><img src="beginners_guide_files/figure-html/fig3-1.png" width="100%"></p>
<p>The only changes we’ve made are to use <code>geom_image</code> instead of <code>geom_point</code>, and to put <code>aspect.ratio = 9 / 16</code> in the <code>theme()</code> part. This makes the plot output dimensions consistent with the provided images and leads to the images not looking squished (how to figure out the right size for the images? Trial and error).</p>
<p>This figure would look better with transparent logos or fewer players shown, but the point of this is explaining how to do stuff, so let’s call this good enough.</p>
</div>
</div>
<div id="real-life-example-lets-make-a-win-total-model" class="section level2">
<h2 class="hasAnchor">
<a href="#real-life-example-lets-make-a-win-total-model" class="anchor"></a>Real life example: let’s make a win total model</h2>
<p>I’m going to try to go through the process of cleaning and joining multiple data sets to try to get a sense of how I would approach something like this, step-by-step.</p>
<div id="get-team-wins-each-season" class="section level3">
<h3 class="hasAnchor">
<a href="#get-team-wins-each-season" class="anchor"></a>Get team wins each season</h3>
<p>We’re going to cheat a little and take advantage of Lee Sharpe’s famous <code>games</code> file. Most of this stuff has been added into <code>nflfastR</code>, but it’s easier working with this file where each game is one row.</p>
<div class="sourceCode" id="cb32"><pre class="downlit">
<span class="va">games</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/connections.html">url</a></span><span class="op">(</span><span class="st">"http://www.habitatring.com/games.rds"</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/str.html">str</a></span><span class="op">(</span><span class="va">games</span><span class="op">)</span>
<span class="co">#&gt; tibble [5,839 × 36] (S3: tbl_df/tbl/data.frame)</span>
<span class="co">#&gt;  $ game_id         : chr [1:5839] "1999_01_MIN_ATL" "1999_01_KC_CHI" "1999_01_PIT_CLE" "1999_01_OAK_GB" ...</span>
<span class="co">#&gt;  $ season          : int [1:5839] 1999 1999 1999 1999 1999 1999 1999 1999 1999 1999 ...</span>
<span class="co">#&gt;  $ game_type       : chr [1:5839] "REG" "REG" "REG" "REG" ...</span>
<span class="co">#&gt;  $ week            : int [1:5839] 1 1 1 1 1 1 1 1 1 1 ...</span>
<span class="co">#&gt;  $ gameday         : chr [1:5839] "1999-09-12" "1999-09-12" "1999-09-12" "1999-09-12" ...</span>
<span class="co">#&gt;  $ weekday         : chr [1:5839] "Sunday" "Sunday" "Sunday" "Sunday" ...</span>
<span class="co">#&gt;  $ gametime        : chr [1:5839] NA NA NA NA ...</span>
<span class="co">#&gt;  $ away_team       : chr [1:5839] "MIN" "KC" "PIT" "OAK" ...</span>
<span class="co">#&gt;  $ away_score      : int [1:5839] 17 17 43 24 14 3 10 30 25 28 ...</span>
<span class="co">#&gt;  $ home_team       : chr [1:5839] "ATL" "CHI" "CLE" "GB" ...</span>
<span class="co">#&gt;  $ home_score      : int [1:5839] 14 20 0 28 31 41 19 28 24 20 ...</span>
<span class="co">#&gt;  $ location        : chr [1:5839] "Home" "Home" "Home" "Home" ...</span>
<span class="co">#&gt;  $ result          : int [1:5839] -3 3 -43 4 17 38 9 -2 -1 -8 ...</span>
<span class="co">#&gt;  $ total           : int [1:5839] 31 37 43 52 45 44 29 58 49 48 ...</span>
<span class="co">#&gt;  $ overtime        : int [1:5839] 0 0 0 0 0 0 0 0 0 0 ...</span>
<span class="co">#&gt;  $ old_game_id     : chr [1:5839] "1999091210" "1999091206" "1999091213" "1999091208" ...</span>
<span class="co">#&gt;  $ away_rest       : int [1:5839] 7 7 7 7 7 7 7 7 7 7 ...</span>
<span class="co">#&gt;  $ home_rest       : int [1:5839] 7 7 7 7 7 7 7 7 7 7 ...</span>
<span class="co">#&gt;  $ away_moneyline  : int [1:5839] NA NA NA NA NA NA NA NA NA NA ...</span>
<span class="co">#&gt;  $ home_moneyline  : int [1:5839] NA NA NA NA NA NA NA NA NA NA ...</span>
<span class="co">#&gt;  $ spread_line     : num [1:5839] -4 -3 -6 9 -3 5.5 3.5 7 -3 9.5 ...</span>
<span class="co">#&gt;  $ away_spread_odds: int [1:5839] NA NA NA NA NA NA NA NA NA NA ...</span>
<span class="co">#&gt;  $ home_spread_odds: int [1:5839] NA NA NA NA NA NA NA NA NA NA ...</span>
<span class="co">#&gt;  $ total_line      : num [1:5839] 49 38 37 43 45.5 49 38 44.5 37 42 ...</span>
<span class="co">#&gt;  $ under_odds      : int [1:5839] NA NA NA NA NA NA NA NA NA NA ...</span>
<span class="co">#&gt;  $ over_odds       : int [1:5839] NA NA NA NA NA NA NA NA NA NA ...</span>
<span class="co">#&gt;  $ div_game        : int [1:5839] 0 0 1 0 1 0 1 1 1 0 ...</span>
<span class="co">#&gt;  $ roof            : chr [1:5839] "dome" "outdoors" "outdoors" "outdoors" ...</span>
<span class="co">#&gt;  $ surface         : chr [1:5839] "astroturf" "grass" "grass" "grass" ...</span>
<span class="co">#&gt;  $ temp            : int [1:5839] NA 80 78 67 NA 76 NA 73 75 NA ...</span>
<span class="co">#&gt;  $ wind            : int [1:5839] NA 12 12 10 NA 8 NA 5 3 NA ...</span>
<span class="co">#&gt;  $ away_coach      : chr [1:5839] "Dennis Green" "Gunther Cunningham" "Bill Cowher" "Jon Gruden" ...</span>
<span class="co">#&gt;  $ home_coach      : chr [1:5839] "Dan Reeves" "Dick Jauron" "Chris Palmer" "Ray Rhodes" ...</span>
<span class="co">#&gt;  $ referee         : chr [1:5839] "Gerry Austin" "Phil Luckett" "Bob McElwee" "Tony Corrente" ...</span>
<span class="co">#&gt;  $ stadium_id      : chr [1:5839] "ATL00" "CHI98" "CLE00" "GNB00" ...</span>
<span class="co">#&gt;  $ stadium         : chr [1:5839] "Georgia Dome" "Soldier Field" "Cleveland Browns Stadium" "Lambeau Field" ...</span></pre></div>
<p>To start, we want to create a dataframe where each row is a team-season observation, listing how many games they won. There are multiple ways to do this, but I’m going to just take the home and away results and bind together. As an example, here’s what the <code>home</code> results look like:</p>
<div class="sourceCode" id="cb33"><pre class="downlit">
<span class="va">home</span> <span class="op">&lt;-</span> <span class="va">games</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">game_type</span> <span class="op">==</span> <span class="st">'REG'</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">select</span><span class="op">(</span><span class="va">season</span>, <span class="va">week</span>, <span class="va">home_team</span>, <span class="va">result</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">rename</span><span class="op">(</span>team <span class="op">=</span> <span class="va">home_team</span><span class="op">)</span>
<span class="va">home</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="fl">5</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 5 x 4</span>
<span class="co">#&gt;   season  week team  result</span>
<span class="co">#&gt;    &lt;int&gt; &lt;int&gt; &lt;chr&gt;  &lt;int&gt;</span>
<span class="co">#&gt; 1   1999     1 ATL       -3</span>
<span class="co">#&gt; 2   1999     1 CHI        3</span>
<span class="co">#&gt; 3   1999     1 CLE      -43</span>
<span class="co">#&gt; 4   1999     1 GB         4</span>
<span class="co">#&gt; 5   1999     1 IND       17</span></pre></div>
<p>Note that we used <code>rename</code> to change <code>home_team</code> to <code>team</code>.</p>
<div class="sourceCode" id="cb34"><pre class="downlit">
<span class="va">away</span> <span class="op">&lt;-</span> <span class="va">games</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">game_type</span> <span class="op">==</span> <span class="st">'REG'</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">select</span><span class="op">(</span><span class="va">season</span>, <span class="va">week</span>, <span class="va">away_team</span>, <span class="va">result</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">rename</span><span class="op">(</span>team <span class="op">=</span> <span class="va">away_team</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">mutate</span><span class="op">(</span>result <span class="op">=</span> <span class="op">-</span><span class="va">result</span><span class="op">)</span>
<span class="va">away</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="fl">5</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 5 x 4</span>
<span class="co">#&gt;   season  week team  result</span>
<span class="co">#&gt;    &lt;int&gt; &lt;int&gt; &lt;chr&gt;  &lt;int&gt;</span>
<span class="co">#&gt; 1   1999     1 MIN        3</span>
<span class="co">#&gt; 2   1999     1 KC        -3</span>
<span class="co">#&gt; 3   1999     1 PIT       43</span>
<span class="co">#&gt; 4   1999     1 OAK       -4</span>
<span class="co">#&gt; 5   1999     1 BUF      -17</span></pre></div>
<p>For away teams, we need to flip the result since result is given from the perspective of the home team. Now let’s make a columns called <code>win</code> based on the result.</p>
<div class="sourceCode" id="cb35"><pre class="downlit">
<span class="va">results</span> <span class="op">&lt;-</span> <span class="fu">bind_rows</span><span class="op">(</span><span class="va">home</span>, <span class="va">away</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">arrange</span><span class="op">(</span><span class="va">week</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">mutate</span><span class="op">(</span>
    win <span class="op">=</span> <span class="fu">case_when</span><span class="op">(</span>
      <span class="va">result</span> <span class="op">&gt;</span> <span class="fl">0</span> <span class="op">~</span> <span class="fl">1</span>,
      <span class="va">result</span> <span class="op">&lt;</span> <span class="fl">0</span> <span class="op">~</span> <span class="fl">0</span>,
      <span class="va">result</span> <span class="op">==</span> <span class="fl">0</span> <span class="op">~</span> <span class="fl">0.5</span>
    <span class="op">)</span>
  <span class="op">)</span>

<span class="va">results</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">season</span> <span class="op">==</span> <span class="fl">2019</span> <span class="op">&amp;</span> <span class="va">team</span> <span class="op">==</span> <span class="st">'SEA'</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 16 x 5</span>
<span class="co">#&gt;    season  week team  result   win</span>
<span class="co">#&gt;     &lt;int&gt; &lt;int&gt; &lt;chr&gt;  &lt;int&gt; &lt;dbl&gt;</span>
<span class="co">#&gt;  1   2019     1 SEA        1     1</span>
<span class="co">#&gt;  2   2019     2 SEA        2     1</span>
<span class="co">#&gt;  3   2019     3 SEA       -6     0</span>
<span class="co">#&gt;  4   2019     4 SEA       17     1</span>
<span class="co">#&gt;  5   2019     5 SEA        1     1</span>
<span class="co">#&gt;  6   2019     6 SEA        4     1</span>
<span class="co">#&gt;  7   2019     7 SEA      -14     0</span>
<span class="co">#&gt;  8   2019     8 SEA        7     1</span>
<span class="co">#&gt;  9   2019     9 SEA        6     1</span>
<span class="co">#&gt; 10   2019    10 SEA        3     1</span>
<span class="co">#&gt; 11   2019    12 SEA        8     1</span>
<span class="co">#&gt; 12   2019    13 SEA        7     1</span>
<span class="co">#&gt; 13   2019    14 SEA      -16     0</span>
<span class="co">#&gt; 14   2019    15 SEA        6     1</span>
<span class="co">#&gt; 15   2019    16 SEA      -14     0</span>
<span class="co">#&gt; 16   2019    17 SEA       -5     0</span></pre></div>
<p>Doing the <code>results %&gt;% filter(season == 2019 &amp; team == 'SEA')</code> part at the end isn’t actually for saving the data in a new form, but just making sure the previous step did what I wanted. This is a good habit to get into: frequently inspect your data and make sure it looks like you think it should.</p>
<p>Now that we have the dataframe we wanted, we can get team wins by season easily:</p>
<div class="sourceCode" id="cb36"><pre class="downlit">
<span class="va">team_wins</span> <span class="op">&lt;-</span> <span class="va">results</span> <span class="op">%&gt;%</span>
  <span class="fu">group_by</span><span class="op">(</span><span class="va">team</span>, <span class="va">season</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">summarize</span><span class="op">(</span>
    wins <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">win</span><span class="op">)</span>,
    point_diff <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">result</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">ungroup</span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt; `summarise()` regrouping output by 'team' (override with `.groups` argument)</span>

<span class="va">team_wins</span> <span class="op">%&gt;%</span>
  <span class="fu">arrange</span><span class="op">(</span><span class="op">-</span><span class="va">wins</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="fl">5</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 5 x 4</span>
<span class="co">#&gt;   team  season  wins point_diff</span>
<span class="co">#&gt;   &lt;chr&gt;  &lt;int&gt; &lt;dbl&gt;      &lt;int&gt;</span>
<span class="co">#&gt; 1 NE      2007    16        315</span>
<span class="co">#&gt; 2 CAR     2015    15        192</span>
<span class="co">#&gt; 3 GB      2011    15        201</span>
<span class="co">#&gt; 4 PIT     2004    15        121</span>
<span class="co">#&gt; 5 BAL     2019    14        249</span></pre></div>
<p>Again, we’re making sure the data looks like it “should” by checking the 5 seasons with the most wins, and making sure it looks right.</p>
<p>Now that the team-season win and point differential data is ready, we need to go back to the <code>nflfastR</code> data to get EPA/play.</p>
</div>
<div id="get-team-epa-by-season" class="section level3">
<h3 class="hasAnchor">
<a href="#get-team-epa-by-season" class="anchor"></a>Get team EPA by season</h3>
<p>Let’s start by getting data from every season from the <code>nflfastR</code> data repository:</p>
<div class="sourceCode" id="cb37"><pre class="downlit">
<span class="va">seasons</span> <span class="op">&lt;-</span> <span class="fl">1999</span><span class="op">:</span><span class="fl">2019</span>
<span class="va">pbp</span> <span class="op">&lt;-</span> <span class="fu">map_df</span><span class="op">(</span><span class="va">seasons</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span><span class="op">(</span>
    <span class="fu"><a href="https://rdrr.io/r/base/connections.html">url</a></span><span class="op">(</span>
      <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"https://raw.githubusercontent.com/guga31bb/nflfastR-data/master/data/play_by_play_"</span>,<span class="va">x</span>,<span class="st">".rds"</span><span class="op">)</span>
    <span class="op">)</span>
  <span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">rush</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">|</span> <span class="va">pass</span> <span class="op">==</span> <span class="fl">1</span>, <span class="va">week</span> <span class="op">&lt;=</span> <span class="fl">17</span>, <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">epa</span><span class="op">)</span>, <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">posteam</span><span class="op">)</span>, <span class="va">posteam</span> <span class="op">!=</span> <span class="st">""</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">select</span><span class="op">(</span><span class="va">season</span>, <span class="va">posteam</span>, <span class="va">pass</span>, <span class="va">defteam</span>, <span class="va">epa</span><span class="op">)</span>
<span class="op">}</span><span class="op">)</span></pre></div>
<p>I’m being pretty aggressive with dropping rows and columns (<code>filter</code> and <code>select</code>) because otherwise loading this all into memory can be painful on the computer. But this is all we need for what we’re doing. Note that I’m only keeping regular season games here (<code>week &lt;= 17</code>) since this is how this analysis is usually done.</p>
<p>Now we can get EPA/play on offense and defense. Let’s break it out by pass and rush too. I don’t remember how to do some of this so let’s do it in steps. We know we need to group by team, season, and pass, so there’s the beginning:</p>
<div class="sourceCode" id="cb38"><pre class="downlit">
<span class="va">pbp</span> <span class="op">%&gt;%</span>
  <span class="fu">group_by</span><span class="op">(</span><span class="va">posteam</span>, <span class="va">season</span>, <span class="va">pass</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu">summarize</span><span class="op">(</span>epa <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">epa</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="fl">4</span><span class="op">)</span>
<span class="co">#&gt; `summarise()` regrouping output by 'posteam', 'season' (override with `.groups` argument)</span>
<span class="co">#&gt; # A tibble: 4 x 4</span>
<span class="co">#&gt; # Groups:   posteam, season [2]</span>
<span class="co">#&gt;   posteam season  pass     epa</span>
<span class="co">#&gt;   &lt;chr&gt;    &lt;int&gt; &lt;dbl&gt;   &lt;dbl&gt;</span>
<span class="co">#&gt; 1 ARI       1999     0 -0.201 </span>
<span class="co">#&gt; 2 ARI       1999     1 -0.162 </span>
<span class="co">#&gt; 3 ARI       2000     0 -0.242 </span>
<span class="co">#&gt; 4 ARI       2000     1 -0.0678</span></pre></div>
<p>But this makes two rows per team-season. How to get each team-season on the same row? <code>pivot_wider</code> is what we need:</p>
<div class="sourceCode" id="cb39"><pre class="downlit">
<span class="va">pbp</span> <span class="op">%&gt;%</span>
  <span class="fu">group_by</span><span class="op">(</span><span class="va">posteam</span>, <span class="va">season</span>, <span class="va">pass</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu">summarize</span><span class="op">(</span>epa <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">epa</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">pivot_wider</span><span class="op">(</span>names_from <span class="op">=</span> <span class="va">pass</span>, values_from <span class="op">=</span> <span class="va">epa</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="fl">4</span><span class="op">)</span>
<span class="co">#&gt; `summarise()` regrouping output by 'posteam', 'season' (override with `.groups` argument)</span>
<span class="co">#&gt; # A tibble: 4 x 4</span>
<span class="co">#&gt; # Groups:   posteam, season [4]</span>
<span class="co">#&gt;   posteam season    `0`     `1`</span>
<span class="co">#&gt;   &lt;chr&gt;    &lt;int&gt;  &lt;dbl&gt;   &lt;dbl&gt;</span>
<span class="co">#&gt; 1 ARI       1999 -0.201 -0.162 </span>
<span class="co">#&gt; 2 ARI       2000 -0.242 -0.0678</span>
<span class="co">#&gt; 3 ARI       2001 -0.177  0.0740</span>
<span class="co">#&gt; 4 ARI       2002 -0.134 -0.0662</span></pre></div>
<p>This one is hard to wrap my head around so I usually open up the <a href="https://tidyr.tidyverse.org/reference/pivot_wider.html">reference page</a>, read the example, and pray that what I try works. In this case it did. Hooray! This turned our two-lines-per-team dataframe into one, with the 0 column being pass == 0 (run plays) and the 1 column pass == 1.</p>
<p>Now let’s rename to something more sensible and save:</p>
<div class="sourceCode" id="cb40"><pre class="downlit">
<span class="va">offense</span> <span class="op">&lt;-</span> <span class="va">pbp</span> <span class="op">%&gt;%</span>
  <span class="fu">group_by</span><span class="op">(</span><span class="va">posteam</span>, <span class="va">season</span>, <span class="va">pass</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu">summarize</span><span class="op">(</span>epa <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">epa</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">pivot_wider</span><span class="op">(</span>names_from <span class="op">=</span> <span class="va">pass</span>, values_from <span class="op">=</span> <span class="va">epa</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">rename</span><span class="op">(</span>off_pass_epa <span class="op">=</span> <span class="va">`1`</span>, off_rush_epa <span class="op">=</span> <span class="va">`0`</span><span class="op">)</span>
<span class="co">#&gt; `summarise()` regrouping output by 'posteam', 'season' (override with `.groups` argument)</span></pre></div>
<p>Note that variable names that are numbers need to be surrounded in tick marks for this to work.</p>
<p>Now we can repeat the same process for defense:</p>
<div class="sourceCode" id="cb41"><pre class="downlit">
<span class="va">defense</span> <span class="op">&lt;-</span> <span class="va">pbp</span> <span class="op">%&gt;%</span>
  <span class="fu">group_by</span><span class="op">(</span><span class="va">defteam</span>, <span class="va">season</span>, <span class="va">pass</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu">summarize</span><span class="op">(</span>epa <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">epa</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">pivot_wider</span><span class="op">(</span>names_from <span class="op">=</span> <span class="va">pass</span>, values_from <span class="op">=</span> <span class="va">epa</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">rename</span><span class="op">(</span>def_pass_epa <span class="op">=</span> <span class="va">`1`</span>, def_rush_epa <span class="op">=</span> <span class="va">`0`</span><span class="op">)</span>
<span class="co">#&gt; `summarise()` regrouping output by 'defteam', 'season' (override with `.groups` argument)</span></pre></div>
<p>Let’s do another sanity check looking at the top 5 pass offenses and defenses:</p>
<div class="sourceCode" id="cb42"><pre class="downlit">
<span class="co">#top 5 offenses</span>
<span class="va">offense</span> <span class="op">%&gt;%</span>
  <span class="fu">arrange</span><span class="op">(</span><span class="op">-</span><span class="va">off_pass_epa</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="fl">5</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 5 x 4</span>
<span class="co">#&gt; # Groups:   posteam, season [5]</span>
<span class="co">#&gt;   posteam season off_rush_epa off_pass_epa</span>
<span class="co">#&gt;   &lt;chr&gt;    &lt;int&gt;        &lt;dbl&gt;        &lt;dbl&gt;</span>
<span class="co">#&gt; 1 NE        2007      0.00216        0.422</span>
<span class="co">#&gt; 2 IND       2004     -0.00125        0.413</span>
<span class="co">#&gt; 3 GB        2011     -0.114          0.413</span>
<span class="co">#&gt; 4 KC        2018      0.0209         0.349</span>
<span class="co">#&gt; 5 DEN       2013     -0.0296         0.344</span>

<span class="co">#top 5 defenses</span>
<span class="va">defense</span> <span class="op">%&gt;%</span>
  <span class="fu">arrange</span><span class="op">(</span><span class="va">def_pass_epa</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="fl">5</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 5 x 4</span>
<span class="co">#&gt; # Groups:   defteam, season [5]</span>
<span class="co">#&gt;   defteam season def_rush_epa def_pass_epa</span>
<span class="co">#&gt;   &lt;chr&gt;    &lt;int&gt;        &lt;dbl&gt;        &lt;dbl&gt;</span>
<span class="co">#&gt; 1 TB        2002      -0.0755       -0.292</span>
<span class="co">#&gt; 2 NE        2019      -0.164        -0.244</span>
<span class="co">#&gt; 3 JAX       2017      -0.141        -0.224</span>
<span class="co">#&gt; 4 NYJ       2009      -0.103        -0.220</span>
<span class="co">#&gt; 5 LA        2003      -0.0543       -0.214</span></pre></div>
<p>The top pass defenses (2002 TB, 2017 JAX, 2019 NE) and offenses (2007 Pats, 2004 Colts, 2011 Packers) definitely check out!</p>
</div>
<div id="fix-team-names-and-join" class="section level3">
<h3 class="hasAnchor">
<a href="#fix-team-names-and-join" class="anchor"></a>Fix team names and join</h3>
<p>Now we’re ready to bind it all together. Actually, let’s make sure all the team names are ready too.</p>
<div class="sourceCode" id="cb43"><pre class="downlit">
<span class="va">team_wins</span> <span class="op">%&gt;%</span>
  <span class="fu">group_by</span><span class="op">(</span><span class="va">team</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">summarize</span><span class="op">(</span>n<span class="op">=</span><span class="fu">n</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">arrange</span><span class="op">(</span><span class="va">n</span><span class="op">)</span>
<span class="co">#&gt; `summarise()` ungrouping output (override with `.groups` argument)</span>
<span class="co">#&gt; # A tibble: 35 x 2</span>
<span class="co">#&gt;    team      n</span>
<span class="co">#&gt;    &lt;chr&gt; &lt;int&gt;</span>
<span class="co">#&gt;  1 LV        1</span>
<span class="co">#&gt;  2 LAC       4</span>
<span class="co">#&gt;  3 LA        5</span>
<span class="co">#&gt;  4 STL      17</span>
<span class="co">#&gt;  5 SD       18</span>
<span class="co">#&gt;  6 HOU      19</span>
<span class="co">#&gt;  7 OAK      21</span>
<span class="co">#&gt;  8 ARI      22</span>
<span class="co">#&gt;  9 ATL      22</span>
<span class="co">#&gt; 10 BAL      22</span>
<span class="co">#&gt; # … with 25 more rows</span></pre></div>
<p>Nope, not yet, we need to fix the Raiders, Rams, and Chargers, which are LV, LA, and LAC in <code>nflfastR</code>.</p>
<div class="sourceCode" id="cb44"><pre class="downlit">
<span class="va">team_wins</span> <span class="op">&lt;-</span> <span class="va">team_wins</span> <span class="op">%&gt;%</span>
  <span class="fu">mutate</span><span class="op">(</span>
    team <span class="op">=</span> <span class="fu">case_when</span><span class="op">(</span>
      <span class="va">team</span> <span class="op">==</span> <span class="st">'OAK'</span> <span class="op">~</span> <span class="st">'LV'</span>,
      <span class="va">team</span> <span class="op">==</span> <span class="st">'SD'</span> <span class="op">~</span> <span class="st">'LAC'</span>,
      <span class="va">team</span> <span class="op">==</span> <span class="st">'STL'</span> <span class="op">~</span> <span class="st">'LA'</span>,
      <span class="cn">TRUE</span> <span class="op">~</span> <span class="va">team</span>
    <span class="op">)</span>
  <span class="op">)</span></pre></div>
<p>The <code>TRUE</code> statement at the bottom says that if none of the above cases are found, keep team the same. Let’s make sure this worked:</p>
<div class="sourceCode" id="cb45"><pre class="downlit">
<span class="va">team_wins</span> <span class="op">%&gt;%</span>
  <span class="fu">group_by</span><span class="op">(</span><span class="va">team</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">summarize</span><span class="op">(</span>n<span class="op">=</span><span class="fu">n</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">arrange</span><span class="op">(</span><span class="va">n</span><span class="op">)</span>
<span class="co">#&gt; `summarise()` ungrouping output (override with `.groups` argument)</span>
<span class="co">#&gt; # A tibble: 32 x 2</span>
<span class="co">#&gt;    team      n</span>
<span class="co">#&gt;    &lt;chr&gt; &lt;int&gt;</span>
<span class="co">#&gt;  1 HOU      19</span>
<span class="co">#&gt;  2 ARI      22</span>
<span class="co">#&gt;  3 ATL      22</span>
<span class="co">#&gt;  4 BAL      22</span>
<span class="co">#&gt;  5 BUF      22</span>
<span class="co">#&gt;  6 CAR      22</span>
<span class="co">#&gt;  7 CHI      22</span>
<span class="co">#&gt;  8 CIN      22</span>
<span class="co">#&gt;  9 CLE      22</span>
<span class="co">#&gt; 10 DAL      22</span>
<span class="co">#&gt; # … with 22 more rows</span></pre></div>
<p>HOU has 3 fewer seasons because it didn’t exist from 1999 through 2001, which is fine, and all the other team names have 22 seasons like they should. Okay NOW we can join:</p>
<div class="sourceCode" id="cb46"><pre class="downlit">
<span class="va">data</span> <span class="op">&lt;-</span> <span class="va">team_wins</span> <span class="op">%&gt;%</span>
  <span class="fu">left_join</span><span class="op">(</span><span class="va">offense</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'team'</span> <span class="op">=</span> <span class="st">'posteam'</span>, <span class="st">'season'</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">left_join</span><span class="op">(</span><span class="va">defense</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'team'</span> <span class="op">=</span> <span class="st">'defteam'</span>, <span class="st">'season'</span><span class="op">)</span><span class="op">)</span>

<span class="va">data</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">team</span> <span class="op">==</span> <span class="st">'SEA'</span> <span class="op">&amp;</span> <span class="va">season</span> <span class="op">&gt;=</span> <span class="fl">2012</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 9 x 8</span>
<span class="co">#&gt;   team  season  wins point_diff off_rush_epa off_pass_epa def_rush_epa</span>
<span class="co">#&gt;   &lt;chr&gt;  &lt;int&gt; &lt;dbl&gt;      &lt;int&gt;        &lt;dbl&gt;        &lt;dbl&gt;        &lt;dbl&gt;</span>
<span class="co">#&gt; 1 SEA     2012  11          167     -0.00475       0.213       -0.0738</span>
<span class="co">#&gt; 2 SEA     2013  13          186     -0.101         0.188       -0.126 </span>
<span class="co">#&gt; 3 SEA     2014  12          140      0.0216        0.139       -0.231 </span>
<span class="co">#&gt; 4 SEA     2015  10          146     -0.102         0.249       -0.148 </span>
<span class="co">#&gt; 5 SEA     2016  10.5         62     -0.126         0.102       -0.207 </span>
<span class="co">#&gt; 6 SEA     2017   9           34     -0.189         0.0569      -0.122 </span>
<span class="co">#&gt; 7 SEA     2018  10           81     -0.0273        0.210       -0.131 </span>
<span class="co">#&gt; 8 SEA     2019  11            7     -0.136         0.120       -0.0930</span>
<span class="co">#&gt; 9 SEA     2020  NA           NA     NA            NA           NA     </span>
<span class="co">#&gt; # … with 1 more variable: def_pass_epa &lt;dbl&gt;</span></pre></div>
<p>Now we’re getting really close to doing what we want! Next we need to create new columns for prior year EPA, and let’s do point differential too.</p>
<div class="sourceCode" id="cb47"><pre class="downlit">
<span class="va">data</span> <span class="op">&lt;-</span> <span class="va">data</span> <span class="op">%&gt;%</span> 
  <span class="fu">arrange</span><span class="op">(</span><span class="va">team</span>, <span class="va">season</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">mutate</span><span class="op">(</span>
    prior_off_rush_epa <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/lag.html">lag</a></span><span class="op">(</span><span class="va">off_rush_epa</span><span class="op">)</span>,
    prior_off_pass_epa <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/lag.html">lag</a></span><span class="op">(</span><span class="va">off_pass_epa</span><span class="op">)</span>,
    prior_def_rush_epa <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/lag.html">lag</a></span><span class="op">(</span><span class="va">def_rush_epa</span><span class="op">)</span>,
    prior_def_pass_epa <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/lag.html">lag</a></span><span class="op">(</span><span class="va">def_pass_epa</span><span class="op">)</span>,
    prior_point_diff <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/lag.html">lag</a></span><span class="op">(</span><span class="va">point_diff</span><span class="op">)</span>
  <span class="op">)</span>

<span class="va">data</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="fl">5</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 5 x 13</span>
<span class="co">#&gt;   team  season  wins point_diff off_rush_epa off_pass_epa def_rush_epa</span>
<span class="co">#&gt;   &lt;chr&gt;  &lt;int&gt; &lt;dbl&gt;      &lt;int&gt;        &lt;dbl&gt;        &lt;dbl&gt;        &lt;dbl&gt;</span>
<span class="co">#&gt; 1 ARI     1999     6       -137       -0.201      -0.162      -0.00937</span>
<span class="co">#&gt; 2 ARI     2000     3       -233       -0.242      -0.0678      0.0286 </span>
<span class="co">#&gt; 3 ARI     2001     7        -48       -0.177       0.0740     -0.0689 </span>
<span class="co">#&gt; 4 ARI     2002     5       -155       -0.134      -0.0662     -0.0192 </span>
<span class="co">#&gt; 5 ARI     2003     4       -227       -0.219      -0.120      -0.0627 </span>
<span class="co">#&gt; # … with 6 more variables: def_pass_epa &lt;dbl&gt;, prior_off_rush_epa &lt;dbl&gt;,</span>
<span class="co">#&gt; #   prior_off_pass_epa &lt;dbl&gt;, prior_def_rush_epa &lt;dbl&gt;,</span>
<span class="co">#&gt; #   prior_def_pass_epa &lt;dbl&gt;, prior_point_diff &lt;int&gt;</span></pre></div>
<p>Finally! Now we have the data in place and can start doing things with it.</p>
</div>
<div id="correlations-and-regressions" class="section level3">
<h3 class="hasAnchor">
<a href="#correlations-and-regressions" class="anchor"></a>Correlations and regressions</h3>
<div class="sourceCode" id="cb48"><pre class="downlit">
<span class="va">data</span> <span class="op">%&gt;%</span> 
  <span class="fu">select</span><span class="op">(</span><span class="op">-</span><span class="va">team</span>, <span class="op">-</span><span class="va">season</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/cor.html">cor</a></span><span class="op">(</span>use<span class="op">=</span><span class="st">"complete.obs"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span>
<span class="co">#&gt;                     wins point_diff off_rush_epa off_pass_epa def_rush_epa</span>
<span class="co">#&gt; wins                1.00       0.92         0.43         0.70        -0.29</span>
<span class="co">#&gt; point_diff          0.92       1.00         0.48         0.76        -0.33</span>
<span class="co">#&gt; off_rush_epa        0.43       0.48         1.00         0.40         0.06</span>
<span class="co">#&gt; off_pass_epa        0.70       0.76         0.40         1.00        -0.02</span>
<span class="co">#&gt; def_rush_epa       -0.29      -0.33         0.06        -0.02         1.00</span>
<span class="co">#&gt; def_pass_epa       -0.57      -0.62        -0.04        -0.10         0.30</span>
<span class="co">#&gt; prior_off_rush_epa  0.23       0.26         0.33         0.22         0.02</span>
<span class="co">#&gt; prior_off_pass_epa  0.29       0.32         0.18         0.46        -0.01</span>
<span class="co">#&gt; prior_def_rush_epa -0.11      -0.14         0.03        -0.04         0.26</span>
<span class="co">#&gt; prior_def_pass_epa -0.18      -0.20        -0.07        -0.05         0.06</span>
<span class="co">#&gt; prior_point_diff    0.36       0.41         0.22         0.36        -0.09</span>
<span class="co">#&gt;                    def_pass_epa prior_off_rush_epa prior_off_pass_epa</span>
<span class="co">#&gt; wins                      -0.57               0.23               0.29</span>
<span class="co">#&gt; point_diff                -0.62               0.26               0.32</span>
<span class="co">#&gt; off_rush_epa              -0.04               0.33               0.18</span>
<span class="co">#&gt; off_pass_epa              -0.10               0.22               0.46</span>
<span class="co">#&gt; def_rush_epa               0.30               0.02              -0.01</span>
<span class="co">#&gt; def_pass_epa               1.00              -0.10               0.00</span>
<span class="co">#&gt; prior_off_rush_epa        -0.10               1.00               0.40</span>
<span class="co">#&gt; prior_off_pass_epa         0.00               0.40               1.00</span>
<span class="co">#&gt; prior_def_rush_epa         0.14               0.06              -0.02</span>
<span class="co">#&gt; prior_def_pass_epa         0.27              -0.01              -0.09</span>
<span class="co">#&gt; prior_point_diff          -0.19               0.47               0.76</span>
<span class="co">#&gt;                    prior_def_rush_epa prior_def_pass_epa prior_point_diff</span>
<span class="co">#&gt; wins                            -0.11              -0.18             0.36</span>
<span class="co">#&gt; point_diff                      -0.14              -0.20             0.41</span>
<span class="co">#&gt; off_rush_epa                     0.03              -0.07             0.22</span>
<span class="co">#&gt; off_pass_epa                    -0.04              -0.05             0.36</span>
<span class="co">#&gt; def_rush_epa                     0.26               0.06            -0.09</span>
<span class="co">#&gt; def_pass_epa                     0.14               0.27            -0.19</span>
<span class="co">#&gt; prior_off_rush_epa               0.06              -0.01             0.47</span>
<span class="co">#&gt; prior_off_pass_epa              -0.02              -0.09             0.76</span>
<span class="co">#&gt; prior_def_rush_epa               1.00               0.31            -0.34</span>
<span class="co">#&gt; prior_def_pass_epa               0.31               1.00            -0.60</span>
<span class="co">#&gt; prior_point_diff                -0.34              -0.60             1.00</span></pre></div>
<p>We’ve covered <code>select</code>, but here we see a new use where a minus sign de-selects variables (we need to de-select team name for correlation to work because it doesn’t work for character strings, and correlation with the season number itself is meaningless). We’ve run the correlation on this dataframe, removing missing values, and then rounding to 2 digits. Not surprisingly, we see that wins in the current season are more strongly related to passing offense EPA than rushing EPA or defense EPA, and prior offense carries more predictive power than prior defense. Pass offense is more stable year to year (<code>0.46</code>) than rush offense (<code>0.33</code>), pass defense (<code>0.27</code>), or rush defense (<code>0.26</code>).</p>
<p>I’m actually surprised that the values for passing offense aren’t higher relative to the others. Maybe it was because most of our prior results come from the <code>nflscrapR</code> era (2009 - 2019)? Let’s check what this looks like since 2009 relative to earlier seasons:</p>
<div class="sourceCode" id="cb49"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/base/message.html">message</a></span><span class="op">(</span><span class="st">"2009 through 2019"</span><span class="op">)</span>
<span class="co">#&gt; 2009 through 2019</span>
<span class="va">data</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">season</span> <span class="op">&gt;=</span> <span class="fl">2009</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">select</span><span class="op">(</span><span class="va">wins</span>, <span class="va">point_diff</span>, <span class="va">off_pass_epa</span>, <span class="va">off_rush_epa</span>, <span class="va">prior_point_diff</span>, <span class="va">prior_off_pass_epa</span>, <span class="va">prior_off_rush_epa</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/cor.html">cor</a></span><span class="op">(</span>use<span class="op">=</span><span class="st">"complete.obs"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span>
<span class="co">#&gt;                    wins point_diff off_pass_epa off_rush_epa prior_point_diff</span>
<span class="co">#&gt; wins               1.00       0.91         0.73         0.40             0.43</span>
<span class="co">#&gt; point_diff         0.91       1.00         0.79         0.47             0.44</span>
<span class="co">#&gt; off_pass_epa       0.73       0.79         1.00         0.37             0.39</span>
<span class="co">#&gt; off_rush_epa       0.40       0.47         0.37         1.00             0.19</span>
<span class="co">#&gt; prior_point_diff   0.43       0.44         0.39         0.19             1.00</span>
<span class="co">#&gt; prior_off_pass_epa 0.34       0.36         0.45         0.11             0.78</span>
<span class="co">#&gt; prior_off_rush_epa 0.24       0.25         0.16         0.24             0.46</span>
<span class="co">#&gt;                    prior_off_pass_epa prior_off_rush_epa</span>
<span class="co">#&gt; wins                             0.34               0.24</span>
<span class="co">#&gt; point_diff                       0.36               0.25</span>
<span class="co">#&gt; off_pass_epa                     0.45               0.16</span>
<span class="co">#&gt; off_rush_epa                     0.11               0.24</span>
<span class="co">#&gt; prior_point_diff                 0.78               0.46</span>
<span class="co">#&gt; prior_off_pass_epa               1.00               0.35</span>
<span class="co">#&gt; prior_off_rush_epa               0.35               1.00</span></pre></div>
<div class="sourceCode" id="cb50"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/base/message.html">message</a></span><span class="op">(</span><span class="st">"1999 through 2008"</span><span class="op">)</span>
<span class="co">#&gt; 1999 through 2008</span>
<span class="va">data</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">season</span> <span class="op">&lt;</span> <span class="fl">2009</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">select</span><span class="op">(</span><span class="va">wins</span>, <span class="va">point_diff</span>, <span class="va">off_pass_epa</span>, <span class="va">off_rush_epa</span>, <span class="va">prior_point_diff</span>, <span class="va">prior_off_pass_epa</span>, <span class="va">prior_off_rush_epa</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/cor.html">cor</a></span><span class="op">(</span>use<span class="op">=</span><span class="st">"complete.obs"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span>
<span class="co">#&gt;                    wins point_diff off_pass_epa off_rush_epa prior_point_diff</span>
<span class="co">#&gt; wins               1.00       0.92         0.68         0.47             0.28</span>
<span class="co">#&gt; point_diff         0.92       1.00         0.73         0.51             0.36</span>
<span class="co">#&gt; off_pass_epa       0.68       0.73         1.00         0.47             0.34</span>
<span class="co">#&gt; off_rush_epa       0.47       0.51         0.47         1.00             0.25</span>
<span class="co">#&gt; prior_point_diff   0.28       0.36         0.34         0.25             1.00</span>
<span class="co">#&gt; prior_off_pass_epa 0.23       0.28         0.45         0.30             0.74</span>
<span class="co">#&gt; prior_off_rush_epa 0.23       0.28         0.30         0.42             0.50</span>
<span class="co">#&gt;                    prior_off_pass_epa prior_off_rush_epa</span>
<span class="co">#&gt; wins                             0.23               0.23</span>
<span class="co">#&gt; point_diff                       0.28               0.28</span>
<span class="co">#&gt; off_pass_epa                     0.45               0.30</span>
<span class="co">#&gt; off_rush_epa                     0.30               0.42</span>
<span class="co">#&gt; prior_point_diff                 0.74               0.50</span>
<span class="co">#&gt; prior_off_pass_epa               1.00               0.48</span>
<span class="co">#&gt; prior_off_rush_epa               0.48               1.00</span></pre></div>
<p>Yep, that seems to be the case. So in the more recent period, passing offense has become slightly more stable but more predictive of following-year success, while at the same time rushing offense has become substantially less stable and less predictive of future team success.</p>
<p>Now let’s do a basic regression of wins on prior offense and defense EPA/play. Maybe we should only look at this more recent period to fit our model since it’s more relevant for 2020. In the real world, we would be more rigorous about making decisions like this, but let’s proceed anyway.</p>
<div class="sourceCode" id="cb51"><pre class="downlit">
<span class="va">data</span> <span class="op">&lt;-</span> <span class="va">data</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">season</span> <span class="op">&gt;=</span> <span class="fl">2009</span><span class="op">)</span>

<span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">wins</span> <span class="op">~</span> <span class="va">prior_off_pass_epa</span>  <span class="op">+</span> <span class="va">prior_off_rush_epa</span> <span class="op">+</span> <span class="va">prior_def_pass_epa</span> <span class="op">+</span> <span class="va">prior_def_rush_epa</span>, data <span class="op">=</span> <span class="va">data</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">fit</span><span class="op">)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Call:</span>
<span class="co">#&gt; lm(formula = wins ~ prior_off_pass_epa + prior_off_rush_epa + </span>
<span class="co">#&gt;     prior_def_pass_epa + prior_def_rush_epa, data = data)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Residuals:</span>
<span class="co">#&gt;    Min     1Q Median     3Q    Max </span>
<span class="co">#&gt; -7.720 -1.861  0.114  2.165  7.108 </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Coefficients:</span>
<span class="co">#&gt;                    Estimate Std. Error t value             Pr(&gt;|t|)    </span>
<span class="co">#&gt; (Intercept)          7.9120     0.4011  19.726 &lt; 0.0000000000000002 ***</span>
<span class="co">#&gt; prior_off_pass_epa   6.4692     1.2921   5.007          0.000000882 ***</span>
<span class="co">#&gt; prior_off_rush_epa   6.5021     2.3488   2.768              0.00594 ** </span>
<span class="co">#&gt; prior_def_pass_epa  -3.5875     1.7354  -2.067              0.03945 *  </span>
<span class="co">#&gt; prior_def_rush_epa  -6.0287     2.4400  -2.471              0.01396 *  </span>
<span class="co">#&gt; ---</span>
<span class="co">#&gt; Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Residual standard error: 2.823 on 347 degrees of freedom</span>
<span class="co">#&gt;   (32 observations deleted due to missingness)</span>
<span class="co">#&gt; Multiple R-squared:  0.1684, Adjusted R-squared:  0.1589 </span>
<span class="co">#&gt; F-statistic: 17.57 on 4 and 347 DF,  p-value: 0.0000000000003811</span></pre></div>
<p>I’m actually pretty surprised passing offense isn’t higher here. How does this compare to simply using point differential?</p>
<div class="sourceCode" id="cb52"><pre class="downlit">
<span class="va">fit2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">wins</span> <span class="op">~</span> <span class="va">prior_point_diff</span>, data <span class="op">=</span> <span class="va">data</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">fit2</span><span class="op">)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Call:</span>
<span class="co">#&gt; lm(formula = wins ~ prior_point_diff, data = data)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Residuals:</span>
<span class="co">#&gt;     Min      1Q  Median      3Q     Max </span>
<span class="co">#&gt; -7.1042 -1.8347  0.1688  2.0713  7.4547 </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Coefficients:</span>
<span class="co">#&gt;                  Estimate Std. Error t value            Pr(&gt;|t|)    </span>
<span class="co">#&gt; (Intercept)      8.000000   0.148515  53.867 &lt;0.0000000000000002 ***</span>
<span class="co">#&gt; prior_point_diff 0.012990   0.001468   8.847 &lt;0.0000000000000002 ***</span>
<span class="co">#&gt; ---</span>
<span class="co">#&gt; Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Residual standard error: 2.786 on 350 degrees of freedom</span>
<span class="co">#&gt;   (32 observations deleted due to missingness)</span>
<span class="co">#&gt; Multiple R-squared:  0.1827, Adjusted R-squared:  0.1804 </span>
<span class="co">#&gt; F-statistic: 78.26 on 1 and 350 DF,  p-value: &lt; 0.00000000000000022</span></pre></div>
<p>So R2 is somewhat higher for just point differential. This isn’t surprising as we’ve thrown away special teams plays and haven’t attempted to make any adjustments for things like fumble luck that we know can improve EPA’s predictive power.</p>
</div>
<div id="predictions" class="section level3">
<h3 class="hasAnchor">
<a href="#predictions" class="anchor"></a>Predictions</h3>
<p>Now let’s get the predictions from the EPA model:</p>
<div class="sourceCode" id="cb53"><pre class="downlit">
<span class="va">preds</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">fit</span>, <span class="va">data</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">season</span> <span class="op">==</span> <span class="fl">2020</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="co">#was just a vector, need a tibble to bind</span>
  <span class="fu">as_tibble</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="co">#make the column name make sense</span>
  <span class="fu">rename</span><span class="op">(</span>prediction <span class="op">=</span> <span class="va">value</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="co">#get names</span>
  <span class="fu">bind_cols</span><span class="op">(</span>
    <span class="va">data</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">season</span> <span class="op">==</span> <span class="fl">2020</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu">select</span><span class="op">(</span><span class="va">team</span><span class="op">)</span>
  <span class="op">)</span>

<span class="va">preds</span> <span class="op">%&gt;%</span>
  <span class="fu">arrange</span><span class="op">(</span><span class="op">-</span><span class="va">prediction</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="fl">5</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 5 x 2</span>
<span class="co">#&gt;   prediction team </span>
<span class="co">#&gt;        &lt;dbl&gt; &lt;chr&gt;</span>
<span class="co">#&gt; 1       11.5 BAL  </span>
<span class="co">#&gt; 2       10.2 SF   </span>
<span class="co">#&gt; 3        9.7 NE   </span>
<span class="co">#&gt; 4        9.7 NO   </span>
<span class="co">#&gt; 5        9.6 DAL</span></pre></div>
<p>This mostly checks out.</p>
<p>What if we just used simple point differential to predict?</p>
<div class="sourceCode" id="cb54"><pre class="downlit">
<span class="va">preds2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">fit2</span>, <span class="va">data</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">season</span> <span class="op">==</span> <span class="fl">2020</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="co">#was just a vector, need a tibble to bind</span>
  <span class="fu">as_tibble</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="co">#make the column name make sense</span>
  <span class="fu">rename</span><span class="op">(</span>prediction <span class="op">=</span> <span class="va">value</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="co">#get names</span>
  <span class="fu">bind_cols</span><span class="op">(</span>
    <span class="va">data</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">season</span> <span class="op">==</span> <span class="fl">2020</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu">select</span><span class="op">(</span><span class="va">team</span><span class="op">)</span>
  <span class="op">)</span>

<span class="va">preds2</span> <span class="op">%&gt;%</span>
  <span class="fu">arrange</span><span class="op">(</span><span class="op">-</span><span class="va">prediction</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="fl">5</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 5 x 2</span>
<span class="co">#&gt;   prediction team </span>
<span class="co">#&gt;        &lt;dbl&gt; &lt;chr&gt;</span>
<span class="co">#&gt; 1       11.2 BAL  </span>
<span class="co">#&gt; 2       10.5 NE   </span>
<span class="co">#&gt; 3       10.2 SF   </span>
<span class="co">#&gt; 4        9.9 KC   </span>
<span class="co">#&gt; 5        9.5 DAL</span></pre></div>
<p>Not surprisingly, this looks pretty similar. These are very basic models that don’t incorporate schedule, roster changes, etc. For example, a better model would take into account Tom Brady no longer playing for the Patriots. But hopefully this has been useful!</p>
</div>
</div>
<div id="next-steps" class="section level2">
<h2 class="hasAnchor">
<a href="#next-steps" class="anchor"></a>Next Steps</h2>
<p>You now should know enough to be able to tackle a great deal of questions using <code>nflfastR</code> data. A good way to build up skills is to take interesting things you see and try to replicate them (for making figures, this will also involve a heavy dose of googling stuff).</p>
<p>Looking at others’ code is also a good way to learn. One option is to look through the <code>nflfastR</code> code base, much of which you should now understand what it’s doing. For example, <a href="https://github.com/mrcaseb/nflfastR/blob/master/R/helper_add_nflscrapr_mutations.R">here is the function that cleans up the data and prepares it for later stages</a>: there’s a heavy dose of <code>mutate</code>, <code>group_by</code>, <code>arrange</code>, <code>lag</code>, <code>if_else</code>, and <code>case_when</code>.</p>
<div id="resources-the-gold-standards" class="section level3">
<h3 class="hasAnchor">
<a href="#resources-the-gold-standards" class="anchor"></a>Resources: The gold standards</h3>
<p>This is an R package so this section is pretty R heavy.</p>
<ul>
<li><a href="https://r4ds.had.co.nz/explore-intro.html">Introduction to R (<strong>recommended</strong>)</a></li>
<li>
<a href="https://www.opensourcefootball.com/">Open Source Football</a>: Mix of R and Python</li>
<li>
<a href="https://themockup.blog/">The Mockup Blog (Thomas Mock)</a>: Invaluable resource for making cool stuff in R</li>
</ul>
</div>
<div id="code-examples-r" class="section level3">
<h3 class="hasAnchor">
<a href="#code-examples-r" class="anchor"></a>Code examples: R</h3>
<ul>
<li><a href="https://github.com/leesharpe/nfldata/blob/master/RSTUDIO-INTRO.md">Lee Sharpe: basic intro to R and RStudio</a></li>
<li><a href="https://github.com/leesharpe/nfldata">Lee Sharpe: lots of useful NFL / nflscrapR code</a></li>
<li><a href="https://github.com/leesharpe/nfldata/blob/master/UPDATING-NFLSCRAPR.md">Lee Sharpe: how to update current season games</a></li>
<li><a href="https://t.co/gxDDhOYhcI">Josh Hermsmeyer: Getting Started with R for NFL Analysis</a></li>
<li><a href="https://slavin22.github.io/SFB9-Positional-Tiers/Guide.nb">Slavin: visualizing positional tiers in SFB9</a></li>
<li><a href="https://github.com/ryurko/nflscrapR-data/tree/master/R">Ron Yurko: assorted examples</a></li>
<li><a href="https://github.com/dhouston890/cowboys-stats/blob/master/playmaking_epa_pbp.R">CowboysStats: defensive playmaking EPA</a></li>
<li><a href="https://github.com/statsbylopez/BlogPosts/blob/master/scrapr-data.R">Michael Lopez: function to sample plays</a></li>
<li><a href="https://statsbylopez.netlify.com/post/r-for-nfl-analysis/">Michael Lopez: R for NFL analysis (presentation to club staffers)</a></li>
<li><a href="https://gist.github.com/wessonmo/45781bd25a74e8097e0c8bc8fbacf796">Mitchell Wesson: QB hits investigation</a></li>
<li><a href="https://gist.github.com/wessonmo/ef44ea9873d70f816454cb88b86dcce6">Mitchell Wesson: Investigation of the nflscrapR EP model</a></li>
<li><a href="https://github.com/whoffman21279/Steelers/blob/master/receiving_stats">WHoffman: graphs for receivers (aDoT, success rate, and more)</a></li>
<li><a href="https://gist.github.com/ChiBearsStats/dac3266037797032a23f38fd9d64d6a8#file-adjustedthirddowns-txt">ChiBearsStats: investigation of 3rd downs vs offensive efficiency</a></li>
<li><a href="https://gist.github.com/ChiBearsStats/78e33baeed3cd6d3cac0040b47d4ec69">ChiBearsStats: the insignificance of field goal kicking</a></li>
</ul>
</div>
<div id="more-data-sources" class="section level3">
<h3 class="hasAnchor">
<a href="#more-data-sources" class="anchor"></a>More data sources</h3>
<ul>
<li><a href="https://github.com/leesharpe/nfldata/blob/master/DATASETS.md">Lee Sharpe: Draft Picks, Draft Values, Games, Logos, Rosters, Standings</a></li>
<li><a href="https://github.com/greerre/pfr_metadata_pull">greerre: how to get .csv file of weather &amp; stadium data from PFR in python</a></li>
<li><a href="https://gist.github.com/spfleming/2527a6ca2b940af2a8aa1fee9320171d">Parker Fleming: Introduction to College Football Data with R and cfbscrapR</a></li>
</ul>
</div>
<div id="other-code-examples-python" class="section level3">
<h3 class="hasAnchor">
<a href="#other-code-examples-python" class="anchor"></a>Other code examples: Python</h3>
<ul>
<li><a href="https://gist.github.com/Deryck97/dff8d33e9f841568201a2a0d5519ac5e">Deryck97: nflfastR Python Guide</a></li>
<li><a href="https://colab.research.google.com/github/nickwan/colab_nflfastR/blob/master/nflfastR_starter.ipynb">Nick Wan: nflfastR Python Colab Guide</a></li>
<li><a href="https://github.com/jezlax/sports_analytics/blob/master/animated_nfl_scatter.py">Cory Jez: animated plot</a></li>
<li><a href="https://gist.github.com/903124/6693fdf6b991437a6d6ef9c5d935c83b">903124S: Sampling EP</a></li>
<li><a href="https://gist.github.com/903124/d304f76688b0699497a35b61b6d1e267">903124S: estimating EPA using nfldb</a></li>
<li><a href="https://gist.github.com/903124/3c6f0dc0a100d78b8622573ef4c504f5">903124S: estimate EPA for college football</a></li>
<li>Blake Atkinson: explosiveness <a href="https://medium.com/@BlakeAtkinson/the-2018-kansas-city-chiefs-and-an-explosiveness-metric-in-football-c3b3fd447d73">blog post</a> and <a href="https://github.com/btatkinson/yard_value/blob/master/yard_value.ipynb">python code</a>
</li>
<li>Blake Atkinson: player type visualizations <a href="https://medium.com/@BlakeAtkinson/visualizing-different-nfl-player-styles-88ef31420539">blog post</a> and <a href="https://github.com/btatkinson/player_vectors/blob/master/player_vectors.ipynb">python code</a>
</li>
</ul>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by <a href="https://twitter.com/mrcaseb">Sebastian Carl</a>, <a href="https://twitter.com/benbbaldwin">Ben Baldwin</a>.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  
<script src="https://cdnjs.cloudflare.com/ajax/libs/docsearch.js/2.6.1/docsearch.min.js" integrity="sha256-GKvGqXDznoRYHCwKXGnuchvKSwmx9SRMrZOTh2g4Sb0=" crossorigin="anonymous"></script><script>
  docsearch({
    
    
    apiKey: 'e3fe78f73c8f37b971f8119095349ecb',
    indexName: 'nflfastr',
    inputSelector: 'input#search-input.form-control',
    transformData: function(hits) {
      return hits.map(function (hit) {
        hit.url = updateHitURL(hit);
        return hit;
      });
    }
  });
</script>
</body>
</html>
