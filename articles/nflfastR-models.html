<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>nflfastR EP, WP, and CP models • nflfastR</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/yeti/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="nflfastR EP, WP, and CP models">
<meta property="og:description" content="nflfastR">
<meta property="og:image" content="https://raw.githubusercontent.com/mrcaseb/nflfastR/master/man/figures/card.png">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:creator" content="@nflfastR">
<meta name="twitter:site" content="@nflfastR">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">nflfastR</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">2.0.6</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/beginners_guide.html">A beginner's guide to nflfastR</a>
    </li>
    <li>
      <a href="../articles/examples.html">Examples</a>
    </li>
    <li>
      <a href="../articles/nflfastR-models.html">nflfastR EP, WP, and CP models</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="http://twitter.com/nflfastR">
    <span class="fab fa fab fa-twitter fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="https://github.com/mrcaseb/nflfastR/">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="nflfastR-models_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>nflfastR EP, WP, and CP models</h1>
                        <h4 class="author">Ben Baldwin</h4>
            
      
      <small class="dont-index">Source: <a href="https://github.com/mrcaseb/nflfastR/blob/master/vignettes/nflfastR-models.Rmd"><code>vignettes/nflfastR-models.Rmd</code></a></small>
      <div class="hidden name"><code>nflfastR-models.Rmd</code></div>

    </div>

    
    
<div id="about" class="section level2">
<h2 class="hasAnchor">
<a href="#about" class="anchor"></a>About</h2>
<p>This page describes the nflfastR Expected Points (EP), Win Probability (WP), and Completion Percentage (CP) models before showing that they are well calibrated using the procedure <a href="https://arxiv.org/pdf/1802.00998.pdf">introduced by Yurko, Ventura, and Horowitz</a>. Because the 2020 season will mark 22 seasons of nflfastR data, the main purpose behind creating new models for EP and WP was to build in era adjustments to fascilitate better cross-era comparisons. However, we also discovered that switching to tree-based methods could improve model calibration, especially for end-of-half situations with complicated nonlinear interactions between variables. Because we are introducing new models, we compare our calibation results to nflscrapR to show that these new models are somewhat better calibrated. If they weren’t, there would be no point in updating the models!</p>
<p>nflfastR switching from the nflscrapR EP and WP models to its own model should not be thought of as a criticism of nflscrapR: the improvements are relatively minor and nflscrapR provided the code base to perform much of this analysis, breaking new ground in the process.</p>
</div>
<div id="model-features" class="section level2">
<h2 class="hasAnchor">
<a href="#model-features" class="anchor"></a>Model features</h2>
<p>The EP, WP, and CP models are trained using xgboost, which uses training data to create <a href="https://xgboost.readthedocs.io/en/latest/tutorials/model.html">decision trees</a>.</p>
<p><strong>EP model features</strong></p>
<ul>
<li>Seconds remaining in half</li>
<li>Yard line</li>
<li>Whether possession team is at home</li>
<li>Roof type: retractable, dome, or outdoors</li>
<li>Down</li>
<li>Yards to go</li>
<li>Era: 1999-2001 (pre-expansion), 2002-2005 (pre-CPOE), 2006-2013 (pre-LOB rules change), 2014-2017, 2018 and beyond</li>
<li>Week (the model is trained on regular season only, so for playoff games, we impute week = 17)</li>
<li>Timeouts remaining for each team</li>
</ul>
<p><strong>WP model features</strong></p>
<ul>
<li>Seconds remaining in half</li>
<li>Seconds remaining in game</li>
<li>Yard line</li>
<li>Expected Points</li>
<li>Score differential</li>
<li>Ratio of expected score differential (expected points + point differential) to time remaining (feature borrowed from nflscrapR)</li>
<li>Down</li>
<li>Yards to go</li>
<li>Timeouts remaining for each team</li>
<li>Whether team will receive 2nd half kickoff</li>
<li>Whether possession team is at home</li>
<li>[Model with Vegas line only: point spread * log(3600 / (50 + (seconds elapsed in game))]</li>
</ul>
<p><strong>CP model features</strong></p>
<ul>
<li>Yard line</li>
<li>Whether possession team is at home</li>
<li>Roof type: retractable, dome, or outdoors</li>
<li>Down</li>
<li>Yards to go</li>
<li>Distance to sticks (air yards - yards to go)</li>
<li>Era: 2006-2013, 2014-2017, 2018 and beyond (note that air yards data only go back to 2006, so there is no CP for earlier years)</li>
<li>Week (the model is trained on regular season only, so for playoff games, we impute week = 17)</li>
<li>Air yards</li>
<li>Whether air yards is 0 (probably unnecessary with tree-based method and a relic from earlier models where it was included because completion percentage is much lower for 0 air yard passes)</li>
<li>Pass location (binary: middle or not middle)</li>
<li>Whether quarterback was hit on the play</li>
</ul>
</div>
<div id="ep-model-calibration-results" class="section level2">
<h2 class="hasAnchor">
<a href="#ep-model-calibration-results" class="anchor"></a>EP Model Calibration Results</h2>
<p>The goal of this section is to show that the nflfastR EP model is well calibrated. To measure calibration, we follow Yurko et al. and perform leave-one-season-out (LOSO) calibration. In particular, for each of the 20 available seasons (2000-2019), we exclude one season, train the EP model on the other 19 seasons, and then compare the model’s predictions in the holdout season to what actually happened in that season. If the model is well calibrated, we would expect that, for example, 50 percent of plays with a touchdown probability of 50 percent prior to the play would have the next score be a touchdown for the possession team.</p>
<p>Let’s start with some setup. The file used here isn’t pushed because it’s large, but its creation can <a href="https://github.com/guga31bb/nflfastR-data/blob/master/models/model_data.R">be seen here</a> and the <a href="https://github.com/guga31bb/nflfastR-data/tree/master/models">file can be accessed here</a>.</p>
<div class="sourceCode" id="cb1"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span>(<span class="fl">2013</span>) <span class="co">#GoHawks</span>
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="kw"><a href="http://tidyverse.tidyverse.org">tidyverse</a></span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="kw"><a href="https://github.com/dmlc/xgboost">xgboost</a></span>)

<span class="co">#some helper files are in these</span>
<span class="fu"><a href="https://rdrr.io/r/base/source.html">source</a></span>(<span class="st">'https://raw.githubusercontent.com/mrcaseb/nflfastR/master/R/helper_add_nflscrapr_mutations.R'</span>)
<span class="fu"><a href="https://rdrr.io/r/base/source.html">source</a></span>(<span class="st">'https://raw.githubusercontent.com/mrcaseb/nflfastR/master/R/helper_add_ep_wp.R'</span>)
<span class="fu"><a href="https://rdrr.io/r/base/source.html">source</a></span>(<span class="st">'https://raw.githubusercontent.com/mrcaseb/nflfastR/master/R/helper_add_cp_cpoe.R'</span>)

<span class="kw">pbp_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/connections.html">url</a></span>(<span class="st">'https://github.com/guga31bb/nflfastR-data/blob/master/models/cal_data.rds?raw=true'</span>))
<span class="kw">model_data</span> <span class="op">&lt;-</span> <span class="kw">pbp_data</span> <span class="op">%&gt;%</span>
  <span class="co">#in 'R/helper_add_nflscrapr_mutations.R'</span>
  <span class="fu">make_model_mutations</span>() <span class="op">%&gt;%</span>
  <span class="fu">mutate</span>(
    label = <span class="fu">case_when</span>(
      <span class="kw">Next_Score_Half</span> <span class="op">==</span> <span class="st">"Touchdown"</span> <span class="op">~</span> <span class="fl">0</span>,
      <span class="kw">Next_Score_Half</span> <span class="op">==</span> <span class="st">"Opp_Touchdown"</span> <span class="op">~</span> <span class="fl">1</span>,
      <span class="kw">Next_Score_Half</span> <span class="op">==</span> <span class="st">"Field_Goal"</span> <span class="op">~</span> <span class="fl">2</span>,
      <span class="kw">Next_Score_Half</span> <span class="op">==</span> <span class="st">"Opp_Field_Goal"</span> <span class="op">~</span> <span class="fl">3</span>,
      <span class="kw">Next_Score_Half</span> <span class="op">==</span> <span class="st">"Safety"</span> <span class="op">~</span> <span class="fl">4</span>,
      <span class="kw">Next_Score_Half</span> <span class="op">==</span> <span class="st">"Opp_Safety"</span> <span class="op">~</span> <span class="fl">5</span>,
      <span class="kw">Next_Score_Half</span> <span class="op">==</span> <span class="st">"No_Score"</span> <span class="op">~</span> <span class="fl">6</span>
    ),
    label = <span class="fu"><a href="https://rdrr.io/r/base/factor.html">as.factor</a></span>(<span class="kw">label</span>),
    <span class="co">#use nflscrapR weights</span>
    Drive_Score_Dist = <span class="kw">Drive_Score_Half</span> <span class="op">-</span> <span class="kw">drive</span>,
    Drive_Score_Dist_W = (<span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span>(<span class="kw">Drive_Score_Dist</span>) <span class="op">-</span> <span class="kw">Drive_Score_Dist</span>) <span class="op">/</span>
      (<span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span>(<span class="kw">Drive_Score_Dist</span>) <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span>(<span class="kw">Drive_Score_Dist</span>)),
    ScoreDiff_W = (<span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span>(<span class="kw">score_differential</span>), na.rm=<span class="kw">T</span>) <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span>(<span class="kw">score_differential</span>)) <span class="op">/</span>
      (<span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span>(<span class="kw">score_differential</span>), na.rm=<span class="kw">T</span>) <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span>(<span class="kw">score_differential</span>), na.rm=<span class="kw">T</span>)),
    Total_W = <span class="kw">Drive_Score_Dist_W</span> <span class="op">+</span> <span class="kw">ScoreDiff_W</span>,
    Total_W_Scaled = (<span class="kw">Total_W</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span>(<span class="kw">Total_W</span>, na.rm=<span class="kw">T</span>)) <span class="op">/</span>
      (<span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span>(<span class="kw">Total_W</span>, na.rm=<span class="kw">T</span>) <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span>(<span class="kw">Total_W</span>, na.rm=<span class="kw">T</span>))
  ) <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(
    <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span>(<span class="kw">defteam_timeouts_remaining</span>), <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span>(<span class="kw">posteam_timeouts_remaining</span>),
    <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span>(<span class="kw">yardline_100</span>)
  ) <span class="op">%&gt;%</span>
  <span class="fu">select</span>(
    <span class="kw">label</span>,
    <span class="kw">season</span>,
    <span class="kw">half_seconds_remaining</span>,
    <span class="kw">yardline_100</span>,
    <span class="kw">home</span>,
    <span class="kw">retractable</span>,
    <span class="kw">dome</span>,
    <span class="kw">outdoors</span>,
    <span class="kw">ydstogo</span>,
    <span class="kw">era0</span>, <span class="kw">era1</span>, <span class="kw">era2</span>, <span class="kw">era3</span>, <span class="kw">era4</span>,
    <span class="kw">down1</span>, <span class="kw">down2</span>, <span class="kw">down3</span>, <span class="kw">down4</span>,
    <span class="kw">posteam_timeouts_remaining</span>,
    <span class="kw">defteam_timeouts_remaining</span>,
    <span class="kw">model_week</span>,
    <span class="kw">Total_W_Scaled</span>
  )

<span class="co">#idk why this is all necessary for xgb but it is</span>
<span class="kw">model_data</span> <span class="op">&lt;-</span> <span class="kw">model_data</span> <span class="op">%&gt;%</span>
  <span class="fu">mutate</span>(label = <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span>(<span class="kw">label</span>),
         label = <span class="kw">label</span> <span class="op">-</span> <span class="fl">1</span>)

<span class="fu"><a href="https://rdrr.io/r/base/rm.html">rm</a></span>(<span class="kw">pbp_data</span>)

<span class="kw">seasons</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span>(<span class="kw">model_data</span><span class="op">$</span><span class="kw">season</span>)
</pre></div>
<p>Input the stuff we’ll need to fit the model. The parameters were obtained from cross-validation, where each season was forced to be entirely contained in a given CV fold to prevent leakage in labels from one fold to another (for example, if a given drive were split up between folds).</p>
<div class="sourceCode" id="cb2"><pre class="downlit">
<span class="kw">nrounds</span> <span class="op">=</span> <span class="fl">70</span>
<span class="kw">params</span> <span class="op">&lt;-</span>
  <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(
    booster = <span class="st">"gbtree"</span>,
    objective = <span class="st">"multi:softprob"</span>,
    eval_metric = <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"mlogloss"</span>),
    num_class = <span class="fl">7</span>,
    eta = <span class="fl">0.2</span>,
    gamma = <span class="fl">.2</span>,
    subsample=<span class="fl">0.8</span>,
    colsample_bytree=<span class="fl">0.8</span>,
    max_depth = <span class="fl">4</span>,
    min_child_weight = <span class="fl">.9</span>
  )
</pre></div>
<p>Now do the LOSO model fitting.</p>
<div class="sourceCode" id="cb3"><pre class="downlit">
<span class="kw">cv_results</span> <span class="op">&lt;-</span> <span class="fu">map_dfr</span>(<span class="kw">seasons</span>, <span class="fu">function</span>(<span class="kw">x</span>) {

  <span class="kw">test_data</span> <span class="op">&lt;-</span> <span class="kw">model_data</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(<span class="kw">season</span> <span class="op">==</span> <span class="kw">x</span>) <span class="op">%&gt;%</span>
    <span class="fu">select</span>(<span class="op">-</span><span class="kw">season</span>)
  <span class="kw">train_data</span> <span class="op">&lt;-</span> <span class="kw">model_data</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(<span class="kw">season</span> != <span class="kw">x</span>) <span class="op">%&gt;%</span>
    <span class="fu">select</span>(<span class="op">-</span><span class="kw">season</span>)

  <span class="kw">full_train</span> <span class="op">=</span> <span class="kw">xgboost</span>::<span class="fu"><a href="https://rdrr.io/pkg/xgboost/man/xgb.DMatrix.html">xgb.DMatrix</a></span>(<span class="fu"><a href="https://rdrr.io/r/stats/model.matrix.html">model.matrix</a></span>(<span class="op">~</span><span class="kw">.</span><span class="op">+</span><span class="fl">0</span>, data = <span class="kw">train_data</span> <span class="op">%&gt;%</span> <span class="fu">select</span>(<span class="op">-</span><span class="kw">label</span>, <span class="op">-</span><span class="kw">Total_W_Scaled</span>)),
                                    label = <span class="kw">train_data</span><span class="op">$</span><span class="kw">label</span>, weight = <span class="kw">train_data</span><span class="op">$</span><span class="kw">Total_W_Scaled</span>)
  <span class="kw">ep_model</span> <span class="op">&lt;-</span> <span class="kw">xgboost</span>::<span class="fu"><a href="https://rdrr.io/pkg/xgboost/man/xgb.train.html">xgboost</a></span>(params = <span class="kw">params</span>, data = <span class="kw">full_train</span>, nrounds = <span class="kw">nrounds</span>, verbose = <span class="fl">2</span>)

  <span class="kw">preds</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span>(
    <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span>(<span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span>(<span class="kw">ep_model</span>, <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">as.matrix</a></span>(<span class="kw">test_data</span> <span class="op">%&gt;%</span> <span class="fu">select</span>(<span class="op">-</span><span class="kw">label</span>, <span class="op">-</span><span class="kw">Total_W_Scaled</span>))), ncol=<span class="fl">7</span>, byrow=<span class="fl">TRUE</span>)
  )
  <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span>(<span class="kw">preds</span>) <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"Touchdown"</span>,<span class="st">"Opp_Touchdown"</span>,<span class="st">"Field_Goal"</span>,<span class="st">"Opp_Field_Goal"</span>,
                       <span class="st">"Safety"</span>,<span class="st">"Opp_Safety"</span>,<span class="st">"No_Score"</span>)

  <span class="kw">cv_data</span> <span class="op">&lt;-</span> <span class="fu">bind_cols</span>(<span class="kw">test_data</span>, <span class="kw">preds</span>) <span class="op">%&gt;%</span> <span class="fu">mutate</span>(season = <span class="kw">x</span>)
  <span class="fu"><a href="https://rdrr.io/r/base/function.html">return</a></span>(<span class="kw">cv_data</span>)

})

<span class="co">#get the BINS for the calibration plot</span>
<span class="kw">plot</span> <span class="op">&lt;-</span> <span class="kw">cv_results</span> <span class="op">%&gt;%</span>
  <span class="fu">select</span>(<span class="kw">Touchdown</span>, <span class="kw">Opp_Touchdown</span>, <span class="kw">Field_Goal</span>, <span class="kw">Opp_Field_Goal</span>, <span class="kw">Safety</span>, <span class="kw">Opp_Safety</span>, <span class="kw">No_Score</span>, <span class="kw">label</span>) <span class="op">%&gt;%</span>
  <span class="fu">pivot_longer</span>(<span class="op">-</span><span class="kw">label</span>, names_to = <span class="st">'type'</span>, values_to = <span class="st">'pred_prob'</span>) <span class="op">%&gt;%</span>
  <span class="fu">mutate</span>(bin_pred_prob = <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span>(<span class="kw">pred_prob</span> <span class="op">/</span> <span class="fl">0.05</span>) <span class="op">*</span> <span class="fl">.05</span>) <span class="op">%&gt;%</span>
  <span class="fu">mutate</span>(outcome = <span class="fu">case_when</span>(
    <span class="kw">label</span> <span class="op">==</span> <span class="fl">0</span> <span class="op">~</span> <span class="st">"Touchdown"</span>,
    <span class="kw">label</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">~</span> <span class="st">"Opp_Touchdown"</span>,
    <span class="kw">label</span> <span class="op">==</span> <span class="fl">2</span> <span class="op">~</span> <span class="st">"Field_Goal"</span>,
    <span class="kw">label</span> <span class="op">==</span> <span class="fl">3</span> <span class="op">~</span> <span class="st">"Opp_Field_Goal"</span>,
    <span class="kw">label</span> <span class="op">==</span> <span class="fl">4</span> <span class="op">~</span> <span class="st">"Safety"</span>,
    <span class="kw">label</span> <span class="op">==</span> <span class="fl">5</span> <span class="op">~</span> <span class="st">"Opp_Safety"</span>,
    <span class="kw">label</span> <span class="op">==</span> <span class="fl">6</span> <span class="op">~</span> <span class="st">"No_Score"</span>
  )) <span class="op">%&gt;%</span>
  <span class="fu">group_by</span>(<span class="kw">type</span>, <span class="kw">bin_pred_prob</span>) <span class="op">%&gt;%</span>
  <span class="fu">mutate</span>(correct = <span class="fu">if_else</span>(<span class="kw">outcome</span> <span class="op">==</span> <span class="kw">type</span>, <span class="fl">1</span>, <span class="fl">0</span>)) <span class="op">%&gt;%</span>
  <span class="fu">summarize</span>(n_plays = <span class="fu">n</span>(),
            n_outcome = <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(<span class="kw">correct</span>),
            bin_actual_prob = <span class="kw">n_outcome</span> <span class="op">/</span> <span class="kw">n_plays</span>)
<span class="co">#&gt; `summarise()` regrouping output by 'type' (override with `.groups` argument)</span>
</pre></div>
<p>Here is the EP calibration plot. Points close to the diagonal dotted line are consistent with a well-calibrated model:</p>
<div class="sourceCode" id="cb4"><pre class="downlit">
<span class="kw">ann_text</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(x = <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">.25</span>, <span class="fl">0.75</span>), y = <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">0.75</span>, <span class="fl">0.25</span>),
                       lab = <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"More times\nthan expected"</span>, <span class="st">"Fewer times\nthan expected"</span>),
                       next_score_type = <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span>(<span class="st">"No Score (0)"</span>))
<span class="kw">plot</span> <span class="op">%&gt;%</span>
  <span class="co">#about .75M plays in total</span>
  <span class="co">#filter(n_plays &gt;= 50) %&gt;%</span>
    <span class="fu">ungroup</span>() <span class="op">%&gt;%</span>
  <span class="fu">mutate</span>(type = <span class="fu">fct_relevel</span>(<span class="kw">type</span>,
                                       <span class="st">"Opp_Safety"</span>, <span class="st">"Opp_Field_Goal"</span>,
                                       <span class="st">"Opp_Touchdown"</span>, <span class="st">"No_Score"</span>, <span class="st">"Safety"</span>,
                                       <span class="st">"Field_Goal"</span>, <span class="st">"Touchdown"</span>
  ),
  type = <span class="fu">fct_recode</span>(<span class="kw">type</span>,
                               <span class="st">"-Field Goal (-3)"</span> = <span class="st">"Opp_Field_Goal"</span>,
                               <span class="st">"-Safety (-2)"</span> = <span class="st">"Opp_Safety"</span>,
                               <span class="st">"-Touchdown (-7)"</span> = <span class="st">"Opp_Touchdown"</span>,
                               <span class="st">"Field Goal (3)"</span> = <span class="st">"Field_Goal"</span>,
                               <span class="st">"No Score (0)"</span> = <span class="st">"No_Score"</span>,
                               <span class="st">"Touchdown (7)"</span> = <span class="st">"Touchdown"</span>,
                               <span class="st">"Safety (2)"</span> = <span class="st">"Safety"</span>)) <span class="op">%&gt;%</span>
  <span class="fu">ggplot</span>() <span class="op">+</span>
  <span class="fu">geom_point</span>(<span class="fu">aes</span>(x = <span class="kw">bin_pred_prob</span>, y = <span class="kw">bin_actual_prob</span>, size = <span class="kw">n_plays</span>)) <span class="op">+</span>
  <span class="fu">geom_smooth</span>(<span class="fu">aes</span>(x = <span class="kw">bin_pred_prob</span>, y = <span class="kw">bin_actual_prob</span>), method = <span class="st">"loess"</span>) <span class="op">+</span>
  <span class="fu">geom_abline</span>(slope = <span class="fl">1</span>, intercept = <span class="fl">0</span>, color = <span class="st">"black"</span>, lty = <span class="fl">2</span>) <span class="op">+</span>
  <span class="fu">coord_equal</span>() <span class="op">+</span>   
  <span class="fu">scale_x_continuous</span>(limits = <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">0</span>,<span class="fl">1</span>)) <span class="op">+</span>
  <span class="fu">scale_y_continuous</span>(limits = <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">0</span>,<span class="fl">1</span>)) <span class="op">+</span>
  <span class="fu">labs</span>(size = <span class="st">"Number of plays"</span>,
       x = <span class="st">"Estimated next score probability"</span>,
       y = <span class="st">"Observed next score probability"</span>) <span class="op">+</span>
  <span class="fu">geom_text</span>(data = <span class="kw">ann_text</span>, <span class="fu">aes</span>(x = <span class="kw">x</span>, y = <span class="kw">y</span>, label = <span class="kw">lab</span>), size = <span class="fl">2</span>) <span class="op">+</span>
  <span class="fu">theme_bw</span>() <span class="op">+</span>
  <span class="fu">theme</span>(plot.title = <span class="fu">element_text</span>(hjust = <span class="fl">0.5</span>),
        strip.background = <span class="fu">element_blank</span>(),
        strip.text = <span class="fu">element_text</span>(size = <span class="fl">12</span>),
        axis.title = <span class="fu">element_text</span>(size = <span class="fl">12</span>),
        axis.text.y = <span class="fu">element_text</span>(size = <span class="fl">12</span>),
        axis.text.x = <span class="fu">element_text</span>(size = <span class="fl">10</span>, angle = <span class="fl">90</span>),
        legend.title = <span class="fu">element_text</span>(size = <span class="fl">12</span>),
        legend.text = <span class="fu">element_text</span>(size = <span class="fl">12</span>),
        legend.position = <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">1</span>, <span class="fl">.05</span>), legend.justification = <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">1</span>, <span class="fl">0</span>)) <span class="op">+</span>
  <span class="fu">facet_wrap</span>(<span class="op">~</span> <span class="kw">type</span>, ncol = <span class="fl">4</span>)
</pre></div>
<p><img src="nflfastR-models_files/figure-html/plot-1.png" width="5104.16666666667"></p>
<p>There is some weirdness with the opponent safety predictions, but these dots represent an <em>extremely</em> small number of plays (10-50 plays out of about 750,000).</p>
<p>Now let’s get the calibration error using the measure developed in Yurko et al., and compare it to nflscrapR. First we need to get the nflscrapR predictions, which we have saved from the previous version of nflfastR which applied the nflscrapR models.</p>
<div class="sourceCode" id="cb5"><pre class="downlit">
<span class="co">#calibration error</span>
<span class="kw">cv_cal_error</span> <span class="op">&lt;-</span> <span class="kw">plot</span> <span class="op">%&gt;%</span>
  <span class="fu">ungroup</span>() <span class="op">%&gt;%</span>
  <span class="fu">mutate</span>(cal_diff = <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span>(<span class="kw">bin_pred_prob</span> <span class="op">-</span> <span class="kw">bin_actual_prob</span>)) <span class="op">%&gt;%</span>
  <span class="fu">group_by</span>(<span class="kw">type</span>) <span class="op">%&gt;%</span>
  <span class="fu">summarize</span>(weight_cal_error = <span class="fu"><a href="https://rdrr.io/r/stats/weighted.mean.html">weighted.mean</a></span>(<span class="kw">cal_diff</span>, <span class="kw">n_plays</span>, na.rm = <span class="fl">TRUE</span>),
            n_scoring_event = <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(<span class="kw">n_outcome</span>, na.rm = <span class="fl">TRUE</span>))
<span class="co">#&gt; `summarise()` ungrouping output (override with `.groups` argument)</span>

<span class="kw">pbp_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/connections.html">url</a></span>(<span class="st">'https://github.com/guga31bb/nflfastR-data/blob/master/models/cal_data_nflscrapr.rds?raw=true'</span>))
<span class="co">#nflscrapr calibration error</span>
<span class="kw">nflscrapr</span> <span class="op">&lt;-</span> <span class="kw">pbp_data</span> <span class="op">%&gt;%</span>
  <span class="fu">select</span>(<span class="kw">td_prob</span>, <span class="kw">opp_td_prob</span>, <span class="kw">fg_prob</span>, <span class="kw">opp_fg_prob</span>, <span class="kw">safety_prob</span>, <span class="kw">opp_safety_prob</span>, <span class="kw">no_score_prob</span>, <span class="kw">Next_Score_Half</span>) <span class="op">%&gt;%</span>
  <span class="fu">pivot_longer</span>(<span class="op">-</span><span class="kw">Next_Score_Half</span>, names_to = <span class="st">'type'</span>, values_to = <span class="st">'pred_prob'</span>) <span class="op">%&gt;%</span>
  <span class="fu">mutate</span>(bin_pred_prob = <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span>(<span class="kw">pred_prob</span> <span class="op">/</span> <span class="fl">0.05</span>) <span class="op">*</span> <span class="fl">.05</span>) <span class="op">%&gt;%</span>
  <span class="fu">mutate</span>(outcome = <span class="kw">Next_Score_Half</span>,
         type = <span class="fu">case_when</span>(
           <span class="kw">type</span> <span class="op">==</span> <span class="st">"td_prob"</span> <span class="op">~</span> <span class="st">'Touchdown'</span>,
           <span class="kw">type</span> <span class="op">==</span> <span class="st">'fg_prob'</span> <span class="op">~</span> <span class="st">"Field_Goal"</span>,
           <span class="kw">type</span> <span class="op">==</span> <span class="st">"opp_td_prob"</span> <span class="op">~</span> <span class="st">"Opp_Touchdown"</span>,
           <span class="kw">type</span> <span class="op">==</span> <span class="st">'opp_fg_prob'</span> <span class="op">~</span> <span class="st">"Opp_Field_Goal"</span>,
           <span class="kw">type</span> <span class="op">==</span> <span class="st">'safety_prob'</span> <span class="op">~</span> <span class="st">"Safety"</span>,
           <span class="kw">type</span> <span class="op">==</span> <span class="st">'opp_safety_prob'</span> <span class="op">~</span> <span class="st">"Opp_Safety"</span>,
           <span class="kw">type</span> <span class="op">==</span> <span class="st">"no_score_prob"</span> <span class="op">~</span> <span class="st">"No_Score"</span>
         )) <span class="op">%&gt;%</span>
  <span class="fu">group_by</span>(<span class="kw">type</span>, <span class="kw">bin_pred_prob</span>) <span class="op">%&gt;%</span>
  <span class="fu">mutate</span>(correct = <span class="fu">if_else</span>(<span class="kw">outcome</span> <span class="op">==</span> <span class="kw">type</span>, <span class="fl">1</span>, <span class="fl">0</span>)) <span class="op">%&gt;%</span>
  <span class="fu">summarize</span>(n_plays = <span class="fu">n</span>(),
            n_outcome = <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(<span class="kw">correct</span>),
            bin_actual_prob = <span class="kw">n_outcome</span> <span class="op">/</span> <span class="kw">n_plays</span>) <span class="op">%&gt;%</span>
  <span class="fu">ungroup</span>() <span class="op">%&gt;%</span>
  <span class="fu">mutate</span>(cal_diff = <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span>(<span class="kw">bin_pred_prob</span> <span class="op">-</span> <span class="kw">bin_actual_prob</span>)) <span class="op">%&gt;%</span>
  <span class="fu">group_by</span>(<span class="kw">type</span>) <span class="op">%&gt;%</span>
  <span class="fu">summarize</span>(weight_cal_error = <span class="fu"><a href="https://rdrr.io/r/stats/weighted.mean.html">weighted.mean</a></span>(<span class="kw">cal_diff</span>, <span class="kw">n_plays</span>, na.rm = <span class="fl">TRUE</span>),
            n_scoring_event = <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(<span class="kw">n_outcome</span>, na.rm = <span class="fl">TRUE</span>))
<span class="co">#&gt; `summarise()` regrouping output by 'type' (override with `.groups` argument)</span>
<span class="co">#&gt; `summarise()` ungrouping output (override with `.groups` argument)</span>
<span class="fu"><a href="https://rdrr.io/r/base/rm.html">rm</a></span>(<span class="kw">pbp_data</span>)

<span class="fu"><a href="https://rdrr.io/r/base/message.html">message</a></span>(<span class="kw">glue</span>::<span class="fu"><a href="https://glue.tidyverse.org/reference/glue.html">glue</a></span>(
<span class="st">'
--CALIBRATION ERROR--

nflfastR:
{round(with(cv_cal_error, weighted.mean(weight_cal_error, n_scoring_event)), 4)}

nflscrapR:
{round(with(nflscrapr, weighted.mean(weight_cal_error, n_scoring_event)), 4)}
'</span>
--CALIBRATION ERROR--

nflfastR:
{round(with(cv_cal_error, weighted.mean(weight_cal_error, n_scoring_event)), 4)}

nflscrapR:
{round(with(nflscrapr, weighted.mean(weight_cal_error, n_scoring_event)), 4)}
'
))
<span class="co">#&gt; --CALIBRATION ERROR--</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; nflfastR:</span>
<span class="co">#&gt; 0.0064</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; nflscrapR:</span>
<span class="co">#&gt; 0.017</span>
</pre></div>
<p>We see that the new EP model is better calibrated. Note that nflscrapR reports a calibration error of 0.01309723. The number is higher here because of the additional seasons included outside of the time period nflscrapR was trained on, and the lack of era adjustment in nflscrapR.</p>
</div>
<div id="wp-model-calibration-results" class="section level2">
<h2 class="hasAnchor">
<a href="#wp-model-calibration-results" class="anchor"></a>WP Model Calibration Results</h2>
<p>As with EP, do some initial setup to get the data ready for fitting.</p>
<div class="sourceCode" id="cb6"><pre class="downlit">
<span class="kw">model_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/connections.html">url</a></span>(<span class="st">'https://github.com/guga31bb/nflfastR-data/blob/master/models/cal_data.rds?raw=true'</span>))
<span class="kw">model_data</span> <span class="op">&lt;-</span> <span class="kw">model_data</span> <span class="op">%&gt;%</span>
  <span class="fu">make_model_mutations</span>() <span class="op">%&gt;%</span>
  <span class="fu">prepare_wp_data</span>() <span class="op">%&gt;%</span>
  <span class="fu">mutate</span>(label = <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span>(<span class="kw">posteam</span> <span class="op">==</span> <span class="kw">Winner</span>, <span class="fl">1</span>, <span class="fl">0</span>)) <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(<span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span>(<span class="kw">ep</span>) <span class="op">&amp;</span> <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span>(<span class="kw">score_differential</span>) <span class="op">&amp;</span> <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span>(<span class="kw">play_type</span>) <span class="op">&amp;</span> <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span>(<span class="kw">label</span>)) <span class="op">%&gt;%</span>
  <span class="fu">select</span>(
    <span class="kw">label</span>,
    <span class="kw">receive_2h_ko</span>,
    <span class="kw">spread_time</span>,
    <span class="kw">half_seconds_remaining</span>,
    <span class="kw">game_seconds_remaining</span>,
    <span class="kw">ExpScoreDiff_Time_Ratio</span>,
    <span class="kw">score_differential</span>,
    <span class="kw">ep</span>,
    <span class="kw">down</span>,
    <span class="kw">ydstogo</span>,
    <span class="kw">home</span>,
    <span class="kw">posteam_timeouts_remaining</span>,
    <span class="kw">defteam_timeouts_remaining</span>,
    <span class="kw">season</span>,
    <span class="co">#only needed for the plots here, not used in model</span>
    <span class="kw">qtr</span>
  ) <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(<span class="kw">qtr</span> <span class="op">&lt;=</span> <span class="fl">4</span>)

<span class="kw">nrounds</span> <span class="op">=</span> <span class="fl">65</span>
<span class="kw">params</span> <span class="op">&lt;-</span>
  <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(
    booster = <span class="st">"gbtree"</span>,
    objective = <span class="st">"binary:logistic"</span>,
    eval_metric = <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"logloss"</span>),
    eta = <span class="fl">0.2</span>,
    gamma = <span class="fl">0</span>,
    subsample=<span class="fl">0.8</span>,
    colsample_bytree=<span class="fl">0.8</span>,
    max_depth = <span class="fl">4</span>,
    min_child_weight = <span class="fl">1</span>
  )
</pre></div>
<p>Do the LOSO fitting:</p>
<div class="sourceCode" id="cb7"><pre class="downlit">
<span class="kw">cv_results</span> <span class="op">&lt;-</span> <span class="fu">map_dfr</span>(<span class="kw">seasons</span>, <span class="fu">function</span>(<span class="kw">x</span>) {

  <span class="kw">test_data</span> <span class="op">&lt;-</span> <span class="kw">model_data</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(<span class="kw">season</span> <span class="op">==</span> <span class="kw">x</span>) <span class="op">%&gt;%</span>
    <span class="fu">select</span>(<span class="op">-</span><span class="kw">season</span>)
  <span class="kw">train_data</span> <span class="op">&lt;-</span> <span class="kw">model_data</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(<span class="kw">season</span> != <span class="kw">x</span>) <span class="op">%&gt;%</span>
    <span class="fu">select</span>(<span class="op">-</span><span class="kw">season</span>)

  <span class="kw">full_train</span> <span class="op">=</span> <span class="kw">xgboost</span>::<span class="fu"><a href="https://rdrr.io/pkg/xgboost/man/xgb.DMatrix.html">xgb.DMatrix</a></span>(<span class="fu"><a href="https://rdrr.io/r/stats/model.matrix.html">model.matrix</a></span>(<span class="op">~</span><span class="kw">.</span><span class="op">+</span><span class="fl">0</span>, data = <span class="kw">train_data</span> <span class="op">%&gt;%</span> <span class="fu">select</span>(<span class="op">-</span><span class="kw">label</span>, <span class="op">-</span><span class="kw">qtr</span>, <span class="op">-</span><span class="kw">spread_time</span>)),
                                    label = <span class="kw">train_data</span><span class="op">$</span><span class="kw">label</span>)
  <span class="kw">wp_model</span> <span class="op">&lt;-</span> <span class="kw">xgboost</span>::<span class="fu"><a href="https://rdrr.io/pkg/xgboost/man/xgb.train.html">xgboost</a></span>(params = <span class="kw">params</span>, data = <span class="kw">full_train</span>, nrounds = <span class="kw">nrounds</span>, verbose = <span class="fl">2</span>)

  <span class="kw">preds</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span>(
    <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span>(<span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span>(<span class="kw">wp_model</span>, <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">as.matrix</a></span>(<span class="kw">test_data</span> <span class="op">%&gt;%</span> <span class="fu">select</span>(<span class="op">-</span><span class="kw">label</span>, <span class="op">-</span><span class="kw">qtr</span>, <span class="op">-</span><span class="kw">spread_time</span>))))
  ) <span class="op">%&gt;%</span>
    <span class="kw">dplyr</span>::<span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span>(wp = <span class="kw">V1</span>)

  <span class="kw">cv_data</span> <span class="op">&lt;-</span> <span class="fu">bind_cols</span>(<span class="kw">test_data</span>, <span class="kw">preds</span>) <span class="op">%&gt;%</span> <span class="fu">mutate</span>(season = <span class="kw">x</span>)
  <span class="fu"><a href="https://rdrr.io/r/base/function.html">return</a></span>(<span class="kw">cv_data</span>)

})

<span class="co">#TIME FOR BINNING</span>
<span class="kw">wp_cv_loso_calibration_results</span> <span class="op">&lt;-</span> <span class="kw">cv_results</span> <span class="op">%&gt;%</span>
  <span class="co"># Create BINS for wp:</span>
  <span class="fu">mutate</span>(bin_pred_prob = <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span>(<span class="kw">wp</span> <span class="op">/</span> <span class="fl">0.05</span>) <span class="op">*</span> <span class="fl">.05</span>) <span class="op">%&gt;%</span>
  <span class="co"># Group by both the qtr and bin_pred_prob:</span>
  <span class="fu">group_by</span>(<span class="kw">qtr</span>, <span class="kw">bin_pred_prob</span>) <span class="op">%&gt;%</span>
  <span class="co"># Calculate the calibration results:</span>
  <span class="fu">summarize</span>(n_plays = <span class="fu">n</span>(),
            n_wins = <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span>(<span class="kw">label</span> <span class="op">==</span> <span class="fl">1</span>)),
            bin_actual_prob = <span class="kw">n_wins</span> <span class="op">/</span> <span class="kw">n_plays</span>)
<span class="co">#&gt; `summarise()` regrouping output by 'qtr' (override with `.groups` argument)</span>
</pre></div>
<p>The WP plot. Looks good!</p>
<div class="sourceCode" id="cb8"><pre class="downlit">
<span class="co"># Create a label data frame for the chart:</span>
<span class="kw">ann_text</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(x = <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">.25</span>, <span class="fl">0.75</span>), y = <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">0.75</span>, <span class="fl">0.25</span>),
                       lab = <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"More times\nthan expected"</span>, <span class="st">"Fewer times\nthan expected"</span>),
                       qtr = <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span>(<span class="st">"1st Quarter"</span>))

<span class="co"># Create the calibration chart:</span>
<span class="kw">wp_cv_loso_calibration_results</span> <span class="op">%&gt;%</span>
  <span class="fu">ungroup</span>() <span class="op">%&gt;%</span>
  <span class="fu">mutate</span>(qtr = <span class="fu">fct_recode</span>(<span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span>(<span class="kw">qtr</span>), <span class="st">"1st Quarter"</span> = <span class="st">"1"</span>, <span class="st">"2nd Quarter"</span> = <span class="st">"2"</span>,
                          <span class="st">"3rd Quarter"</span> = <span class="st">"3"</span>, <span class="st">"4th Quarter"</span> = <span class="st">"4"</span>)) <span class="op">%&gt;%</span>
  <span class="fu">ggplot</span>() <span class="op">+</span>
  <span class="fu">geom_point</span>(<span class="fu">aes</span>(x = <span class="kw">bin_pred_prob</span>, y = <span class="kw">bin_actual_prob</span>, size = <span class="kw">n_plays</span>)) <span class="op">+</span>
  <span class="fu">geom_smooth</span>(<span class="fu">aes</span>(x = <span class="kw">bin_pred_prob</span>, y = <span class="kw">bin_actual_prob</span>), method = <span class="st">"loess"</span>) <span class="op">+</span>
  <span class="fu">geom_abline</span>(slope = <span class="fl">1</span>, intercept = <span class="fl">0</span>, color = <span class="st">"black"</span>, lty = <span class="fl">2</span>) <span class="op">+</span>
  <span class="fu">coord_equal</span>() <span class="op">+</span> 
  <span class="fu">scale_x_continuous</span>(limits = <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">0</span>,<span class="fl">1</span>)) <span class="op">+</span>
  <span class="fu">scale_y_continuous</span>(limits = <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">0</span>,<span class="fl">1</span>)) <span class="op">+</span>
  <span class="fu">labs</span>(size = <span class="st">"Number of plays"</span>,
       x = <span class="st">"Estimated win probability"</span>,
       y = <span class="st">"Observed win probability"</span>) <span class="op">+</span>
  <span class="fu">geom_text</span>(data = <span class="kw">ann_text</span>, <span class="fu">aes</span>(x = <span class="kw">x</span>, y = <span class="kw">y</span>, label = <span class="kw">lab</span>), size = <span class="fl">2</span>) <span class="op">+</span>
  <span class="fu">theme_bw</span>() <span class="op">+</span>
  <span class="fu">theme</span>(plot.title = <span class="fu">element_text</span>(hjust = <span class="fl">0.5</span>),
        strip.background = <span class="fu">element_blank</span>(),
        strip.text = <span class="fu">element_text</span>(size = <span class="fl">12</span>),
        axis.title = <span class="fu">element_text</span>(size = <span class="fl">12</span>),
        axis.text.y = <span class="fu">element_text</span>(size = <span class="fl">12</span>),
        axis.text.x = <span class="fu">element_text</span>(size = <span class="fl">10</span>, angle = <span class="fl">90</span>),
        legend.title = <span class="fu">element_text</span>(size = <span class="fl">12</span>),
        legend.text = <span class="fu">element_text</span>(size = <span class="fl">12</span>),
        legend.position = <span class="st">"bottom"</span>) <span class="op">+</span>
  <span class="fu">facet_wrap</span>(<span class="op">~</span> <span class="kw">qtr</span>, ncol = <span class="fl">4</span>)
</pre></div>
<p><img src="nflfastR-models_files/figure-html/plot_wp-1.png" width="5104.16666666667"></p>
<p>And get the WP calibration error:</p>
<div class="sourceCode" id="cb9"><pre class="downlit">
<span class="co"># Calculate the calibration error values:</span>
<span class="kw">wp_cv_cal_error</span> <span class="op">&lt;-</span> <span class="kw">wp_cv_loso_calibration_results</span> <span class="op">%&gt;%</span>
  <span class="fu">ungroup</span>() <span class="op">%&gt;%</span>
  <span class="fu">mutate</span>(cal_diff = <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span>(<span class="kw">bin_pred_prob</span> <span class="op">-</span> <span class="kw">bin_actual_prob</span>)) <span class="op">%&gt;%</span>
  <span class="fu">group_by</span>(<span class="kw">qtr</span>) <span class="op">%&gt;%</span>
  <span class="fu">summarize</span>(weight_cal_error = <span class="fu"><a href="https://rdrr.io/r/stats/weighted.mean.html">weighted.mean</a></span>(<span class="kw">cal_diff</span>, <span class="kw">n_plays</span>, na.rm = <span class="fl">TRUE</span>),
            n_wins = <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(<span class="kw">n_wins</span>, na.rm = <span class="fl">TRUE</span>))
<span class="co">#&gt; `summarise()` ungrouping output (override with `.groups` argument)</span>

<span class="co">#get nflscrapR to compare</span>
<span class="kw">pbp_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/connections.html">url</a></span>(<span class="st">'https://github.com/guga31bb/nflfastR-data/blob/master/models/cal_data_nflscrapr.rds?raw=true'</span>)) <span class="op">%&gt;%</span>
  <span class="fu">mutate</span>(label = <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span>(<span class="kw">posteam</span> <span class="op">==</span> <span class="kw">Winner</span>, <span class="fl">1</span>, <span class="fl">0</span>)) <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(<span class="kw">qtr</span> <span class="op">&lt;=</span> <span class="fl">4</span>, <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span>(<span class="kw">label</span>), <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span>(<span class="kw">posteam</span>), <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span>(<span class="kw">wp</span>))

<span class="kw">nflscrapR</span> <span class="op">&lt;-</span> <span class="kw">pbp_data</span> <span class="op">%&gt;%</span>
  <span class="co"># Create binned probability column:</span>
  <span class="fu">mutate</span>(bin_pred_prob = <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span>(<span class="kw">wp</span> <span class="op">/</span> <span class="fl">0.05</span>) <span class="op">*</span> <span class="fl">.05</span>) <span class="op">%&gt;%</span>
  <span class="co"># Group by both the qtr and bin_pred_prob:</span>
  <span class="fu">group_by</span>(<span class="kw">qtr</span>, <span class="kw">bin_pred_prob</span>) <span class="op">%&gt;%</span>
  <span class="co"># Calculate the calibration results:</span>
  <span class="fu">summarize</span>(n_plays = <span class="fu">n</span>(),
            n_wins = <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span>(<span class="kw">label</span> <span class="op">==</span> <span class="fl">1</span>)),
            bin_actual_prob = <span class="kw">n_wins</span> <span class="op">/</span> <span class="kw">n_plays</span>) <span class="op">%&gt;%</span>
  <span class="fu">ungroup</span>() <span class="op">%&gt;%</span>
  <span class="fu">mutate</span>(cal_diff = <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span>(<span class="kw">bin_pred_prob</span> <span class="op">-</span> <span class="kw">bin_actual_prob</span>)) <span class="op">%&gt;%</span>
  <span class="fu">group_by</span>(<span class="kw">qtr</span>) <span class="op">%&gt;%</span>
  <span class="fu">summarize</span>(weight_cal_error = <span class="fu"><a href="https://rdrr.io/r/stats/weighted.mean.html">weighted.mean</a></span>(<span class="kw">cal_diff</span>, <span class="kw">n_plays</span>, na.rm = <span class="fl">TRUE</span>),
            n_wins = <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(<span class="kw">n_wins</span>, na.rm = <span class="fl">TRUE</span>))
<span class="co">#&gt; `summarise()` regrouping output by 'qtr' (override with `.groups` argument)</span>
<span class="co">#&gt; `summarise()` ungrouping output (override with `.groups` argument)</span>

<span class="fu"><a href="https://rdrr.io/r/base/message.html">message</a></span>(<span class="kw">glue</span>::<span class="fu"><a href="https://glue.tidyverse.org/reference/glue.html">glue</a></span>(
  <span class="st">'--CALIBRATION ERROR--

nflfastR:
{round(with(wp_cv_cal_error, weighted.mean(weight_cal_error, n_wins)), 4)}

nflscrapR:
{round(with(nflscrapR, weighted.mean(weight_cal_error, n_wins)), 4)}'</span>

nflfastR:
{round(with(wp_cv_cal_error, weighted.mean(weight_cal_error, n_wins)), 4)}

nflscrapR:
{round(with(nflscrapR, weighted.mean(weight_cal_error, n_wins)), 4)}'
))
<span class="co">#&gt; --CALIBRATION ERROR--</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; nflfastR:</span>
<span class="co">#&gt; 0.0062</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; nflscrapR:</span>
<span class="co">#&gt; 0.0397</span>
</pre></div>
<p>Again, the new WP model represents an improvement.</p>
</div>
<div id="wp-model-calibration-results-with-point-spread" class="section level2">
<h2 class="hasAnchor">
<a href="#wp-model-calibration-results-with-point-spread" class="anchor"></a>WP Model Calibration Results: with point spread</h2>
<p><code>nflfastR</code> has a secondary win probability model that also incorporates the pregame spread to more accurately reflect a team’s chances of winning. Below are calibration results for this model.</p>
<div class="sourceCode" id="cb10"><pre class="downlit">
<span class="kw">nrounds</span> <span class="op">=</span> <span class="fl">170</span>
<span class="kw">params</span> <span class="op">&lt;-</span>
  <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(
    booster = <span class="st">"gbtree"</span>,
    objective = <span class="st">"binary:logistic"</span>,
    eval_metric = <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"logloss"</span>),
    eta = <span class="fl">0.075</span>,
    gamma = <span class="fl">3</span>,
    subsample=<span class="fl">0.8</span>,
    colsample_bytree=<span class="fl">0.8</span>,
    max_depth = <span class="fl">5</span>,
    min_child_weight = <span class="fl">.9</span>
  )
</pre></div>
<p>Do the LOSO fitting:</p>
<div class="sourceCode" id="cb11"><pre class="downlit">
<span class="kw">cv_results</span> <span class="op">&lt;-</span> <span class="fu">map_dfr</span>(<span class="kw">seasons</span>, <span class="fu">function</span>(<span class="kw">x</span>) {

  <span class="kw">test_data</span> <span class="op">&lt;-</span> <span class="kw">model_data</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(<span class="kw">season</span> <span class="op">==</span> <span class="kw">x</span>) <span class="op">%&gt;%</span>
    <span class="fu">select</span>(<span class="op">-</span><span class="kw">season</span>)
  <span class="kw">train_data</span> <span class="op">&lt;-</span> <span class="kw">model_data</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(<span class="kw">season</span> != <span class="kw">x</span>) <span class="op">%&gt;%</span>
    <span class="fu">select</span>(<span class="op">-</span><span class="kw">season</span>)

  <span class="kw">full_train</span> <span class="op">=</span> <span class="kw">xgboost</span>::<span class="fu"><a href="https://rdrr.io/pkg/xgboost/man/xgb.DMatrix.html">xgb.DMatrix</a></span>(<span class="fu"><a href="https://rdrr.io/r/stats/model.matrix.html">model.matrix</a></span>(<span class="op">~</span><span class="kw">.</span><span class="op">+</span><span class="fl">0</span>, data = <span class="kw">train_data</span> <span class="op">%&gt;%</span> <span class="fu">select</span>(<span class="op">-</span><span class="kw">label</span>, <span class="op">-</span><span class="kw">qtr</span>)),
                                    label = <span class="kw">train_data</span><span class="op">$</span><span class="kw">label</span>)
  <span class="kw">wp_model</span> <span class="op">&lt;-</span> <span class="kw">xgboost</span>::<span class="fu"><a href="https://rdrr.io/pkg/xgboost/man/xgb.train.html">xgboost</a></span>(params = <span class="kw">params</span>, data = <span class="kw">full_train</span>, nrounds = <span class="kw">nrounds</span>, verbose = <span class="fl">2</span>)

  <span class="kw">preds</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span>(
    <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span>(<span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span>(<span class="kw">wp_model</span>, <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">as.matrix</a></span>(<span class="kw">test_data</span> <span class="op">%&gt;%</span> <span class="fu">select</span>(<span class="op">-</span><span class="kw">label</span>, <span class="op">-</span><span class="kw">qtr</span>))))
  ) <span class="op">%&gt;%</span>
    <span class="kw">dplyr</span>::<span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span>(wp = <span class="kw">V1</span>)

  <span class="kw">cv_data</span> <span class="op">&lt;-</span> <span class="fu">bind_cols</span>(<span class="kw">test_data</span>, <span class="kw">preds</span>) <span class="op">%&gt;%</span> <span class="fu">mutate</span>(season = <span class="kw">x</span>)
  <span class="fu"><a href="https://rdrr.io/r/base/function.html">return</a></span>(<span class="kw">cv_data</span>)

})

<span class="co">#TIME FOR BINNING</span>
<span class="kw">wp_cv_loso_calibration_results</span> <span class="op">&lt;-</span> <span class="kw">cv_results</span> <span class="op">%&gt;%</span>
  <span class="co"># Create BINS for wp:</span>
  <span class="fu">mutate</span>(bin_pred_prob = <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span>(<span class="kw">wp</span> <span class="op">/</span> <span class="fl">0.05</span>) <span class="op">*</span> <span class="fl">.05</span>) <span class="op">%&gt;%</span>
  <span class="co"># Group by both the qtr and bin_pred_prob:</span>
  <span class="fu">group_by</span>(<span class="kw">qtr</span>, <span class="kw">bin_pred_prob</span>) <span class="op">%&gt;%</span>
  <span class="co"># Calculate the calibration results:</span>
  <span class="fu">summarize</span>(n_plays = <span class="fu">n</span>(),
            n_wins = <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span>(<span class="kw">label</span> <span class="op">==</span> <span class="fl">1</span>)),
            bin_actual_prob = <span class="kw">n_wins</span> <span class="op">/</span> <span class="kw">n_plays</span>)
<span class="co">#&gt; `summarise()` regrouping output by 'qtr' (override with `.groups` argument)</span>
</pre></div>
<p>The WP plot.</p>
<div class="sourceCode" id="cb12"><pre class="downlit">
<span class="co"># Create a label data frame for the chart:</span>
<span class="kw">ann_text</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(x = <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">.25</span>, <span class="fl">0.75</span>), y = <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">0.75</span>, <span class="fl">0.25</span>),
                       lab = <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"More times\nthan expected"</span>, <span class="st">"Fewer times\nthan expected"</span>),
                       qtr = <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span>(<span class="st">"1st Quarter"</span>))

<span class="co"># Create the calibration chart:</span>
<span class="kw">wp_cv_loso_calibration_results</span> <span class="op">%&gt;%</span>
  <span class="fu">ungroup</span>() <span class="op">%&gt;%</span>
  <span class="fu">mutate</span>(qtr = <span class="fu">fct_recode</span>(<span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span>(<span class="kw">qtr</span>), <span class="st">"1st Quarter"</span> = <span class="st">"1"</span>, <span class="st">"2nd Quarter"</span> = <span class="st">"2"</span>,
                          <span class="st">"3rd Quarter"</span> = <span class="st">"3"</span>, <span class="st">"4th Quarter"</span> = <span class="st">"4"</span>)) <span class="op">%&gt;%</span>
  <span class="fu">ggplot</span>() <span class="op">+</span>
  <span class="fu">geom_point</span>(<span class="fu">aes</span>(x = <span class="kw">bin_pred_prob</span>, y = <span class="kw">bin_actual_prob</span>, size = <span class="kw">n_plays</span>)) <span class="op">+</span>
  <span class="fu">geom_smooth</span>(<span class="fu">aes</span>(x = <span class="kw">bin_pred_prob</span>, y = <span class="kw">bin_actual_prob</span>), method = <span class="st">"loess"</span>) <span class="op">+</span>
  <span class="fu">geom_abline</span>(slope = <span class="fl">1</span>, intercept = <span class="fl">0</span>, color = <span class="st">"black"</span>, lty = <span class="fl">2</span>) <span class="op">+</span>
  <span class="fu">coord_equal</span>() <span class="op">+</span> 
  <span class="fu">scale_x_continuous</span>(limits = <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">0</span>,<span class="fl">1</span>)) <span class="op">+</span>
  <span class="fu">scale_y_continuous</span>(limits = <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">0</span>,<span class="fl">1</span>)) <span class="op">+</span>
  <span class="fu">labs</span>(size = <span class="st">"Number of plays"</span>,
       x = <span class="st">"Estimated win probability"</span>,
       y = <span class="st">"Observed win probability"</span>) <span class="op">+</span>
  <span class="fu">geom_text</span>(data = <span class="kw">ann_text</span>, <span class="fu">aes</span>(x = <span class="kw">x</span>, y = <span class="kw">y</span>, label = <span class="kw">lab</span>), size = <span class="fl">2</span>) <span class="op">+</span>
  <span class="fu">theme_bw</span>() <span class="op">+</span>
  <span class="fu">theme</span>(plot.title = <span class="fu">element_text</span>(hjust = <span class="fl">0.5</span>),
        strip.background = <span class="fu">element_blank</span>(),
        strip.text = <span class="fu">element_text</span>(size = <span class="fl">12</span>),
        axis.title = <span class="fu">element_text</span>(size = <span class="fl">12</span>),
        axis.text.y = <span class="fu">element_text</span>(size = <span class="fl">12</span>),
        axis.text.x = <span class="fu">element_text</span>(size = <span class="fl">10</span>, angle = <span class="fl">90</span>),
        legend.title = <span class="fu">element_text</span>(size = <span class="fl">12</span>),
        legend.text = <span class="fu">element_text</span>(size = <span class="fl">12</span>),
        legend.position = <span class="st">"bottom"</span>) <span class="op">+</span>
  <span class="fu">facet_wrap</span>(<span class="op">~</span> <span class="kw">qtr</span>, ncol = <span class="fl">4</span>)
</pre></div>
<p><img src="nflfastR-models_files/figure-html/plot_wp_spread-1.png" width="5104.16666666667"></p>
<p>And get the WP calibration error:</p>
<div class="sourceCode" id="cb13"><pre class="downlit">
<span class="co"># Calculate the calibration error values:</span>
<span class="kw">wp_cv_cal_error</span> <span class="op">&lt;-</span> <span class="kw">wp_cv_loso_calibration_results</span> <span class="op">%&gt;%</span>
  <span class="fu">ungroup</span>() <span class="op">%&gt;%</span>
  <span class="fu">mutate</span>(cal_diff = <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span>(<span class="kw">bin_pred_prob</span> <span class="op">-</span> <span class="kw">bin_actual_prob</span>)) <span class="op">%&gt;%</span>
  <span class="fu">group_by</span>(<span class="kw">qtr</span>) <span class="op">%&gt;%</span>
  <span class="fu">summarize</span>(weight_cal_error = <span class="fu"><a href="https://rdrr.io/r/stats/weighted.mean.html">weighted.mean</a></span>(<span class="kw">cal_diff</span>, <span class="kw">n_plays</span>, na.rm = <span class="fl">TRUE</span>),
            n_wins = <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(<span class="kw">n_wins</span>, na.rm = <span class="fl">TRUE</span>))
<span class="co">#&gt; `summarise()` ungrouping output (override with `.groups` argument)</span>
<span class="fu"><a href="https://rdrr.io/r/base/message.html">message</a></span>(<span class="kw">glue</span>::<span class="fu"><a href="https://glue.tidyverse.org/reference/glue.html">glue</a></span>(
  <span class="st">'--CALIBRATION ERROR--

nflfastR with Vegas line:
{round(with(wp_cv_cal_error, weighted.mean(weight_cal_error, n_wins)), 4)}

nflscrapR:
{round(with(nflscrapR, weighted.mean(weight_cal_error, n_wins)), 4)}'</span>

nflfastR with Vegas line:
{round(with(wp_cv_cal_error, weighted.mean(weight_cal_error, n_wins)), 4)}

nflscrapR:
{round(with(nflscrapR, weighted.mean(weight_cal_error, n_wins)), 4)}'
))
<span class="co">#&gt; --CALIBRATION ERROR--</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; nflfastR with Vegas line:</span>
<span class="co">#&gt; 0.0063</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; nflscrapR:</span>
<span class="co">#&gt; 0.0397</span>
</pre></div>
<p>Again, the new WP model is better calibrated than nflscrapR. In our testing, incorporating the spread substantially improved the performance of the model as measured by cross-validation classification accuracy (reduced error rate from 27% to 23%) and log loss (reduced from .52 to .45). We include a time-decaying function of spread on its own as including spread on its own increases the LOSO calibration error, especially in the fourth quarter. We also tried removing the <code>home</code> indicator in the spread model, but this worsened the calibration results.</p>
</div>
<div id="cp-model-calibration-results" class="section level2">
<h2 class="hasAnchor">
<a href="#cp-model-calibration-results" class="anchor"></a>CP Model Calibration Results</h2>
<p>By now, the process should be familiar.</p>
<div class="sourceCode" id="cb14"><pre class="downlit">
<span class="kw">pbp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/connections.html">url</a></span>(<span class="st">'https://github.com/guga31bb/nflfastR-data/blob/master/models/cal_data.rds?raw=true'</span>))

<span class="kw">model_data</span> <span class="op">&lt;-</span> <span class="kw">pbp</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(<span class="kw">season</span> <span class="op">&gt;=</span> <span class="fl">2006</span>) <span class="op">%&gt;%</span>
  <span class="fu">make_model_mutations</span>() <span class="op">%&gt;%</span>
  <span class="kw">dplyr</span>::<span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(receiver_player_name =
                  <span class="kw">stringr</span>::<span class="fu"><a href="https://stringr.tidyverse.org/reference/str_extract.html">str_extract</a></span>(<span class="kw">desc</span>, <span class="st">"(?&lt;=((to)|(for))\\s[:digit:]{0,2}\\-{0,1})[A-Z][A-z]*\\.\\s?[A-Z][A-z]+(\\s(I{2,3})|(IV))?"</span>),
                pass_middle = <span class="kw">dplyr</span>::<span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html">if_else</a></span>(<span class="kw">pass_location</span> <span class="op">==</span> <span class="st">'middle'</span>, <span class="fl">1</span>, <span class="fl">0</span>),
                air_is_zero= <span class="kw">dplyr</span>::<span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html">if_else</a></span>(<span class="kw">air_yards</span> <span class="op">==</span> <span class="fl">0</span>,<span class="fl">1</span>,<span class="fl">0</span>),
                distance_to_sticks = <span class="kw">air_yards</span> <span class="op">-</span> <span class="kw">ydstogo</span>
  ) <span class="op">%&gt;%</span>
  <span class="kw">dplyr</span>::<span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(<span class="kw">complete_pass</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">|</span> <span class="kw">incomplete_pass</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">|</span> <span class="kw">interception</span> <span class="op">==</span> <span class="fl">1</span>) <span class="op">%&gt;%</span>
  <span class="kw">dplyr</span>::<span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(<span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span>(<span class="kw">air_yards</span>) <span class="op">&amp;</span> <span class="kw">air_yards</span> <span class="op">&gt;=</span> <span class="op">-</span><span class="fl">15</span> <span class="op">&amp;</span> <span class="kw">air_yards</span> <span class="op">&lt;</span><span class="fl">70</span> <span class="op">&amp;</span> <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span>(<span class="kw">receiver_player_name</span>) <span class="op">&amp;</span> <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span>(<span class="kw">pass_location</span>)) <span class="op">%&gt;%</span>
  <span class="kw">dplyr</span>::<span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span>(
    <span class="kw">season</span>, <span class="kw">complete_pass</span>, <span class="kw">air_yards</span>, <span class="kw">yardline_100</span>, <span class="kw">ydstogo</span>,
    <span class="kw">down1</span>, <span class="kw">down2</span>, <span class="kw">down3</span>, <span class="kw">down4</span>, <span class="kw">air_is_zero</span>, <span class="kw">pass_middle</span>,
    <span class="kw">era2</span>, <span class="kw">era3</span>, <span class="kw">era4</span>, <span class="kw">qb_hit</span>, <span class="kw">home</span>, <span class="kw">model_week</span>,
    <span class="kw">outdoors</span>, <span class="kw">retractable</span>, <span class="kw">dome</span>, <span class="kw">distance_to_sticks</span>
  )
<span class="fu"><a href="https://rdrr.io/r/base/rm.html">rm</a></span>(<span class="kw">pbp</span>)


<span class="kw">nrounds</span> <span class="op">=</span> <span class="fl">70</span>
<span class="kw">params</span> <span class="op">&lt;-</span>
  <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(
    booster = <span class="st">"gbtree"</span>,
    objective = <span class="st">"binary:logistic"</span>,
    eval_metric = <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"logloss"</span>),
    eta = <span class="fl">0.2</span>,
    gamma = <span class="fl">5</span>,
    subsample=<span class="fl">0.8</span>,
    colsample_bytree=<span class="fl">0.8</span>,
    max_depth = <span class="fl">4</span>,
    min_child_weight = <span class="fl">6</span>,
    base_score = <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span>(<span class="kw">model_data</span><span class="op">$</span><span class="kw">complete_pass</span>)
  )

<span class="kw">cv_results</span> <span class="op">&lt;-</span> <span class="fu">map_dfr</span>(<span class="fl">2006</span><span class="op">:</span><span class="fl">2019</span>, <span class="fu">function</span>(<span class="kw">x</span>) {

  <span class="kw">test_data</span> <span class="op">&lt;-</span> <span class="kw">model_data</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(<span class="kw">season</span> <span class="op">==</span> <span class="kw">x</span>) <span class="op">%&gt;%</span>
    <span class="fu">select</span>(<span class="op">-</span><span class="kw">season</span>)
  <span class="kw">train_data</span> <span class="op">&lt;-</span> <span class="kw">model_data</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(<span class="kw">season</span> != <span class="kw">x</span>) <span class="op">%&gt;%</span>
    <span class="fu">select</span>(<span class="op">-</span><span class="kw">season</span>)

  <span class="kw">full_train</span> <span class="op">=</span> <span class="kw">xgboost</span>::<span class="fu"><a href="https://rdrr.io/pkg/xgboost/man/xgb.DMatrix.html">xgb.DMatrix</a></span>(<span class="fu"><a href="https://rdrr.io/r/stats/model.matrix.html">model.matrix</a></span>(<span class="op">~</span><span class="kw">.</span><span class="op">+</span><span class="fl">0</span>, data = <span class="kw">train_data</span> <span class="op">%&gt;%</span> <span class="fu">select</span>(<span class="op">-</span><span class="kw">complete_pass</span>)),
                                    label = <span class="kw">train_data</span><span class="op">$</span><span class="kw">complete_pass</span>)
  <span class="kw">cp_model</span> <span class="op">&lt;-</span> <span class="kw">xgboost</span>::<span class="fu"><a href="https://rdrr.io/pkg/xgboost/man/xgb.train.html">xgboost</a></span>(params = <span class="kw">params</span>, data = <span class="kw">full_train</span>, nrounds = <span class="kw">nrounds</span>, verbose = <span class="fl">2</span>)

  <span class="kw">preds</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span>(
    <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span>(<span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span>(<span class="kw">cp_model</span>, <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">as.matrix</a></span>(<span class="kw">test_data</span> <span class="op">%&gt;%</span> <span class="fu">select</span>(<span class="op">-</span><span class="kw">complete_pass</span>))))
  ) <span class="op">%&gt;%</span>
    <span class="kw">dplyr</span>::<span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span>(cp = <span class="kw">V1</span>)

  <span class="kw">cv_data</span> <span class="op">&lt;-</span> <span class="fu">bind_cols</span>(<span class="kw">test_data</span>, <span class="kw">preds</span>) <span class="op">%&gt;%</span> <span class="fu">mutate</span>(season = <span class="kw">x</span>)
  <span class="fu"><a href="https://rdrr.io/r/base/function.html">return</a></span>(<span class="kw">cv_data</span>)

})

<span class="co">#TIME FOR BINNING</span>
<span class="kw">cp_cv_loso_calibration_results</span> <span class="op">&lt;-</span> <span class="kw">cv_results</span> <span class="op">%&gt;%</span>
  <span class="co"># Create BINS for wp:</span>
  <span class="fu">mutate</span>(
    bin_pred_prob = <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span>(<span class="kw">cp</span> <span class="op">/</span> <span class="fl">0.05</span>) <span class="op">*</span> <span class="fl">.05</span>,
    distance = <span class="fu">case_when</span>(
      <span class="kw">air_yards</span> <span class="op">&lt;</span> <span class="fl">5</span> <span class="op">~</span> <span class="st">"Short"</span>,
      <span class="kw">air_yards</span> <span class="op">&gt;=</span> <span class="fl">5</span> <span class="op">&amp;</span> <span class="kw">air_yards</span> <span class="op">&lt;</span> <span class="fl">15</span> <span class="op">~</span> <span class="st">"Intermediate"</span>,
      <span class="kw">air_yards</span> <span class="op">&gt;=</span> <span class="fl">15</span> <span class="op">~</span> <span class="st">"Deep"</span>
    )
    ) <span class="op">%&gt;%</span>
  <span class="co"># Group by both the qtr and bin_pred_prob:</span>
  <span class="fu">group_by</span>(<span class="kw">distance</span>, <span class="kw">bin_pred_prob</span>) <span class="op">%&gt;%</span>
  <span class="co"># Calculate the calibration results:</span>
  <span class="fu">summarize</span>(n_plays = <span class="fu">n</span>(),
            n_complete = <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span>(<span class="kw">complete_pass</span> <span class="op">==</span> <span class="fl">1</span>)),
            bin_actual_prob = <span class="kw">n_complete</span> <span class="op">/</span> <span class="kw">n_plays</span>)
<span class="co">#&gt; `summarise()` regrouping output by 'distance' (override with `.groups` argument)</span>

<span class="kw">ann_text</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(x = <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">.25</span>, <span class="fl">0.75</span>), y = <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">0.75</span>, <span class="fl">0.25</span>),
                       lab = <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"More times\nthan expected"</span>, <span class="st">"Fewer times\nthan expected"</span>)
                       )
</pre></div>
<p>Plot the results:</p>
<div class="sourceCode" id="cb15"><pre class="downlit">
<span class="kw">cp_cv_loso_calibration_results</span> <span class="op">%&gt;%</span>
  <span class="fu">ungroup</span>() <span class="op">%&gt;%</span>
  <span class="fu">mutate</span>(distance = <span class="fu">fct_relevel</span>(<span class="kw">distance</span>,
                            <span class="st">"Short"</span>, <span class="st">"Intermediate"</span>, <span class="st">"Deep"</span>)
  ) <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(<span class="kw">n_plays</span> <span class="op">&gt;</span> <span class="fl">10</span>) <span class="op">%&gt;%</span>
  <span class="fu">ggplot</span>() <span class="op">+</span>
  <span class="fu">geom_point</span>(<span class="fu">aes</span>(x = <span class="kw">bin_pred_prob</span>, y = <span class="kw">bin_actual_prob</span>, size = <span class="kw">n_plays</span>)) <span class="op">+</span>
  <span class="fu">geom_smooth</span>(<span class="fu">aes</span>(x = <span class="kw">bin_pred_prob</span>, y = <span class="kw">bin_actual_prob</span>), method = <span class="st">"loess"</span>) <span class="op">+</span>
  <span class="fu">geom_abline</span>(slope = <span class="fl">1</span>, intercept = <span class="fl">0</span>, color = <span class="st">"black"</span>, lty = <span class="fl">2</span>) <span class="op">+</span>
  <span class="fu">coord_equal</span>() <span class="op">+</span> 
  <span class="fu">scale_x_continuous</span>(limits = <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">0</span>,<span class="fl">1</span>)) <span class="op">+</span>
  <span class="fu">scale_y_continuous</span>(limits = <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">0</span>,<span class="fl">1</span>)) <span class="op">+</span>
  <span class="fu">labs</span>(size = <span class="st">"Number of plays"</span>,
       x = <span class="st">"Estimated completion percentage"</span>,
       y = <span class="st">"Observed completion percentage"</span>) <span class="op">+</span>
  <span class="fu">geom_text</span>(data = <span class="kw">ann_text</span>, <span class="fu">aes</span>(x = <span class="kw">x</span>, y = <span class="kw">y</span>, label = <span class="kw">lab</span>), size = <span class="fl">3</span>) <span class="op">+</span>
  <span class="fu">theme_bw</span>() <span class="op">+</span>
  <span class="fu">theme</span>(plot.title = <span class="fu">element_text</span>(hjust = <span class="fl">0.5</span>),
        strip.background = <span class="fu">element_blank</span>(),
        strip.text = <span class="fu">element_text</span>(size = <span class="fl">12</span>),
        axis.title = <span class="fu">element_text</span>(size = <span class="fl">12</span>),
        axis.text.y = <span class="fu">element_text</span>(size = <span class="fl">12</span>),
        axis.text.x = <span class="fu">element_text</span>(size = <span class="fl">10</span>, angle = <span class="fl">90</span>),
        legend.title = <span class="fu">element_text</span>(size = <span class="fl">12</span>),
        legend.text = <span class="fu">element_text</span>(size = <span class="fl">12</span>),
        legend.position = <span class="st">"bottom"</span>) <span class="op">+</span>
  <span class="fu">facet_wrap</span>(<span class="op">~</span> <span class="kw">distance</span>, ncol = <span class="fl">3</span>)
</pre></div>
<p><img src="nflfastR-models_files/figure-html/plot_cp-1.png" width="5104.16666666667"></p>
<p>And get the calibration error:</p>
<div class="sourceCode" id="cb16"><pre class="downlit">
<span class="kw">cp_cv_cal_error</span> <span class="op">&lt;-</span> <span class="kw">cp_cv_loso_calibration_results</span> <span class="op">%&gt;%</span>
  <span class="fu">ungroup</span>() <span class="op">%&gt;%</span>
  <span class="fu">mutate</span>(cal_diff = <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span>(<span class="kw">bin_pred_prob</span> <span class="op">-</span> <span class="kw">bin_actual_prob</span>)) <span class="op">%&gt;%</span>
  <span class="fu">group_by</span>(<span class="kw">distance</span>) <span class="op">%&gt;%</span>
  <span class="fu">summarize</span>(weight_cal_error = <span class="fu"><a href="https://rdrr.io/r/stats/weighted.mean.html">weighted.mean</a></span>(<span class="kw">cal_diff</span>, <span class="kw">n_plays</span>, na.rm = <span class="fl">TRUE</span>),
            n_complete = <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(<span class="kw">n_complete</span>, na.rm = <span class="fl">TRUE</span>))
<span class="co">#&gt; `summarise()` ungrouping output (override with `.groups` argument)</span>

<span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/with.html">with</a></span>(<span class="kw">cp_cv_cal_error</span>, <span class="fu"><a href="https://rdrr.io/r/stats/weighted.mean.html">weighted.mean</a></span>(<span class="kw">weight_cal_error</span>, <span class="kw">n_complete</span>)), <span class="fl">4</span>)
<span class="co">#&gt; [1] 0.0049</span>
</pre></div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by <a href="https://twitter.com/mrcaseb">Sebastian Carl</a>, <a href="https://twitter.com/benbbaldwin">Ben Baldwin</a>.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.5.1.9000.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
